# Python Linting and Testing Configuration
#
# BUSINESS CONTEXT:
# Enforces code quality standards across all Python microservices in the Course Creator Platform.
# Ensures consistent formatting, import organization, and test coverage reporting.
#
# TECHNICAL RATIONALE:
# - Flake8: Enforces PEP 8 compliance with custom exceptions for Black compatibility
# - MyPy: Provides static type checking to catch type errors early
# - Coverage: Tracks test coverage across all services with detailed reporting
# - isort: Ensures consistent import organization
# - pytest: Configures test discovery and execution
#
# CONFIGURATION STANDARDS:
# - Max line length: 120 (standard for modern Python projects)
# - Python version: 3.11 (production version)
# - Excludes: Virtual environments, migrations, build artifacts

[flake8]
# Line length must match Black's default (120)
max-line-length = 120

# Directories to exclude from linting
exclude =
    .git,
    __pycache__,
    .venv,
    venv,
    env,
    dist,
    build,
    *.egg-info,
    migrations,
    .backups,
    htmlcov,
    .pytest_cache,
    .mypy_cache,
    node_modules

# Ignore specific rules to maintain Black compatibility
# E203: Whitespace before ':' (conflicts with Black)
# W503: Line break before binary operator (conflicts with Black)
# E501: Line too long (handled by Black)
ignore = E203, W503, E501

# Per-file ignores
# F401: Module imported but unused (common in __init__.py)
# F403: 'from module import *' used (acceptable in __init__.py)
per-file-ignores =
    __init__.py:F401,F403
    */migrations/*.py:E501,F401

# McCabe complexity threshold
# Functions with complexity > 10 should be refactored
max-complexity = 15

# Minimum Python version
min-python-version = 3.11

# Show source code for each error
show-source = True

# Show flake8 statistics at end of run
statistics = True

# Count errors and warnings
count = True


[mypy]
# Python version for type checking
python_version = 3.11

# Warnings and error reporting
warn_return_any = True
warn_unused_configs = True
warn_redundant_casts = True
warn_unused_ignores = True
warn_no_return = True
warn_unreachable = True

# Type checking behavior
disallow_untyped_defs = False  # Gradually enable strict typing
disallow_any_generics = False  # Allow flexibility with generics
check_untyped_defs = True
no_implicit_optional = True

# Import discovery
namespace_packages = True
ignore_missing_imports = True

# Exclude patterns (relative to project root)
exclude = migrations/|tests/|__pycache__/|\.venv/|venv/|env/|build/|dist/|\.backups/

# Show error codes in output
show_error_codes = True

# Pretty output
pretty = True


[coverage:run]
# Source directories to measure coverage
source =
    services

# Omit specific files/directories from coverage
omit =
    */tests/*
    */test_*.py
    *_test.py
    */migrations/*
    */__pycache__/*
    */venv/*
    */.venv/*
    */env/*
    */site-packages/*
    */conftest.py
    */setup.py
    */.backups/*

# Branch coverage (measures both True and False branches)
branch = True

# Parallel mode for concurrent test execution
parallel = True

# Store coverage data in this file
data_file = .coverage


[coverage:report]
# Report precision (2 decimal places)
precision = 2

# Show lines that weren't executed
show_missing = True

# Include all files, even if fully covered
skip_covered = False

# Skip empty files
skip_empty = True

# Fail if coverage is below this percentage
fail_under = 70

# Sort by coverage percentage
sort = Cover

# Report format
exclude_lines =
    # Standard pragma to exclude lines
    pragma: no cover

    # Don't complain about defensive assertions
    raise AssertionError
    raise NotImplementedError

    # Don't complain about abstract methods
    @abstractmethod
    @abc.abstractmethod

    # Don't complain if tests don't hit defensive code
    if __name__ == .__main__.:
    if TYPE_CHECKING:

    # Don't complain about debug code
    def __repr__
    def __str__


[coverage:html]
# HTML coverage report directory
directory = htmlcov

# Title for HTML report
title = Course Creator Platform - Test Coverage Report


[coverage:xml]
# XML coverage report output file
output = coverage.xml


[coverage:json]
# JSON coverage report output file
output = coverage.json
# Pretty print JSON
pretty_print = True
# Include coverage data per line
show_contexts = True


[isort]
# Use Black-compatible profile
profile = black

# Line length must match Black and Flake8
line_length = 120

# Multi-line import style (vertical hanging indent)
multi_line_output = 3

# Include trailing comma in multi-line imports
include_trailing_comma = True

# Force grid wrapping at this number of imports
force_grid_wrap = 0

# Use parentheses for line continuation
use_parentheses = True

# Ensure newline before comments
ensure_newline_before_comments = True

# Sort imports within sections
force_sort_within_sections = True

# Separate imports into sections
sections = FUTURE,STDLIB,THIRDPARTY,FIRSTPARTY,LOCALFOLDER

# Known first-party packages (adjust based on your services)
known_first_party =
    analytics,
    content_management,
    content_storage,
    course_generator,
    course_management,
    demo_service,
    knowledge_graph_service,
    metadata_service,
    nlp_preprocessing,
    organization_management,
    user_management,
    local_llm_service

# Skip specific files
skip =
    .venv,
    venv,
    env,
    migrations,
    __pycache__,
    .backups

# Skip glob patterns
skip_glob =
    */migrations/*,
    */__pycache__/*,
    .backups/*


[tool:pytest]
# Test discovery patterns
testpaths = tests
python_files = test_*.py *_test.py
python_classes = Test* *Tests *TestCase
python_functions = test_*

# Pytest command-line options
addopts =
    # Verbose output
    -v

    # Show all output from tests (including print statements)
    -s

    # Strict marker mode (all markers must be registered)
    --strict-markers

    # Enable coverage
    --cov=services

    # Coverage reports
    --cov-report=term-missing:skip-covered
    --cov-report=html
    --cov-report=xml
    --cov-report=json

    # Show summary of failed tests
    --tb=short

    # Show durations of slowest tests
    --durations=10

    # Warnings
    -W default

    # Color output
    --color=yes

# Test markers for categorization
markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    fast: marks tests as fast
    integration: marks tests as integration tests (require external services)
    e2e: marks tests as end-to-end tests (require full application)
    unit: marks tests as unit tests (isolated, fast)
    smoke: marks tests as smoke tests (basic functionality)
    security: marks tests as security tests
    performance: marks tests as performance tests
    regression: marks tests as regression tests
    accessibility: marks tests as accessibility tests
    selenium: marks tests using Selenium WebDriver
    playwright: marks tests using Playwright
    database: marks tests requiring database access
    redis: marks tests requiring Redis access
    docker: marks tests requiring Docker
    requires_auth: marks tests requiring authentication

# Minimum Python version
minversion = 7.4

# Asyncio mode (for async tests)
asyncio_mode = auto

# Console output style
console_output_style = progress

# Log configuration
log_cli = False
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = tests/reports/pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] [%(filename)s:%(lineno)d] %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# Timeout for tests (in seconds)
timeout = 300
timeout_method = thread

# Parallel execution settings
# Use -n auto for automatic CPU detection
# Use -n <number> for specific number of workers


[bandit]
# Security testing configuration
exclude = /tests/,/migrations/,/.venv/,/venv/,/env/,/.backups/
skips = B101,B601
