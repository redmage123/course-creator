<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie Consent Manager - Course Creator Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .info-box {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .info-box h2 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .info-box p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .consent-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }

        .consent-card.required {
            border-left-color: #e74c3c;
        }

        .consent-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .consent-card .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.required {
            background: #ffe5e5;
            color: #e74c3c;
        }

        .badge.optional {
            background: #e3f2fd;
            color: #2196f3;
        }

        .consent-card p {
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #27ae60;
        }

        input:disabled + .slider {
            background-color: #e74c3c;
            cursor: not-allowed;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-accept-all {
            background-color: #27ae60;
            color: white;
            flex: 1;
        }

        .btn-accept-all:hover {
            background-color: #229954;
        }

        .btn-reject-all {
            background-color: #e74c3c;
            color: white;
            flex: 1;
        }

        .btn-reject-all:hover {
            background-color: #c0392b;
        }

        .btn-save {
            background-color: #3498db;
            color: white;
            flex: 1;
        }

        .btn-save:hover {
            background-color: #2980b9;
        }

        .status-message {
            display: none;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-weight: 500;
        }

        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .links {
            margin-top: 30px;
            text-align: center;
        }

        .links a {
            color: #3498db;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
        }

        .links a:hover {
            text-decoration: underline;
        }

        .current-settings {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .current-settings h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .current-settings p {
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }

        .session-info {
            background: #fff3cd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .session-info strong {
            color: #856404;
        }

        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }

            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üç™ Cookie Consent Preferences</h1>

        <div class="session-info">
            <strong>Session ID:</strong> <span id="session-id">Loading...</span>
        </div>

        <div class="current-settings" id="current-settings" style="display: none;">
            <h3>üìä Current Consent Status</h3>
            <p id="current-status"></p>
        </div>

        <div class="info-box">
            <h2>Privacy & Cookie Policy</h2>
            <p>
                We use cookies to provide personalized demo experiences, analyze platform usage,
                and improve our services. Your privacy is important to us, and we comply with
                GDPR (EU), CCPA (California), and PIPEDA (Canada) regulations.
            </p>
            <p>
                <strong>Data Retention:</strong> Guest session data is stored for maximum 30 days
                and automatically deleted thereafter. You can request immediate deletion at any time
                via your Right to Erasure.
            </p>
        </div>

        <!-- Strictly Necessary Cookies -->
        <div class="consent-card required">
            <h3>
                üîí Strictly Necessary Cookies
                <span class="badge required">REQUIRED</span>
            </h3>
            <p>
                These cookies are essential for the platform to function. They enable basic features
                like session management, security (CSRF protection), and load balancing. These cannot
                be disabled as the platform requires them to operate.
            </p>
            <div class="toggle-switch">
                <span style="color: #e74c3c; font-weight: 600;">Always Enabled</span>
                <label class="switch">
                    <input type="checkbox" id="strictly-necessary" checked disabled>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Functional Cookies -->
        <div class="consent-card">
            <h3>
                ‚öôÔ∏è Functional Cookies
                <span class="badge optional">OPTIONAL</span>
            </h3>
            <p>
                These cookies enable enhanced functionality like guest session persistence,
                language preferences, UI customization, and returning guest recognition.
                Without these, you'll need to re-enter your preferences on each visit.
            </p>
            <div class="toggle-switch">
                <span id="functional-status">Disabled</span>
                <label class="switch">
                    <input type="checkbox" id="functional-cookies">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Analytics Cookies -->
        <div class="consent-card">
            <h3>
                üìä Analytics Cookies
                <span class="badge optional">OPTIONAL</span>
            </h3>
            <p>
                These cookies help us understand how visitors interact with our platform by
                collecting anonymized data about feature usage, conversion tracking, and A/B testing.
                This helps us improve the demo experience and prioritize new features.
            </p>
            <div class="toggle-switch">
                <span id="analytics-status">Disabled</span>
                <label class="switch">
                    <input type="checkbox" id="analytics-cookies">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Marketing Cookies -->
        <div class="consent-card">
            <h3>
                üì¢ Marketing Cookies
                <span class="badge optional">OPTIONAL</span>
            </h3>
            <p>
                These cookies track your activity for marketing purposes. We do NOT share guest
                session data with third parties. Marketing cookies are used only for internal
                campaign optimization and lead scoring.
            </p>
            <div class="toggle-switch">
                <span id="marketing-status">Disabled</span>
                <label class="switch">
                    <input type="checkbox" id="marketing-cookies">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="button-group">
            <button class="btn-accept-all" onclick="acceptAll()">‚úÖ Accept All</button>
            <button class="btn-reject-all" onclick="rejectAll()">‚ùå Reject All (Necessary Only)</button>
            <button class="btn-save" onclick="savePreferences()">üíæ Save My Preferences</button>
        </div>

        <!-- Status Message -->
        <div id="status-message" class="status-message"></div>

        <!-- Additional Links -->
        <div class="links">
            <a href="/public/privacy-policy.html">Privacy Policy</a>
            <a href="/public/cookie-policy.html">Cookie Policy</a>
            <button onclick="viewMyData()" style="cursor: pointer; padding: 8px 16px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 4px; font-size: 14px;">View My Data (GDPR)</button>
            <button onclick="deleteMyData()" style="cursor: pointer; padding: 8px 16px; margin: 5px; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 14px;">Delete My Data</button>
            <a href="/">Back to Platform</a>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api/v1/privacy';
        let sessionId = null;

        // Get or create session ID
        function getSessionId() {
            let sid = localStorage.getItem('guest_session_id');
            if (!sid) {
                sid = generateUUID();
                localStorage.setItem('guest_session_id', sid);
            }
            return sid;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Load current consent settings
        async function loadCurrentSettings() {
            sessionId = getSessionId();
            document.getElementById('session-id').textContent = sessionId;

            try {
                const response = await fetch(`${API_BASE_URL}/guest-session/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();

                    // Display current settings
                    if (data.consent && data.consent.consent_timestamp) {
                        const currentSettings = document.getElementById('current-settings');
                        const statusText = document.getElementById('current-status');

                        currentSettings.style.display = 'block';
                        statusText.innerHTML = `
                            Consent given on: ${new Date(data.consent.consent_timestamp).toLocaleString()}<br>
                            Policy version: ${data.consent.privacy_policy_version || '3.3.0'}<br>
                            Functional: ${data.consent.functional_cookies ? '‚úÖ Enabled' : '‚ùå Disabled'} |
                            Analytics: ${data.consent.analytics_cookies ? '‚úÖ Enabled' : '‚ùå Disabled'} |
                            Marketing: ${data.consent.marketing_cookies ? '‚úÖ Enabled' : '‚ùå Disabled'}
                        `;

                        // Set checkboxes to current values
                        document.getElementById('functional-cookies').checked = data.consent.functional_cookies || false;
                        document.getElementById('analytics-cookies').checked = data.consent.analytics_cookies || false;
                        document.getElementById('marketing-cookies').checked = data.consent.marketing_cookies || false;

                        updateStatusLabels();
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Update status labels
        function updateStatusLabels() {
            const functional = document.getElementById('functional-cookies').checked;
            const analytics = document.getElementById('analytics-cookies').checked;
            const marketing = document.getElementById('marketing-cookies').checked;

            document.getElementById('functional-status').textContent = functional ? 'Enabled' : 'Disabled';
            document.getElementById('analytics-status').textContent = analytics ? 'Enabled' : 'Disabled';
            document.getElementById('marketing-status').textContent = marketing ? 'Enabled' : 'Disabled';

            document.getElementById('functional-status').style.color = functional ? '#27ae60' : '#e74c3c';
            document.getElementById('analytics-status').style.color = analytics ? '#27ae60' : '#e74c3c';
            document.getElementById('marketing-status').style.color = marketing ? '#27ae60' : '#e74c3c';
        }

        // Accept all cookies
        function acceptAll() {
            document.getElementById('functional-cookies').checked = true;
            document.getElementById('analytics-cookies').checked = true;
            document.getElementById('marketing-cookies').checked = true;
            updateStatusLabels();
            savePreferences();
        }

        // Reject all optional cookies
        function rejectAll() {
            document.getElementById('functional-cookies').checked = false;
            document.getElementById('analytics-cookies').checked = false;
            document.getElementById('marketing-cookies').checked = false;
            updateStatusLabels();
            savePreferences();
        }

        // Save preferences to backend
        async function savePreferences() {
            const preferences = {
                functional_cookies: document.getElementById('functional-cookies').checked,
                analytics_cookies: document.getElementById('analytics-cookies').checked,
                marketing_cookies: document.getElementById('marketing-cookies').checked,
                privacy_policy_version: '3.3.0'
            };

            try {
                const response = await fetch(`${API_BASE_URL}/guest-session/${sessionId}/consent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(preferences)
                });

                const statusMessage = document.getElementById('status-message');

                if (response.ok) {
                    const data = await response.json();
                    statusMessage.textContent = '‚úÖ Preferences saved successfully! Your choices have been recorded.';
                    statusMessage.className = 'status-message success';
                    statusMessage.style.display = 'block';

                    // Reload current settings to show update
                    setTimeout(() => {
                        loadCurrentSettings();
                        statusMessage.style.display = 'none';
                    }, 3000);
                } else {
                    statusMessage.textContent = '‚ùå Error saving preferences. Please try again.';
                    statusMessage.className = 'status-message error';
                    statusMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Error saving preferences:', error);
                const statusMessage = document.getElementById('status-message');
                statusMessage.textContent = '‚ùå Network error. Please check your connection and try again.';
                statusMessage.className = 'status-message error';
                statusMessage.style.display = 'block';
            }
        }

        // View my data (GDPR Right to Access)
        async function viewMyData() {
            try {
                const response = await fetch(`${API_BASE_URL}/guest-session/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    alert('Your Data (GDPR Right to Access):\n\n' + JSON.stringify(data, null, 2));
                } else {
                    alert('Unable to retrieve your data. Session may have expired.');
                }
            } catch (error) {
                alert('Error retrieving data: ' + error.message);
            }
        }

        // Delete my data (GDPR Right to Erasure)
        async function deleteMyData() {
            if (!confirm('Are you sure you want to delete all your guest session data? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/guest-session/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('‚úÖ Data Deleted Successfully!\n\n' + data.confirmation);
                    localStorage.removeItem('guest_session_id');
                    window.location.href = '/';
                } else {
                    alert('‚ùå Error deleting data. Please try again.');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Add event listeners for checkbox changes
        document.getElementById('functional-cookies').addEventListener('change', updateStatusLabels);
        document.getElementById('analytics-cookies').addEventListener('change', updateStatusLabels);
        document.getElementById('marketing-cookies').addEventListener('change', updateStatusLabels);

        // Load settings on page load
        window.addEventListener('DOMContentLoaded', loadCurrentSettings);
    </script>
</body>
</html>
