<!DOCTYPE html>
<html>
<head>
    <title>Course Creator Lab - Multi-IDE Environment</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #1e1e1e; 
            color: #ffffff; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* Header */
        .lab-header { 
            background: #2d2d30; 
            padding: 10px 20px; 
            border-bottom: 2px solid #3e3e42; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: relative;
            z-index: 1000;
        }
        
        .lab-title { 
            font-size: 1.2em; 
            font-weight: 600; 
            color: #ffffff; 
        }
        
        .lab-controls { 
            display: flex; 
            gap: 15px; 
            align-items: center;
        }
        
        /* IDE Selector */
        .ide-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .ide-label {
            font-size: 0.9em;
            color: #cccccc;
        }
        
        .ide-tabs {
            display: flex;
            gap: 2px;
            background: #1e1e1e;
            border-radius: 4px;
            padding: 2px;
        }
        
        .ide-tab {
            background: #3e3e42;
            color: #cccccc;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }
        
        .ide-tab:hover { 
            background: #4e4e52; 
            color: #ffffff;
        }
        
        .ide-tab.active { 
            background: #007acc; 
            color: #ffffff;
        }
        
        .ide-tab.loading::after {
            content: "";
            width: 12px;
            height: 12px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .ide-tab.error {
            background: #d73a49;
            color: #ffffff;
        }
        
        .ide-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .ide-status-indicator.offline {
            background: #dc3545;
        }
        
        .ide-status-indicator.loading {
            background: #ffc107;
            animation: pulse 1s infinite;
        }
        
        /* Toggle controls */
        .toggle-controls { 
            display: flex; 
            gap: 10px; 
            align-items: center;
        }
        
        .toggle-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .toggle-btn:hover { background: #005a9e; }
        .toggle-btn.inactive { background: #555; }
        
        /* Main Layout */
        .main-layout { 
            display: grid;
            height: calc(100vh - 60px);
            gap: 2px;
            background: #3e3e42;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: 1fr 300px;
            transition: all 0.3s ease;
        }
        
        .main-layout.ide-fullscreen {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
        }
        
        /* Panels */
        .panel {
            background: #252526;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .main-layout.ide-fullscreen .panel:not(.ide-panel) { 
            display: none; 
        }
        
        .panel.panel-hidden { display: none; }
        
        .panel-header { 
            background: #2d2d30;
            padding: 10px 15px; 
            border-bottom: 1px solid #3e3e42; 
            font-weight: 600; 
            font-size: 0.9em;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Exercise Panel */
        .exercise-panel { 
            grid-column: 1; 
            grid-row: 1 / 3; 
        }
        
        .exercise-list { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
        }
        
        .exercise-item { 
            background: #2d2d30; 
            padding: 12px; 
            border-radius: 6px; 
            border: 1px solid #3e3e42; 
            margin-bottom: 10px;
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .exercise-item:hover { 
            background: #3e3e42; 
            border-color: #007acc; 
        }
        
        .exercise-item.active { 
            background: #1e3a5f; 
            border-color: #007acc; 
        }
        
        /* IDE Panel */
        .ide-panel { 
            grid-column: 2; 
            grid-row: 1 / 3; 
            position: relative;
        }
        
        .ide-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .ide-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #1e1e1e;
        }
        
        .ide-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #cccccc;
        }
        
        .ide-loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #3e3e42;
            border-top: 4px solid #007acc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        .ide-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #dc3545;
            padding: 20px;
        }
        
        .ide-welcome {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #cccccc;
            padding: 20px;
        }
        
        .ide-welcome h3 {
            color: #ffffff;
            margin-bottom: 15px;
        }
        
        .ide-welcome p {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        /* Help Panel */
        .help-panel { 
            grid-column: 3; 
            grid-row: 1; 
        }
        
        .help-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
            font-size: 0.8em; 
            line-height: 1.4; 
        }
        
        /* Output Panel */
        .output-panel { 
            grid-column: 3; 
            grid-row: 2; 
        }
        
        .output-content { 
            flex: 1; 
            background: #1e1e1e; 
            font-family: 'Courier New', monospace; 
            font-size: 0.8em; 
            padding: 10px; 
            overflow-y: auto; 
            white-space: pre-wrap; 
        }
        
        /* Fullscreen toggle */
        .fullscreen-btn {
            background: transparent;
            border: 1px solid #3e3e42;
            color: #cccccc;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7em;
        }
        
        .fullscreen-btn:hover {
            background: #3e3e42;
            color: #ffffff;
        }
        
        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* File Management Styles */
        .file-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .control-btn {
            background: #3e3e42;
            color: #cccccc;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .control-btn:hover {
            background: #4e4e52;
            color: #ffffff;
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .files-panel {
            grid-column: 3;
            grid-row: 2;
        }
        
        .files-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.9em;
        }
        
        .file-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .file-list-header h6 {
            margin: 0;
            color: #ffffff;
            font-size: 0.9em;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #2d2d30;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }
        
        .file-info i {
            color: #007acc;
            font-size: 1.1em;
            width: 16px;
            text-align: center;
        }
        
        .file-details {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 500;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-metadata {
            font-size: 0.75em;
            color: #888888;
            margin-top: 2px;
        }
        
        .download-file-btn {
            background: transparent;
            color: #007acc;
            border: 1px solid #007acc;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        
        .download-file-btn:hover {
            background: #007acc;
            color: #ffffff;
        }
        
        .no-files-message {
            text-align: center;
            color: #888888;
            padding: 40px 20px;
        }
        
        .no-files-message i {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
            color: #555555;
        }
        
        .no-files-message p {
            margin: 5px 0;
        }
        
        .file-manager-notification {
            max-width: 350px;
            margin-bottom: 10px;
        }
        
        /* Responsive design */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 250px 1fr 250px;
            }
        }
        
        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            
            .exercise-panel,
            .help-panel,
            .output-panel {
                display: none;
            }
            
            .ide-panel {
                grid-column: 1;
                grid-row: 2;
            }
            
            .lab-controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .ide-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <!-- Lab Header -->
    <div class="lab-header">
        <div class="lab-title">Course Creator Lab - Multi-IDE Environment</div>
        <div class="lab-controls">
            <!-- IDE Selector -->
            <div class="ide-selector">
                <span class="ide-label">IDE:</span>
                <div class="ide-tabs">
                    <button class="ide-tab active" data-ide="terminal">
                        <span class="ide-status-indicator"></span>
                        Terminal
                    </button>
                    <button class="ide-tab" data-ide="vscode">
                        <span class="ide-status-indicator loading"></span>
                        VSCode
                    </button>
                    <button class="ide-tab" data-ide="jupyter">
                        <span class="ide-status-indicator loading"></span>
                        JupyterLab
                    </button>
                    <button class="ide-tab" data-ide="intellij" style="display: none;">
                        <span class="ide-status-indicator offline"></span>
                        IntelliJ
                    </button>
                </div>
            </div>
            
            <!-- Toggle Controls -->
            <div class="toggle-controls">
                <button class="toggle-btn" id="exerciseToggle">Exercises</button>
                <button class="toggle-btn" id="helpToggle">Help</button>
                <button class="toggle-btn" id="outputToggle">Output</button>
                <button class="toggle-btn" id="filesToggle">My Files</button>
            </div>
            
            <!-- File Management Controls -->
            <div class="file-controls">
                <button id="downloadWorkspaceBtn" class="control-btn" title="Download All Files as ZIP">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout" id="mainLayout">
        <!-- Exercise Panel -->
        <div class="panel exercise-panel" id="exercisePanel">
            <div class="panel-header">
                Lab Exercises
                <button class="fullscreen-btn" onclick="toggleFullscreen('exercise')">⛶</button>
            </div>
            <div class="exercise-list" id="exerciseList">
                <div class="exercise-item active" data-exercise="hello-world">
                    <strong>Hello World</strong>
                    <p>Create your first program in the selected IDE</p>
                </div>
                <div class="exercise-item" data-exercise="variables">
                    <strong>Variables & Data Types</strong>
                    <p>Learn about different data types and variables</p>
                </div>
                <div class="exercise-item" data-exercise="functions">
                    <strong>Functions</strong>
                    <p>Create and use functions in your code</p>
                </div>
                <div class="exercise-item" data-exercise="data-analysis">
                    <strong>Data Analysis</strong>
                    <p>Use Jupyter notebooks for data analysis</p>
                </div>
            </div>
        </div>

        <!-- IDE Panel -->
        <div class="panel ide-panel" id="idePanel">
            <div class="panel-header">
                <span id="ideTitle">Terminal</span>
                <button class="fullscreen-btn" onclick="toggleFullscreen('ide')">⛶</button>
            </div>
            <div class="ide-content" id="ideContent">
                <!-- Welcome message -->
                <div class="ide-welcome" id="ideWelcome">
                    <h3>Welcome to Course Creator Lab</h3>
                    <p>Select an IDE from the tabs above to get started:</p>
                    <p><strong>Terminal:</strong> Traditional command-line interface</p>
                    <p><strong>VSCode:</strong> Full-featured code editor with extensions</p>
                    <p><strong>JupyterLab:</strong> Notebook environment for data science</p>
                    <p><strong>IntelliJ:</strong> Professional IDE (when available)</p>
                </div>
                
                <!-- Loading indicator -->
                <div class="ide-loading" id="ideLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading IDE...</p>
                </div>
                
                <!-- Error message -->
                <div class="ide-error" id="ideError" style="display: none;">
                    <p>Failed to load IDE</p>
                    <button onclick="retryIDE()" style="margin-top: 10px; padding: 5px 10px;">Retry</button>
                </div>
                
                <!-- IDE Frame -->
                <iframe class="ide-frame" id="ideFrame" style="display: none;"></iframe>
            </div>
        </div>

        <!-- Help Panel -->
        <div class="panel help-panel" id="helpPanel">
            <div class="panel-header">
                Help & Instructions
                <button class="fullscreen-btn" onclick="toggleFullscreen('help')">⛶</button>
            </div>
            <div class="help-content" id="helpContent">
                <h4>Getting Started</h4>
                <p>This lab environment supports multiple IDEs to match your coding preferences:</p>
                
                <h5>Terminal</h5>
                <ul>
                    <li>Traditional command-line interface</li>
                    <li>Direct access to system commands</li>
                    <li>Lightweight and fast</li>
                </ul>
                
                <h5>VSCode</h5>
                <ul>
                    <li>Full-featured code editor</li>
                    <li>Syntax highlighting and IntelliSense</li>
                    <li>Integrated terminal and debugging</li>
                    <li>Extension support</li>
                </ul>
                
                <h5>JupyterLab</h5>
                <ul>
                    <li>Interactive notebook environment</li>
                    <li>Perfect for data science and exploration</li>
                    <li>Rich output display (plots, tables, etc.)</li>
                    <li>Markdown and code cells</li>
                </ul>
                
                <h5>IntelliJ IDEA</h5>
                <ul>
                    <li>Professional Java/Python IDE</li>
                    <li>Advanced refactoring tools</li>
                    <li>Integrated version control</li>
                    <li>Resource-intensive (may not always be available)</li>
                </ul>
                
                <h4>Tips</h4>
                <ul>
                    <li>Use the fullscreen button (⛶) to maximize any panel</li>
                    <li>Toggle panels on/off using the header buttons</li>
                    <li>Switch between IDEs anytime during your work</li>
                    <li>Your work is automatically saved across IDE switches</li>
                </ul>
            </div>
        </div>

        <!-- Output Panel -->
        <div class="panel output-panel" id="outputPanel">
            <div class="panel-header">
                Output & Logs
                <button class="fullscreen-btn" onclick="toggleFullscreen('output')">⛶</button>
            </div>
            <div class="output-content" id="outputContent">
                Lab environment initializing...
                IDE services starting...
                Terminal: Ready
                VSCode: Starting...
                JupyterLab: Starting...
                
                Ready for your first exercise!
            </div>
        </div>

        <!-- Files Panel -->
        <div class="panel files-panel panel-hidden" id="filesPanel">
            <div class="panel-header">
                My Files
                <button class="fullscreen-btn" onclick="toggleFullscreen('files')">⛶</button>
            </div>
            <div class="files-content" id="filesContent">
                <div class="file-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading files...</p>
                </div>
                <div id="studentFileList">
                    <div class="no-files-message">
                        <i class="fas fa-folder-open"></i>
                        <p>Click "Refresh" to load your files</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Multi-IDE Lab Environment JavaScript
        class MultiIDELab {
            constructor() {
                this.currentIDE = 'terminal';
                this.ideStatus = {
                    terminal: { ready: true, url: '/' },
                    vscode: { ready: false, url: '/ide/vscode' },
                    jupyter: { ready: false, url: '/ide/jupyter' },
                    intellij: { ready: false, url: '/ide/intellij' }
                };
                this.labContainerURL = this.getLabContainerURL();
                this.init();
            }
            
            getLabContainerURL() {
                // Extract lab container URL from URL parameters or use default
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('lab_url') || 'http://localhost:8080';
            }
            
            init() {
                this.bindEvents();
                this.checkIDEStatus();
                this.startStatusPolling();
            }
            
            bindEvents() {
                // IDE tab switching
                document.querySelectorAll('.ide-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const ideType = e.currentTarget.dataset.ide;
                        this.switchIDE(ideType);
                    });
                });
                
                // Panel toggles
                document.getElementById('exerciseToggle').addEventListener('click', () => {
                    this.togglePanel('exercise');
                });
                
                document.getElementById('helpToggle').addEventListener('click', () => {
                    this.togglePanel('help');
                });
                
                document.getElementById('outputToggle').addEventListener('click', () => {
                    this.togglePanel('output');
                });
                
                document.getElementById('filesToggle').addEventListener('click', () => {
                    this.togglePanel('files');
                });
                
                // File management controls
                document.getElementById('downloadWorkspaceBtn').addEventListener('click', () => {
                    this.downloadWorkspace();
                });
                
                // Exercise selection  
                document.querySelectorAll('.exercise-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        this.selectExercise(e.currentTarget.dataset.exercise);
                    });
                });
            }
            
            async checkIDEStatus() {
                try {
                    const response = await fetch(`${this.labContainerURL}/api/status`);
                    const data = await response.json();
                    
                    if (data.ides) {
                        Object.keys(data.ides).forEach(ideType => {
                            const ideInfo = data.ides[ideType];
                            this.updateIDEStatus(ideType, ideInfo.healthy, ideInfo.url);
                        });
                    }
                    
                    this.logOutput('IDE status updated');
                } catch (error) {
                    console.error('Failed to check IDE status:', error);
                    this.logOutput('Failed to connect to lab container: ' + error.message);
                }
            }
            
            updateIDEStatus(ideType, ready, url) {
                this.ideStatus[ideType] = { ready, url: url || this.ideStatus[ideType].url };
                
                const tab = document.querySelector(`[data-ide="${ideType}"]`);
                const indicator = tab?.querySelector('.ide-status-indicator');
                
                if (indicator) {
                    indicator.className = 'ide-status-indicator';
                    if (ready) {
                        indicator.classList.add('online');
                    } else {
                        indicator.classList.add('offline');
                    }
                }
                
                if (tab) {
                    tab.classList.remove('loading', 'error');
                    if (!ready) {
                        tab.classList.add('error');
                    }
                }
                
                // Show/hide IntelliJ tab based on availability
                if (ideType === 'intellij') {
                    tab.style.display = ready ? 'flex' : 'none';
                }
            }
            
            async switchIDE(ideType) {
                if (this.currentIDE === ideType) return;
                
                // Update active tab
                document.querySelectorAll('.ide-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-ide="${ideType}"]`).classList.add('active');
                
                // Update IDE title
                const ideNames = {
                    terminal: 'Terminal',
                    vscode: 'VSCode Server',
                    jupyter: 'JupyterLab',
                    intellij: 'IntelliJ IDEA'
                };
                document.getElementById('ideTitle').textContent = ideNames[ideType];
                
                // Show loading
                this.showIDELoading();
                
                try {
                    await this.loadIDE(ideType);
                    this.currentIDE = ideType;
                    this.logOutput(`Switched to ${ideNames[ideType]}`);
                } catch (error) {
                    console.error('Failed to switch IDE:', error);
                    this.showIDEError();
                    this.logOutput(`Failed to load ${ideNames[ideType]}: ${error.message}`);
                }
            }
            
            async loadIDE(ideType) {
                const ideFrame = document.getElementById('ideFrame');
                const ideStatus = this.ideStatus[ideType];
                
                if (!ideStatus.ready) {
                    throw new Error(`${ideType} is not ready`);
                }
                
                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('IDE loading timeout'));
                    }, 15000);
                    
                    ideFrame.onload = () => {
                        clearTimeout(timeout);
                        this.showIDEFrame();
                        resolve();
                    };
                    
                    ideFrame.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Failed to load IDE'));
                    };
                    
                    // Set the iframe source
                    const targetURL = `${this.labContainerURL}${ideStatus.url}`;
                    ideFrame.src = targetURL;
                });
            }
            
            showIDELoading() {
                document.getElementById('ideWelcome').style.display = 'none';
                document.getElementById('ideError').style.display = 'none';
                document.getElementById('ideFrame').style.display = 'none';
                document.getElementById('ideLoading').style.display = 'block';
            }
            
            showIDEFrame() {
                document.getElementById('ideWelcome').style.display = 'none';
                document.getElementById('ideError').style.display = 'none';
                document.getElementById('ideLoading').style.display = 'none';
                document.getElementById('ideFrame').style.display = 'block';
            }
            
            showIDEError() {
                document.getElementById('ideWelcome').style.display = 'none';
                document.getElementById('ideLoading').style.display = 'none';
                document.getElementById('ideFrame').style.display = 'none';
                document.getElementById('ideError').style.display = 'block';
            }
            
            togglePanel(panelType) {
                const panel = document.getElementById(`${panelType}Panel`);
                const toggle = document.getElementById(`${panelType}Toggle`);
                
                if (panel.classList.contains('panel-hidden')) {
                    panel.classList.remove('panel-hidden');
                    toggle.classList.remove('inactive');
                    
                    // Auto-load files when files panel is shown
                    if (panelType === 'files') {
                        this.loadFileList();
                    }
                } else {
                    panel.classList.add('panel-hidden');
                    toggle.classList.add('inactive');
                }
                
                this.adjustLayout();
            }
            
            adjustLayout() {
                const layout = document.getElementById('mainLayout');
                const exerciseHidden = document.getElementById('exercisePanel').classList.contains('panel-hidden');
                const helpHidden = document.getElementById('helpPanel').classList.contains('panel-hidden');
                const outputHidden = document.getElementById('outputPanel').classList.contains('panel-hidden');
                const filesHidden = document.getElementById('filesPanel').classList.contains('panel-hidden');
                
                // Count visible right panels (help/output/files)
                const rightPanels = [helpHidden, outputHidden, filesHidden].filter(hidden => !hidden).length;
                
                let gridCols = '';
                if (!exerciseHidden && rightPanels > 0) {
                    gridCols = '300px 1fr 300px';
                } else if (!exerciseHidden && rightPanels === 0) {
                    gridCols = '300px 1fr';
                } else if (exerciseHidden && rightPanels > 0) {
                    gridCols = '1fr 300px';
                } else {
                    gridCols = '1fr';
                }
                
                layout.style.gridTemplateColumns = gridCols;
            }
            
            selectExercise(exerciseType) {
                // Update active exercise
                document.querySelectorAll('.exercise-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-exercise="${exerciseType}"]`).classList.add('active');
                
                // Update help content based on exercise
                this.updateHelpForExercise(exerciseType);
                
                this.logOutput(`Selected exercise: ${exerciseType}`);
            }
            
            updateHelpForExercise(exerciseType) {
                const helpContent = document.getElementById('helpContent');
                const exerciseHelp = {
                    'hello-world': `
                        <h4>Hello World Exercise</h4>
                        <p>Create your first program:</p>
                        <ul>
                            <li><strong>Terminal:</strong> Create a file with nano/vim and run it</li>
                            <li><strong>VSCode:</strong> Use the file explorer to create a new file</li>
                            <li><strong>JupyterLab:</strong> Create a new notebook</li>
                        </ul>
                        <p>Example code:</p>
                        <pre>print("Hello, Course Creator Lab!")</pre>
                    `,
                    'variables': `
                        <h4>Variables & Data Types</h4>
                        <p>Learn about different data types:</p>
                        <ul>
                            <li>Strings: text data</li>
                            <li>Numbers: integers and floats</li>
                            <li>Lists: collections of items</li>
                            <li>Dictionaries: key-value pairs</li>
                        </ul>
                    `,
                    'functions': `
                        <h4>Functions Exercise</h4>
                        <p>Create reusable code blocks:</p>
                        <ul>
                            <li>Define functions with def</li>
                            <li>Pass parameters and return values</li>
                            <li>Use functions to organize code</li>
                        </ul>
                    `,
                    'data-analysis': `
                        <h4>Data Analysis Exercise</h4>
                        <p>Best performed in JupyterLab:</p>
                        <ul>
                            <li>Load data with pandas</li>
                            <li>Create visualizations with matplotlib</li>
                            <li>Use interactive widgets</li>
                        </ul>
                    `
                };
                
                helpContent.innerHTML = exerciseHelp[exerciseType] || helpContent.innerHTML;
            }
            
            logOutput(message) {
                const output = document.getElementById('outputContent');
                const timestamp = new Date().toLocaleTimeString();
                output.textContent += `\n[${timestamp}] ${message}`;
                output.scrollTop = output.scrollHeight;
            }
            
            startStatusPolling() {
                // Poll IDE status every 30 seconds
                setInterval(() => {
                    this.checkIDEStatus();
                }, 30000);
            }
            
            // File Management Methods
            async loadFileList() {
                const labId = this.getLabId();
                if (!labId) {
                    this.showFileError('Lab ID not found');
                    return;
                }
                
                try {
                    const response = await fetch(`http://localhost:8006/labs/${labId}/files`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.displayFileList(data.files || []);
                    
                } catch (error) {
                    console.error('Error loading files:', error);
                    this.showFileError('Failed to load files: ' + error.message);
                }
            }
            
            displayFileList(files) {
                const fileListContainer = document.getElementById('studentFileList');
                
                if (files.length === 0) {
                    fileListContainer.innerHTML = `
                        <div class="no-files-message">
                            <i class="fas fa-folder-open"></i>
                            <p>No files found in your workspace</p>
                            <p class="text-muted">Create some files in your lab environment and refresh to see them here</p>
                        </div>
                    `;
                    return;
                }
                
                const fileListHTML = files.map(file => `
                    <div class="file-item">
                        <div class="file-info">
                            <i class="fas fa-file${this.getFileIcon(file.name)}"></i>
                            <div class="file-details">
                                <div class="file-name">${this.escapeHtml(file.name)}</div>
                                <div class="file-metadata">
                                    ${this.formatFileSize(file.size)} • Modified: ${this.formatDate(file.modified)}
                                </div>
                            </div>
                        </div>
                        <button class="download-file-btn" onclick="window.multiIDELab.downloadFile('${this.escapeHtml(file.name)}')" title="Download ${this.escapeHtml(file.name)}">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `).join('');
                
                fileListContainer.innerHTML = `
                    <div class="file-list-header">
                        <h6>Your Files (${files.length})</h6>
                        <button onclick="window.multiIDELab.loadFileList()" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="file-list-content">
                        ${fileListHTML}
                    </div>
                `;
            }
            
            async downloadFile(filename) {
                const labId = this.getLabId();
                if (!labId || !filename) {
                    this.showFileError('Missing lab ID or filename');
                    return;
                }
                
                try {
                    const response = await fetch(`http://localhost:8006/labs/${labId}/download/${encodeURIComponent(filename)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    this.logOutput(`Downloaded: ${filename}`);
                    
                } catch (error) {
                    console.error('Error downloading file:', error);
                    this.showFileError('Failed to download file: ' + error.message);
                }
            }
            
            async downloadWorkspace() {
                const labId = this.getLabId();
                if (!labId) {
                    this.showFileError('Lab ID not found');
                    return;
                }
                
                try {
                    const response = await fetch(`http://localhost:8006/labs/${labId}/download-workspace`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `workspace-${labId}-${new Date().toISOString().split('T')[0]}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    this.logOutput('Workspace downloaded successfully!');
                    
                } catch (error) {
                    console.error('Error downloading workspace:', error);
                    this.showFileError('Failed to download workspace: ' + error.message);
                }
            }
            
            getLabId() {
                // Try to extract lab ID from URL or other sources
                const urlParams = new URLSearchParams(window.location.search);
                let labId = urlParams.get('lab_id');
                
                if (!labId && window.location.hash) {
                    const match = window.location.hash.match(/lab_id=([^&]+)/);
                    if (match) labId = match[1];
                }
                
                // Fallback: try to get from global variable
                if (!labId && window.currentLabId) {
                    labId = window.currentLabId;
                }
                
                return labId;
            }
            
            getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const iconMap = {
                    'py': '-code', 'js': '-code', 'html': '-code', 'css': '-code', 'json': '-code',
                    'md': '-alt', 'txt': '-alt', 'pdf': '-pdf', 'zip': '-archive',
                    'jpg': '-image', 'jpeg': '-image', 'png': '-image', 'gif': '-image'
                };
                return iconMap[ext] || '';
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }
            
            formatDate(dateString) {
                if (!dateString) return 'Unknown';
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            showFileError(message) {
                const fileListContainer = document.getElementById('studentFileList');
                fileListContainer.innerHTML = `
                    <div class="no-files-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p style="color: #dc3545;">${message}</p>
                        <button onclick="window.multiIDELab.loadFileList()" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-retry"></i> Retry
                        </button>
                    </div>
                `;
                this.logOutput('File error: ' + message);
            }
        }
        
        // Global functions
        function toggleFullscreen(panelType) {
            const layout = document.getElementById('mainLayout');
            layout.classList.toggle('ide-fullscreen');
        }
        
        function retryIDE() {
            window.multiIDELab.switchIDE(window.multiIDELab.currentIDE);
        }
        
        // Initialize the lab environment
        document.addEventListener('DOMContentLoaded', () => {
            window.multiIDELab = new MultiIDELab();
        });
    </script>
</body>
</html>