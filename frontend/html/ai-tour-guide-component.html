<!-- AI Tour Guide Component -->
<style>
    /* AI Tour Guide Styles */
    .ai-tour-guide-trigger {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 14px 28px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        transition: all 0.3s ease;
        z-index: 999;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .ai-tour-guide-trigger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 30px rgba(99, 102, 241, 0.6);
    }

    .ai-tour-guide-trigger .ai-icon {
        font-size: 20px;
        animation: bounce 2s infinite;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    .ai-guide-pulse {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 10px;
        height: 10px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.3); }
    }

    .ai-tour-guide-panel {
        position: fixed;
        right: 0;
        top: 0;
        width: 450px;
        height: 100vh;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        box-shadow: -4px 0 40px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        display: flex;
        flex-direction: column;
    }

    .ai-tour-guide-panel.open {
        transform: translateX(0);
    }

    .ai-guide-header {
        padding: 24px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 16px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
    }

    .ai-guide-avatar {
        width: 48px;
        height: 48px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .ai-guide-info h3 {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .ai-guide-status {
        font-size: 13px;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .ai-guide-close {
        margin-left: auto;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .ai-guide-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .ai-guide-messages {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: #f9fafb;
    }

    .ai-guide-message {
        display: flex;
        gap: 12px;
        max-width: 85%;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .ai-guide-message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .user .message-avatar {
        background: #6366f1;
        color: white;
    }

    .ai .message-avatar {
        background: #e5e7eb;
    }

    .message-content {
        padding: 12px 16px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.6;
        word-wrap: break-word;
    }

    .user .message-content {
        background: #6366f1;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .ai .message-content {
        background: white;
        color: #1f2937;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .message-content p {
        margin: 0 0 8px 0;
    }

    .message-content p:last-child {
        margin-bottom: 0;
    }

    .message-content ul, .message-content ol {
        margin: 8px 0;
        padding-left: 20px;
    }

    .message-content li {
        margin: 4px 0;
    }

    .message-content strong {
        font-weight: 600;
    }

    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
        background: white;
        border-radius: 16px;
        border-bottom-left-radius: 4px;
        width: fit-content;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }

    .ai-guide-suggestions {
        padding: 16px 24px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        background: white;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .suggestion-chip {
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        color: #4b5563;
    }

    .suggestion-chip:hover {
        background: #e5e7eb;
        border-color: #6366f1;
        color: #6366f1;
    }

    .ai-guide-input-container {
        padding: 20px 24px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        background: white;
        display: flex;
        gap: 12px;
    }

    .ai-guide-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 24px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
    }

    .ai-guide-input:focus {
        border-color: #6366f1;
    }

    .ai-guide-send {
        background: #6366f1;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ai-guide-send:hover {
        background: #4f46e5;
        transform: scale(1.05);
    }

    .ai-guide-send:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        transform: scale(1);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
        .ai-tour-guide-panel {
            width: 100%;
            height: 80vh;
            bottom: 0;
            top: auto;
            border-radius: 20px 20px 0 0;
            transform: translateY(100%);
        }

        .ai-tour-guide-panel.open {
            transform: translateY(0);
        }

        .ai-tour-guide-trigger {
            bottom: 10px;
            right: 10px;
            padding: 12px 20px;
            font-size: 14px;
        }

        .ai-guide-messages {
            padding: 16px;
        }

        .ai-guide-suggestions {
            padding: 12px 16px;
        }

        .ai-guide-input-container {
            padding: 16px;
        }
    }
</style>

<!-- AI Tour Guide HTML -->
<button class="ai-tour-guide-trigger" id="ai-tour-guide-trigger" aria-label="Open AI Tour Guide">
    <span class="ai-icon">ðŸ¤–</span>
    <span>Ask AI Guide</span>
    <span class="ai-guide-pulse"></span>
</button>

<div class="ai-tour-guide-panel" id="ai-tour-guide-panel" role="dialog" aria-label="AI Tour Guide Chat">
    <div class="ai-guide-header">
        <div class="ai-guide-avatar">ðŸ¤–</div>
        <div class="ai-guide-info">
            <h3>AI Tour Guide</h3>
            <div class="ai-guide-status">
                <span class="status-dot"></span>
                <span>Online â€¢ Instant responses</span>
            </div>
        </div>
        <button class="ai-guide-close" id="ai-guide-close" aria-label="Close AI Tour Guide">Ã—</button>
    </div>

    <div class="ai-guide-messages" id="ai-guide-messages" role="log" aria-live="polite">
        <!-- Messages will be inserted here -->
    </div>

    <div class="ai-guide-suggestions" id="ai-guide-suggestions">
        <button class="suggestion-chip" data-question="Who is this platform for?">Who is this for?</button>
        <button class="suggestion-chip" data-question="How does the AI help with course creation?">How does AI help?</button>
        <button class="suggestion-chip" data-question="What integrations do you support?">What integrations?</button>
        <button class="suggestion-chip" data-question="How much does this cost?">Pricing?</button>
        <button class="suggestion-chip" data-question="How do I get started?">Get Started</button>
    </div>

    <div class="ai-guide-input-container">
        <input
            type="text"
            class="ai-guide-input"
            id="ai-guide-input"
            placeholder="Ask anything about the platform..."
            aria-label="Type your question">
        <button class="ai-guide-send" id="ai-guide-send" aria-label="Send message">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<script>
// AI Tour Guide JavaScript
class AITourGuide {
    constructor() {
        this.panel = document.getElementById('ai-tour-guide-panel');
        this.trigger = document.getElementById('ai-tour-guide-trigger');
        this.closeBtn = document.getElementById('ai-guide-close');
        this.messages = document.getElementById('ai-guide-messages');
        this.input = document.getElementById('ai-guide-input');
        this.sendBtn = document.getElementById('ai-guide-send');
        this.suggestions = document.getElementById('ai-guide-suggestions');

        this.isOpen = false;
        this.conversationHistory = [];

        this.init();
    }

    init() {
        // Event listeners
        this.trigger.addEventListener('click', () => this.openPanel());
        this.closeBtn.addEventListener('click', () => this.closePanel());
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        this.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.sendMessage();
        });

        // Suggestion chips
        this.suggestions.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const question = chip.dataset.question;
                this.input.value = question;
                this.sendMessage();
            });
        });

        // Send welcome message when opened
        this.panel.addEventListener('transitionend', (e) => {
            if (e.propertyName === 'transform' && this.isOpen && this.messages.children.length === 0) {
                this.sendWelcomeMessage();
            }
        });
    }

    openPanel() {
        this.isOpen = true;
        this.panel.classList.add('open');
        this.input.focus();
    }

    closePanel() {
        this.isOpen = false;
        this.panel.classList.remove('open');
    }

    sendWelcomeMessage() {
        const welcomeText = `ðŸ‘‹ Hi! I'm your AI tour guide. I can answer questions about:

â€¢ Who this platform is for
â€¢ Key features and capabilities
â€¢ AI-powered course development
â€¢ Integrations (Zoom, Teams, Slack)
â€¢ Getting started

What would you like to know?`;

        this.addMessage('ai', welcomeText);
    }

    async sendMessage() {
        const userMessage = this.input.value.trim();
        if (!userMessage) return;

        // Clear input and disable while processing
        this.input.value = '';
        this.input.disabled = true;
        this.sendBtn.disabled = true;

        // Add user message
        this.addMessage('user', userMessage);

        // Show typing indicator
        this.showTypingIndicator();

        try {
            // Call RAG service
            const response = await this.queryRAG(userMessage);

            // Remove typing indicator
            this.hideTypingIndicator();

            // Add AI response
            this.addMessage('ai', response);

            // Store in conversation history
            this.conversationHistory.push({
                user: userMessage,
                ai: response
            });

        } catch (error) {
            console.error('AI Tour Guide error:', error);
            this.hideTypingIndicator();
            this.addMessage('ai', "I'm having trouble connecting right now. Please try asking your question again, or feel free to explore the demo and ask me later!");
        } finally {
            // Re-enable input
            this.input.disabled = false;
            this.sendBtn.disabled = false;
            this.input.focus();
        }
    }

    async queryRAG(question) {
        const response = await fetch('https://localhost:8007/api/v1/rag/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                query: question,
                context: 'demo_tour_guide',
                conversation_history: this.conversationHistory.slice(-5) // Last 5 exchanges
            })
        });

        if (!response.ok) {
            throw new Error(`RAG service error: ${response.status}`);
        }

        const data = await response.json();
        return data.answer || data.response || "I'm not sure how to answer that. Could you rephrase your question?";
    }

    addMessage(type, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-guide-message ${type}`;

        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = type === 'ai' ? 'ðŸ¤–' : 'ðŸ‘¤';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.innerHTML = this.formatMessage(content);

        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(contentDiv);

        this.messages.appendChild(messageDiv);
        this.scrollToBottom();
    }

    formatMessage(content) {
        // Simple markdown-like formatting
        let formatted = content;

        // Convert **bold** to <strong>
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Convert bullet points
        formatted = formatted.replace(/^â€¢ (.+)$/gm, '<li>$1</li>');

        // Wrap lists
        formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

        // Convert line breaks to paragraphs
        const paragraphs = formatted.split('\n\n');
        formatted = paragraphs.map(p => {
            if (p.trim() && !p.startsWith('<')) {
                return `<p>${p.trim()}</p>`;
            }
            return p;
        }).join('');

        return formatted;
    }

    showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-guide-message ai typing-indicator-container';
        typingDiv.id = 'typing-indicator';

        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'message-avatar';
        avatarDiv.textContent = 'ðŸ¤–';

        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';

        typingDiv.appendChild(avatarDiv);
        typingDiv.appendChild(typingIndicator);

        this.messages.appendChild(typingDiv);
        this.scrollToBottom();
    }

    hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    }

    scrollToBottom() {
        this.messages.scrollTop = this.messages.scrollHeight;
    }
}

// Initialize AI Tour Guide when page loads
document.addEventListener('DOMContentLoaded', () => {
    window.aiTourGuide = new AITourGuide();
});
</script>
