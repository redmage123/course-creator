<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.5, maximum-scale=3.0">
    <title>Instructor Dashboard - Course Creator</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .duration-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }
        .duration-input-group input[type="number"] {
            flex: 0 0 120px;
            min-width: 120px;
            max-width: 120px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            overflow: hidden;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        .duration-input-group input[type="number"]::-webkit-outer-spin-button,
        .duration-input-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .duration-input-group select {
            flex: 0 0 100px;
            min-width: 100px;
            max-width: 100px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }

        /* Lab Container Management Styles */
        .lab-management-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .lab-controls-section h3,
        .instructor-lab-section h3,
        .student-labs-section h3,
        .lab-analytics-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .lab-controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .lab-status-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .lab-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-running { background-color: #d4edda; color: #155724; }
        .status-paused { background-color: #fff3cd; color: #856404; }
        .status-building { background-color: #cce7ff; color: #004085; }
        .status-stopped { background-color: #f8d7da; color: #721c24; }
        .status-error { background-color: #f5c6cb; color: #721c24; }

        .lab-status-details p {
            margin: 5px 0;
            font-size: 14px;
        }

        .lab-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .no-lab-message,
        .no-students-message,
        .error-message {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .no-lab-message i,
        .no-students-message i,
        .error-message i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .lab-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .lab-filters input,
        .lab-filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .lab-filters input {
            flex: 1;
            max-width: 300px;
        }

        .student-labs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .student-lab-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .student-card-header h4 {
            margin: 0;
            color: #2c3e50;
        }

        .student-card-body p {
            margin: 5px 0;
            font-size: 13px;
            color: #6c757d;
        }

        .student-card-actions {
            margin-top: 15px;
            display: flex;
            gap: 8px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .analytics-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analytics-card h4 {
            margin: 0 0 10px 0;
            color: #6c757d;
            font-size: 14px;
            text-transform: uppercase;
        }

        .analytics-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading-indicator i {
            font-size: 24px;
            margin-right: 10px;
        }

        /* Modal size adjustments */
        .modal-content.extra-large {
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Analytics Dashboard Styles */
        .analytics-controls {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }

        .analytics-overview {
            margin-bottom: 30px;
        }

        .analytics-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: box-shadow 0.3s ease;
        }

        .analytics-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .analytics-card .card-icon {
            width: 50px;
            height: 50px;
            background: #e3f2fd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1976d2;
            font-size: 20px;
        }

        .analytics-card .card-content h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
        }

        .analytics-card .card-value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }

        .analytics-charts {
            margin-bottom: 30px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-container h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        .chart-container canvas {
            max-height: 300px;
        }

        .student-analytics-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .student-analytics-section .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .student-analytics-section h3 {
            margin: 0;
            color: #2c3e50;
        }

        .search-box {
            position: relative;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .search-box i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .students-analytics-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .student-analytics-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .student-analytics-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: white;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .student-avatar {
            width: 50px;
            height: 50px;
            background: #007bff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .student-details h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .student-email {
            color: #6c757d;
            font-size: 14px;
            margin: 0 0 5px 0;
        }

        .last-active {
            color: #6c757d;
            font-size: 12px;
            margin: 0;
        }

        .student-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .metric label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
        }

        .student-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 5px 12px;
            font-size: 12px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
    </style>
    <!-- Security: DOMPurify for XSS protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <!-- Mobile sidebar toggle -->
    <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle navigation">
        <i class="fas fa-bars"></i>
    </button>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1><i class="fas fa-graduation-cap"></i> Course Creator</h1>
                </div>
                <nav class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="instructor-dashboard.html" class="active">Dashboard</a>
                </nav>
                <div class="account-section">
                    <div class="account-dropdown" id="accountDropdown">
                        <button class="account-trigger" onclick="toggleAccountDropdown()" type="button" style="border: none; background: none; color: inherit; font: inherit;">
                            <div class="user-avatar instructor-avatar" id="userAvatar">
                                <span class="avatar-initials" id="avatarInitials">IN</span>
                            </div>
                            <span class="user-name" id="userName">Instructor</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="account-menu" id="accountMenu">
                            <a href="#" onclick="showProfileModal(); return false;"><i class="fas fa-user"></i> Profile</a>
                            <a href="#" onclick="showSettingsModal(); return false;"><i class="fas fa-cog"></i> Settings</a>
                            <a href="#" onclick="showHelpModal(); return false;"><i class="fas fa-question-circle"></i> Help</a>
                            <hr>
                            <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-layout">
        <!-- Sidebar Navigation -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar-large">
                        <span class="avatar-initials" id="sidebarAvatarInitials">IN</span>
                    </div>
                    <div class="user-details">
                        <h3 id="sidebarUserName">Instructor</h3>
                        <p id="sidebarUserRole">Course Instructor</p>
                    </div>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('overview')" data-section="overview">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('courses')" data-section="courses">
                            <i class="fas fa-book"></i>
                            <span>My Courses</span>
                            <span class="nav-badge" id="courseCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('create-course')" data-section="create-course">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create Course</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('published-courses')" data-section="published-courses">
                            <i class="fas fa-globe"></i>
                            <span>Published Courses</span>
                            <span class="nav-badge" id="publishedCourseCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('course-instances')" data-section="course-instances">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Course Instances</span>
                            <span class="nav-badge" id="instanceCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('students')" data-section="students">
                            <i class="fas fa-users"></i>
                            <span>Students</span>
                            <span class="nav-badge" id="studentCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('analytics')" data-section="analytics">
                            <i class="fas fa-chart-line"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="quick-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalStudents">0</span>
                        <span class="stat-label">Total Students</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activeCourses">0</span>
                        <span class="stat-label">Active Courses</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="dashboard-main">
            <div class="main-header">
                <div class="breadcrumb">
                    <span class="breadcrumb-item" id="currentSection">Overview</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showSection('create-course')" id="quickCreateBtn">
                        <i class="fas fa-plus"></i> Create Course
                    </button>
                </div>
            </div>

            <div class="main-content">

                <!-- Overview Section -->
                <section id="overview-section" class="content-section">
                    <div class="overview-header">
                        <h1>Welcome back!</h1>
                        <p>Here's what's happening with your courses today</p>
                    </div>

                    <!-- Key Metrics Cards -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="metric-content">
                                <h3 class="metric-value" id="overviewTotalStudents">0</h3>
                                <p class="metric-label">Total Students</p>
                                <span class="metric-change positive" id="studentChange">+0 this week</span>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="metric-content">
                                <h3 class="metric-value" id="overviewActiveCourses">0</h3>
                                <p class="metric-label">Active Courses</p>
                                <span class="metric-change neutral" id="courseChange">No change</span>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="metric-content">
                                <h3 class="metric-value" id="overviewAvgProgress">0%</h3>
                                <p class="metric-label">Avg Completion</p>
                                <span class="metric-change positive" id="progressChange">+0% this week</span>
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon">
                                <i class="fas fa-flask"></i>
                            </div>
                            <div class="metric-content">
                                <h3 class="metric-value" id="overviewLabSessions">0</h3>
                                <p class="metric-label">Lab Sessions</p>
                                <span class="metric-change positive" id="labChange">+0 today</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <h2>Quick Actions</h2>
                        <div class="action-grid">
                            <div class="action-card" onclick="showSection('create-course')">
                                <i class="fas fa-plus-circle"></i>
                                <h3>Create New Course</h3>
                                <p>Start building a new course with AI assistance</p>
                            </div>
                            <div class="action-card" onclick="showSection('students')">
                                <i class="fas fa-user-plus"></i>
                                <h3>Enroll Students</h3>
                                <p>Add students to your existing courses</p>
                            </div>
                            <div class="action-card" onclick="viewAnalytics()">
                                <i class="fas fa-chart-bar"></i>
                                <h3>View Analytics</h3>
                                <p>Check detailed course performance metrics</p>
                            </div>
                            <div class="action-card" onclick="showSection('content')">
                                <i class="fas fa-edit"></i>
                                <h3>Edit Content</h3>
                                <p>Update course materials and exercises</p>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="recent-activity">
                        <h2>Recent Activity</h2>
                        <div class="activity-list" id="recentActivityList">
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="activity-content">
                                    <p><strong>New student enrolled</strong> in Python Fundamentals</p>
                                    <span class="activity-time">2 hours ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-flask"></i>
                                </div>
                                <div class="activity-content">
                                    <p><strong>Lab session completed</strong> by 3 students</p>
                                    <span class="activity-time">4 hours ago</span>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="activity-content">
                                    <p><strong>Course completed</strong> by student@example.com</p>
                                    <span class="activity-time">1 day ago</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- My Courses Section -->
                <section id="courses-section" class="content-section">
                    <div class="section-header">
                        <h2>My Courses</h2>
                        <div class="course-filters">
                            <select id="courseStatusFilter" onchange="filterCourses()">
                                <option value="all">All Courses</option>
                                <option value="published">Published</option>
                                <option value="draft">Draft</option>
                                <option value="archived">Archived</option>
                            </select>
                            <div class="search-box">
                                <input type="text" id="courseSearch" placeholder="Search courses..." onkeyup="searchCourses()">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    <div id="courses-list" class="courses-grid enhanced">
                        <!-- Enhanced courses will be loaded here -->
                    </div>
                </section>

                <!-- Create Course Section -->
                <section id="create-course-section" class="content-section">
                    <div class="section-header">
                        <h2>Create New Course</h2>
                        <p>Build a new course with AI-powered content generation</p>
                    </div>
                    <div class="create-course-wizard">
                        <div class="wizard-steps">
                            <div class="step active" data-step="1">
                                <span class="step-number">1</span>
                                <span class="step-title">Basic Info</span>
                            </div>
                            <div class="step" data-step="2">
                                <span class="step-number">2</span>
                                <span class="step-title">Content</span>
                            </div>
                            <div class="step" data-step="3">
                                <span class="step-number">3</span>
                                <span class="step-title">Review</span>
                            </div>
                        </div>
                        
                        <div class="wizard-content">
                            <form id="courseForm">
                                <div class="form-group">
                                    <label for="courseTitle">Course Title</label>
                                    <input type="text" id="courseTitle" name="title" required>
                                </div>
                                <div class="form-group">
                                    <label for="courseDescription">Description</label>
                                    <textarea id="courseDescription" name="description" rows="4" required></textarea>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="courseCategory">Category</label>
                                        <select id="courseCategory" name="category" required>
                                            <option value="">Select Category</option>
                                            <option value="Information Technology">Information Technology</option>
                                            <option value="Computer Science">Computer Science</option>
                                            <option value="Cybersecurity">Cybersecurity</option>
                                            <option value="Data Science">Data Science</option>
                                            <option value="Web Development">Web Development</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="courseDifficulty">Difficulty Level</label>
                                        <select id="courseDifficulty" name="difficulty_level" required>
                                            <option value="beginner">Beginner</option>
                                            <option value="intermediate">Intermediate</option>
                                            <option value="advanced">Advanced</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="courseDuration">Estimated Duration</label>
                                    <div class="duration-input-group">
                                        <input type="number" id="courseDuration" name="estimated_duration" min="1" max="500" placeholder="Enter duration">
                                        <select id="courseDurationUnit" name="duration_unit">
                                            <option value="hours">Hours</option>
                                            <option value="days">Days</option>
                                            <option value="weeks">Weeks</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-magic"></i> Generate Course with AI
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="showSection('courses')">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Students Section -->
                <section id="students-section" class="content-section">
                    <div class="section-header">
                        <h2>Student Management</h2>
                        <p>Manage enrollments and track student progress</p>
                    </div>
                    <div class="student-management-section">
                        <div class="course-selector">
                            <label for="selectedCourse">Select Course:</label>
                            <select id="selectedCourse" onchange="loadCourseStudents()">
                                <option value="">Select a course...</option>
                            </select>
                        </div>
                        
                        <div class="enrollment-section">
                            <h4>Enroll Students</h4>
                            <div class="enrollment-methods">
                                <div class="single-enrollment">
                                    <h5>Single Student</h5>
                                    <form id="singleEnrollmentForm">
                                        <div class="form-group">
                                            <label for="studentEmail">Student Email</label>
                                            <input type="email" id="studentEmail" name="email" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-user-plus"></i> Enroll Student
                                        </button>
                                    </form>
                                </div>
                                
                                <div class="bulk-enrollment">
                                    <h5>Bulk Enrollment</h5>
                                    <form id="bulkEnrollmentForm">
                                        <div class="form-group">
                                            <label for="studentEmails">Student Emails (one per line)</label>
                                            <textarea id="studentEmails" name="emails" rows="8" 
                                                    placeholder="student1@example.com&#10;student2@example.com&#10;student3@example.com"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-users"></i> Enroll Students
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="enrolled-students-section">
                            <h4>Enrolled Students</h4>
                            <div id="enrolled-students-list">
                                <!-- Enrolled students will be loaded here -->
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Course Content Section (Dynamic - populated by showCourseContentView) -->
                <section id="content-section" class="content-section" style="display: none;">
                    <!-- Course content panes will be dynamically inserted here -->
                    
                </section>



                <section id="analytics-section" class="content-section">
                    <div class="section-header">
                        <h2>Student Analytics & Insights</h2>
                        <p>Track course performance, student engagement, and learning analytics</p>
                    </div>
                    
                    <!-- Analytics Controls -->
                    <div class="analytics-controls">
                        <div class="controls-row">
                            <div class="control-group">
                                <label for="analyticsCourseSelect">Course:</label>
                                <select id="analyticsCourseSelect" class="form-select">
                                    <option value="">Select a course</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="analyticsTimeRange">Time Range:</label>
                                <select id="analyticsTimeRange" class="form-select">
                                    <option value="7">Last 7 days</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                    <option value="365">Last year</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <button id="refreshAnalyticsBtn" class="btn btn-secondary">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button id="exportAnalyticsBtn" class="btn btn-outline-primary">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button id="downloadPDFReportBtn" class="btn btn-primary">
                                    <i class="fas fa-file-pdf"></i> Download PDF Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Loading and Messages -->
                    <div id="analyticsLoading" class="loading-indicator" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Loading analytics...
                    </div>
                    <div id="analyticsError" class="alert alert-danger" style="display: none;"></div>
                    <div id="analyticsSuccess" class="alert alert-success" style="display: none;"></div>

                    <!-- Analytics Overview Cards -->
                    <div class="analytics-overview">
                        <div class="analytics-cards-grid">
                            <div class="analytics-card">
                                <div class="card-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="card-content">
                                    <h3>Total Students</h3>
                                    <div class="card-value" id="totalStudentsCount">-</div>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <div class="card-icon">
                                    <i class="fas fa-user-check"></i>
                                </div>
                                <div class="card-content">
                                    <h3>Active Students</h3>
                                    <div class="card-value" id="activeStudentsCount">-</div>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <div class="card-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="card-content">
                                    <h3>Avg Quiz Score</h3>
                                    <div class="card-value" id="avgQuizScore">-%</div>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <div class="card-icon">
                                    <i class="fas fa-flask"></i>
                                </div>
                                <div class="card-content">
                                    <h3>Lab Completion</h3>
                                    <div class="card-value" id="labCompletionRate">-%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Charts -->
                    <div class="analytics-charts">
                        <div class="charts-grid">
                            <div class="chart-container">
                                <h4>Student Engagement Over Time</h4>
                                <canvas id="engagementChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h4>Lab Completion Status</h4>
                                <canvas id="labCompletionChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h4>Quiz Score Distribution</h4>
                                <canvas id="quizPerformanceChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h4>Content Progress Distribution</h4>
                                <canvas id="progressDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Student Analytics List -->
                    <div class="student-analytics-section">
                        <div class="section-header">
                            <h3>Individual Student Analytics</h3>
                            <div class="search-box">
                                <input type="text" id="studentSearchInput" placeholder="Search students..." class="form-input">
                                <i class="fas fa-search"></i>
                            </div>
                        </div>
                        <div id="studentsAnalyticsList" class="students-analytics-container">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i> Loading students...
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Published Courses Section -->
                <section id="published-courses-section" class="content-section">
                    <div class="section-header">
                        <h2>Published Courses</h2>
                        <p>Browse and manage published courses available for instantiation</p>
                        <div class="header-actions">
                            <select id="courseVisibilityFilter" onchange="filterPublishedCourses()">
                                <option value="all">All Courses</option>
                                <option value="public">Public Courses</option>
                                <option value="private">My Private Courses</option>
                            </select>
                        </div>
                    </div>
                    <div id="publishedCoursesContainer" class="courses-grid">
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i> Loading published courses...
                        </div>
                    </div>
                </section>

                <!-- Course Instances Section -->
                <section id="course-instances-section" class="content-section">
                    <div class="section-header">
                        <h2>Course Instances</h2>
                        <p>Manage scheduled course sessions and student enrollment</p>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="showCreateInstanceModal()">
                                <i class="fas fa-plus"></i> Create New Instance
                            </button>
                        </div>
                    </div>
                    
                    <div class="instances-filters">
                        <select id="instanceStatusFilter" onchange="filterInstances()">
                            <option value="all">All Instances</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <div class="search-box">
                            <input type="text" id="instanceSearch" placeholder="Search instances..." onkeyup="searchInstances()">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>

                    <div id="courseInstancesContainer" class="instances-grid">
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i> Loading course instances...
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Create Lab Modal -->
    <div id="createLabModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>Create Custom Lab</h3>
                <span class="close" onclick="closeCreateLabModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createLabForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="labTitle">Lab Title</label>
                            <input type="text" id="labTitle" name="title" required placeholder="e.g., Python Data Analysis Lab">
                        </div>
                        <div class="form-group">
                            <label for="labCourse">Course</label>
                            <select id="labCourse" name="course_id" required>
                                <option value="">Select a course...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="labDescription">Description</label>
                        <textarea id="labDescription" name="description" rows="3" placeholder="Describe the lab objectives and what students will learn..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="labDifficulty">Difficulty Level</label>
                            <select id="labDifficulty" name="difficulty">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="labDuration">Estimated Duration (minutes)</label>
                            <input type="number" id="labDuration" name="duration" min="15" max="300" value="60">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="labEnvironment">Environment Type</label>
                        <select id="labEnvironment" name="environment_type" onchange="updateEnvironmentOptions()">
                            <option value="programming">Programming Environment</option>
                            <option value="terminal">Terminal/Command Line</option>
                            <option value="web">Web Development</option>
                            <option value="data">Data Science</option>
                            <option value="security">Security/Penetration Testing</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="programmingLanguageGroup">
                        <label for="labLanguage">Programming Language</label>
                        <select id="labLanguage" name="language">
                            <option value="python">Python</option>
                            <option value="javascript">JavaScript</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                            <option value="c">C</option>
                            <option value="go">Go</option>
                            <option value="rust">Rust</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="labExercises">Lab Exercises (JSON format)</label>
                        <textarea id="labExercises" name="exercises" rows="10" placeholder='[
  {
    "id": 1,
    "title": "Exercise 1",
    "description": "Exercise description",
    "difficulty": "easy",
    "starterCode": "// Your code here",
    "solution": "// Solution code"
  }
]'></textarea>
                        <small class="form-help">Define exercises in JSON format. Use the template above as a guide.</small>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="labSandboxed" name="sandboxed" checked>
                            Enable Sandboxed Environment
                        </label>
                        <small class="form-help">Recommended for security. Students will have restricted access to system commands.</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Create Lab
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeCreateLabModal()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modern ES6 module system -->
    <!-- <script type="module" src="../js/main.js"></script> -->
    <script src="../js/lab-template.js"></script>
    <script src="../js/modules/course-video-manager.js"></script>

    <!-- Temporary fix: Load a simplified version that works with existing functionality -->
    <script type="module">
        // Import the configuration
        import { CONFIG } from './js/config.js';
        
        // Make CONFIG available globally
        window.CONFIG = CONFIG;
        
        // Simple course loading that matches the old system
        let userCourses = [];
        
        // Sidebar toggle function for mobile/zoom support
        function toggleSidebar() {
            const sidebar = document.querySelector('.dashboard-sidebar');
            if (sidebar) {
                sidebar.classList.toggle('show');
            }
        }
        
        // Define getCurrentUser function that was missing
        function getCurrentUser() {
            try {
                const userJson = localStorage.getItem('currentUser');
                if (userJson) {
                    return JSON.parse(userJson);
                }
                return null;
            } catch (error) {
                console.error('Error getting current user:', error);
                return null;
            }
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            
            """
            COMPREHENSIVE SESSION VALIDATION ON PAGE LOAD
            
            BUSINESS REQUIREMENT:
            When a user refreshes the instructor dashboard page after session expiry,
            they should be redirected to the home page, not stay on the dashboard
            with default 'instructor' name display.
            
            TECHNICAL IMPLEMENTATION:
            1. Check if user data exists in localStorage
            2. Validate session timestamps against timeout thresholds  
            3. Check if authentication token is present and valid
            4. Redirect to home page if any validation fails
            5. Prevent dashboard initialization for expired sessions
            
            WHY THIS PREVENTS THE BUG:
            - Previous code only checked if currentUser existed, not if session was valid
            - Expired sessions could still have currentUser data in localStorage
            - This led to dashboard loading with fallback 'instructor' name
            - Now we validate the complete session state before allowing access
            """
            
            // Check if user is logged in and session is valid
            const currentUser = getCurrentUser();
            const authToken = localStorage.getItem('authToken');
            const sessionStart = localStorage.getItem('sessionStart');
            const lastActivity = localStorage.getItem('lastActivity');
            
            // Validate complete session state
            if (!currentUser || !authToken || !sessionStart || !lastActivity) {
                console.log('Session invalid: Missing session data');
                window.location.href = '../index.html';
                return;
            }
            
            // Check session timeout (8 hours from start)
            const now = Date.now();
            const sessionAge = now - parseInt(sessionStart);
            const timeSinceActivity = now - parseInt(lastActivity);
            const SESSION_TIMEOUT = 8 * 60 * 60 * 1000; // 8 hours
            const INACTIVITY_TIMEOUT = 2 * 60 * 60 * 1000; // 2 hours
            
            if (sessionAge > SESSION_TIMEOUT || timeSinceActivity > INACTIVITY_TIMEOUT) {
                console.log('Session expired: Redirecting to home page');
                // Clear expired session data
                localStorage.removeItem('authToken');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('sessionStart');
                localStorage.removeItem('lastActivity');
                window.location.href = '../index.html';
                return;
            }
            
            
            // Add course form submission handler
            const courseForm = document.getElementById('courseForm');
            if (courseForm) {
                courseForm.addEventListener('submit', async function(e) {
                    e.preventDefault(); // Prevent default form submission
                    
                    // Get form data
                    const formData = new FormData(courseForm);
                    const courseData = {
                        title: formData.get('title'),
                        description: formData.get('description'),
                        category: formData.get('category'),
                        difficulty_level: formData.get('difficulty_level'),
                        estimated_duration: parseInt(formData.get('estimated_duration')),
                        duration_unit: formData.get('duration_unit'),
                        instructor_id: currentUser.id || 'current_user_id'
                    };
                    
                    
                    try {
                        const token = localStorage.getItem('authToken') || localStorage.getItem('token');
                        const response = await fetch(CONFIG.ENDPOINTS.COURSES, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(courseData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const courseId = result.course?.id || result.id;

                            // Upload videos if any were added
                            if (typeof window.uploadCourseVideos === 'function') {
                                try {
                                    await window.uploadCourseVideos(courseId);
                                    showNotification('Course and videos created successfully!', 'success');
                                } catch (videoError) {
                                    console.error('Error uploading videos:', videoError);
                                    showNotification('Course created but some videos failed to upload', 'warning');
                                }
                            } else {
                                showNotification('Course created successfully!', 'success');
                            }

                            // Clear videos list
                            if (typeof window.clearCourseVideos === 'function') {
                                window.clearCourseVideos();
                            }

                            // Reset form
                            courseForm.reset();

                            // Reload courses and show courses section
                            await loadUserCourses();
                            showSection('courses');
                        } else {
                            const error = await response.json();
                            console.error('Error creating course:', error);
                            showNotification(error.detail || 'Failed to create course', 'error');
                        }
                    } catch (error) {
                        console.error('Error creating course:', error);
                        showNotification('Failed to create course: ' + error.message, 'error');
                    }
                });
            }
            
            // Load courses using the old approach that works
            await loadUserCourses();
            
            // Restore previous view state or show courses by default
            await restoreViewState();
        });
        
        // Restore view state from localStorage after page refresh
        async function restoreViewState() {
            try {
                const savedView = localStorage.getItem('currentView');
                if (!savedView) {
                    showSection('courses');
                    return;
                }
                
                const viewState = JSON.parse(savedView);
                
                if (viewState.type === 'course-content' && viewState.courseId) {
                    // Restore course content view
                    const course = userCourses.find(c => c.id === viewState.courseId);
                    if (course) {
                        // Set flag to prevent state storage during restoration
                        window.isRestoring = true;
                        window.currentCourse = course;
                        await showCourseContentView(course);
                        window.isRestoring = false;
                    } else {
                        showSection('courses');
                    }
                } else if (viewState.type === 'section' && viewState.sectionName) {
                    // Restore regular section view
                    showSection(viewState.sectionName);
                } else {
                    showSection('courses');
                }
            } catch (error) {
                console.error('Error restoring view state:', error);
                showSection('courses');
            }
        }
        
        // Load courses function that works with the existing API
        async function loadUserCourses() {
            try {
                const token = localStorage.getItem('authToken') || localStorage.getItem('token');
                
                if (!token) {
                    console.error('No authentication token found');
                    return;
                }
                
                const response = await fetch(CONFIG.ENDPOINTS.COURSES, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                
                if (response.status === 401) {
                    console.error('Authentication failed - token may be expired');
                    showNotification('Session expired. Please log in again.', 'error');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('userEmail');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Handle different response formats
                    if (Array.isArray(data)) {
                        userCourses = data;
                    } else if (data.courses) {
                        userCourses = data.courses;
                    } else {
                        userCourses = [];
                    }
                    
                    // Ensure window.userCourses is updated for student dropdown
                    window.userCourses = userCourses;
                    
                    
                    // Update the UI immediately
                    updateCoursesDisplay();
                    
                    // Also update the overview section to show course count
                    updateOverviewStats();
                } else {
                    console.error('Failed to load courses:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    // Show error message to user
                    const errorMsg = `Failed to load courses (${response.status}): ${errorText}`;
                    showNotification(errorMsg, 'error');
                }
            } catch (error) {
                console.error('Error loading courses:', error);
                showNotification('Error loading courses: ' + error.message, 'error');
            }
        }
        
        // Update courses display
        function updateCoursesDisplay() {
            
            // Update sidebar course count
            const courseCount = document.getElementById('courseCount');
            if (courseCount) {
                courseCount.textContent = userCourses.length;
            }
            
            // Update courses list if it exists
            const coursesList = document.getElementById('courses-list');
            
            if (coursesList) {
                const coursesHTML = userCourses.map(course => `
                    <div class="course-card enhanced clickable" onclick="viewCourseDetails('${course.id}')" style="cursor: pointer;">
                        <div class="course-header">
                            <h3>${course.title}</h3>
                            <div class="course-status ${course.is_published ? 'published' : 'draft'}">
                                ${course.is_published ? 'Published' : 'Draft'}
                            </div>
                        </div>
                        <div class="course-body">
                            <p class="course-description">${course.description || 'No description available'}</p>
                            <div class="course-meta">
                                <span class="course-category"><i class="fas fa-tag"></i> ${course.category}</span>
                                <span class="course-level"><i class="fas fa-signal"></i> ${course.difficulty_level}</span>
                                <span class="course-duration"><i class="fas fa-clock"></i> ${course.estimated_duration} ${course.duration_unit || 'weeks'}</span>
                            </div>
                        </div>
                        <div class="course-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-danger" onclick="event.stopPropagation(); confirmDeleteCourse('${course.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('');
                
                coursesList.innerHTML = coursesHTML;
            }
        }
        
        // View course details - navigate to course content view
        function viewCourseDetails(courseId) {
            
            const course = userCourses.find(c => c.id === courseId);
            if (!course) {
                showNotification('Course not found', 'error');
                return;
            }
            
            // Store current course for content display
            window.currentCourse = course;
            
            // Store current state in localStorage for page refresh persistence (unless restoring)
            if (!window.isRestoring) {
                localStorage.setItem('currentView', JSON.stringify({
                    type: 'course-content',
                    courseId: course.id,
                    courseName: course.title
                }));
            }
            
            // Navigate to course content view
            showCourseContentView(course);
            
        }
        
        // Fetch course content from database
        async function fetchCourseContent(courseId) {
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                throw new Error('No authentication token');
            }
            
            try {
                // Fetch course content from all available endpoints
                const [syllabusResponse, slidesResponse, labsResponse, quizzesResponse] = await Promise.all([
                    fetch(`${CONFIG.ENDPOINTS.SYLLABUS(courseId)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${CONFIG.ENDPOINTS.SLIDES(courseId)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${CONFIG.ENDPOINTS.LAB_BY_COURSE(courseId)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${CONFIG.ENDPOINTS.QUIZZES(courseId)}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);
                
                // Process syllabus response - API returns {course_id, syllabus: {}}
                const syllabusData = syllabusResponse.ok ? await syllabusResponse.json() : null;
                const syllabus = syllabusData && syllabusData.syllabus ? syllabusData.syllabus : null;
                
                // Process slides response - API returns {course_id, slides: []}
                const slidesData = slidesResponse.ok ? await slidesResponse.json() : null;
                const slides = slidesData && slidesData.slides ? slidesData.slides : [];
                
                // Process quiz response - API returns {course_id, quizzes: []}
                const quizResponse = quizzesResponse.ok ? await quizzesResponse.json() : null;
                const quizzes = quizResponse && quizResponse.quizzes ? quizResponse.quizzes : [];
                
                const courseContent = {
                    syllabus: syllabus,
                    slides: slides,
                    labs: labsResponse.ok ? await labsResponse.json() : [],
                    quizzes: quizzes
                };
                
                return courseContent;
                
            } catch (error) {
                console.error('Error fetching course content:', error);
                return {
                    syllabus: null,
                    slides: [],
                    labs: [],
                    quizzes: []
                };
            }
        }
        
        // Load course content and refresh the content view
        async function loadCourseContent(courseId) {
            
            try {
                // Find the course in the loaded courses
                const courses = await loadUserCourses();
                const course = courses.find(c => c.id === courseId);
                
                if (course) {
                    // Show the course content view
                    await showCourseContentView(course);
                } else {
                    console.error('Course not found:', courseId);
                }
            } catch (error) {
                console.error('Error loading course content:', error);
            }
        }
        
        // Populate quiz list in the quiz pane
        async function populateQuizList(courseId, quizzes) {
            const quizListElement = document.getElementById(`quiz-list-${courseId}`);
            if (!quizListElement) {
                console.error(`Quiz list element not found for course ${courseId}`);
                return;
            }
            
            
            // Try to get quizzes from session first
            if (!quizzes) {
                if (window.currentCourseContent && window.currentCourseContent.quizzes) {
                    if (Array.isArray(window.currentCourseContent.quizzes)) {
                        quizzes = window.currentCourseContent.quizzes;
                    }
                }
            }
            
            // Load quizzes from API if not in session
            if (!quizzes || quizzes.length === 0) {
                try {
                    const response = await fetch(`${CONFIG.ENDPOINTS.QUIZ_GET_COURSE_QUIZZES(courseId)}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            quizzes = data.quizzes || [];
                        } else {
                            quizzes = [];
                        }
                    } else {
                        quizzes = [];
                    }
                } catch (error) {
                    console.error('Error loading quizzes:', error);
                    quizzes = [];
                }
            }
            
            
            if (!quizzes || quizzes.length === 0) {
                quizListElement.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-question-circle fa-2x"></i>
                        <p>No quizzes found</p>
                        <p class="text-muted">Generate or create quizzes to get started</p>
                    </div>
                `;
                return;
            }
            
            // Show quiz preview in the pane (first 3 quizzes)
            const previewQuizzes = quizzes.slice(0, 3);
            quizListElement.innerHTML = `
                <div class="quiz-preview-list">
                    ${previewQuizzes.map(quiz => `
                        <div class="quiz-preview-item">
                            <div class="quiz-preview-header">
                                <span class="quiz-preview-title">${quiz.title}</span>
                                <span class="quiz-preview-count">${quiz.questions.length} questions</span>
                            </div>
                            <div class="quiz-preview-topic">${quiz.topic}</div>
                        </div>
                    `).join('')}
                    ${quizzes.length > 3 ? `
                        <div class="quiz-preview-more">
                            <span>+${quizzes.length - 3} more quizzes</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Create quiz items from actual data
            let quizHtml = '';
            quizzes.forEach((quiz, index) => {
                const questionCount = quiz.questions ? quiz.questions.length : 0;
                const duration = quiz.duration || quiz.timeLimit || 'No limit';
                
                quizHtml += `
                    <div class="quiz-item" onclick="viewQuizDetails('${courseId}', ${index}); event.stopPropagation();">
                        <div class="quiz-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="quiz-info">
                            <div class="quiz-title">${quiz.title || `Quiz ${index + 1}`}</div>
                            <div class="quiz-meta">${questionCount} questions  ${duration}</div>
                        </div>
                    </div>
                `;
            });
            
            quizListElement.innerHTML = quizHtml;
        }
        
        // Show course content view with tabs
        async function showCourseContentView(course) {
            
            // Hide all sections first
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            // Update content section to show course-specific content
            const contentSection = document.getElementById('content-section');
            if (!contentSection) {
                console.error('Content section not found');
                return;
            }
            
            // Show the content section
            contentSection.classList.add('active');
            contentSection.style.display = 'block';
            
            // Fetch course content from database
            try {
                const courseContent = await fetchCourseContent(course.id);
                
                // Store course content globally for pane access
                window.currentCourseContent = courseContent;
                
            } catch (error) {
                console.error('Error fetching course content:', error);
                // Continue with basic course info if fetch fails
                window.currentCourseContent = {
                    syllabus: null,
                    slides: [],
                    labs: [],
                    quizzes: []
                };
            }
            
            // Update the content section with 4-pane layout
            contentSection.innerHTML = `
                <div class="section-header">
                    <div class="section-header-content">
                        <div class="header-title">
                            <h2>${course.title}</h2>
                            <p>${course.description || 'Course content and materials'}</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-primary" onclick="showCourseEditModal('${course.id}')">
                                <i class="fas fa-edit"></i> Edit Course
                            </button>
                                <i class="fas fa-arrow-left"></i> Back to Courses
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 4-Pane Layout -->
                <div class="course-panes-container">
                    <!-- Top Row -->
                    <div class="course-panes-row">
                        <!-- Enhanced Syllabus Pane (Top Left) -->
                        <div class="course-pane syllabus-pane" onclick="openSyllabusPane('${course.id}')">
                            <div class="pane-header">
                                <h3><i class="fas fa-book"></i> Syllabus</h3>
                                <div class="pane-actions">
                                    <button class="btn btn-sm btn-success" onclick="uploadSyllabusFile('${course.id}'); event.stopPropagation();" title="Upload Custom Syllabus">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="downloadSyllabus('${course.id}'); event.stopPropagation();" title="Download Syllabus">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="generateSyllabus('${course.id}'); event.stopPropagation();" title="AI Generate Syllabus">
                                        <i class="fas fa-magic"></i> Generate
                                    </button>
                                </div>
                            </div>
                            <div class="pane-content">
                                <div class="syllabus-preview">
                                    <div class="syllabus-info">
                                        <p><strong>Category:</strong> ${course.category}</p>
                                        <p><strong>Level:</strong> ${course.difficulty_level}</p>
                                        <p><strong>Duration:</strong> ${course.estimated_duration} weeks</p>
                                        <p><strong>Status:</strong> ${course.is_published ? 'Published' : 'Draft'}</p>
                                        <p><strong>Source:</strong> <span id="syllabus-source-${course.id}" class="badge badge-info">AI Generated</span></p>
                                    </div>
                                    <div class="syllabus-content">
                                        <h4>Course Description</h4>
                                        <p>${course.description || 'No description available'}</p>
                                        <div class="syllabus-status" id="syllabus-status-${course.id}">
                                            <small class="text-muted">Last updated: <span id="syllabus-updated-${course.id}">Never</span></small>
                                        </div>
                                        <div class="syllabus-actions">
                                            <button class="btn btn-sm btn-secondary" onclick="viewFullSyllabus('${course.id}'); event.stopPropagation();">
                                                <i class="fas fa-eye"></i> View Full
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="editSyllabus('${course.id}'); event.stopPropagation();">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Slides Pane (Top Right) -->
                        <div class="course-pane slides-pane" onclick="viewSlidesVertical('${course.id}')">
                            <div class="pane-header">
                                <h3><i class="fas fa-images"></i> Slides</h3>
                                <div class="pane-actions">
                                    <button class="btn btn-sm btn-success" onclick="uploadSlides('${course.id}'); event.stopPropagation();" title="Upload Slide Deck">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="uploadTemplate('${course.id}'); event.stopPropagation();" title="Upload Template">
                                        <i class="fas fa-palette"></i> Template
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="downloadSlides('${course.id}'); event.stopPropagation();" title="Download Slides">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="generateSlides('${course.id}'); event.stopPropagation();" title="AI Generate Slides">
                                        <i class="fas fa-magic"></i> Generate
                                    </button>
                                </div>
                            </div>
                            <div class="pane-content">
                                <div class="slides-preview">
                                    <div class="slides-stack">
                                        <div class="slide-thumbnail">
                                            <div class="slide-number">1</div>
                                            <div class="slide-content">Introduction</div>
                                        </div>
                                        <div class="slide-thumbnail">
                                            <div class="slide-number">2</div>
                                            <div class="slide-content">Getting Started</div>
                                        </div>
                                        <div class="slide-thumbnail">
                                            <div class="slide-number">3</div>
                                            <div class="slide-content">Practice</div>
                                        </div>
                                    </div>
                                    <div class="slides-status">
                                        <p><small><strong>Template:</strong> <span id="template-status-${course.id}" class="badge badge-secondary">Default</span></small></p>
                                        <p><small><strong>Slides:</strong> <span id="slides-count-${course.id}">3</span> slides</small></p>
                                        <p><small>Last updated: <span id="slides-updated-${course.id}">Never</span></small></p>
                                    </div>
                                    <div class="slides-actions">
                                        <button class="btn btn-sm btn-secondary" onclick="viewSlidesVertical('${course.id}'); event.stopPropagation();">
                                            <i class="fas fa-list"></i> List View
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="startSlideshow('${course.id}'); event.stopPropagation();">
                                            <i class="fas fa-play"></i> Slideshow
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="editSlides('${course.id}'); event.stopPropagation();">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom Row -->
                    <div class="course-panes-row">
                        <!-- Enhanced Labs Pane (Bottom Left) -->
                        <div class="course-pane labs-pane" onclick="openLabEnvironment('${course.id}')">
                            <div class="pane-header">
                                <h3><i class="fas fa-flask"></i> Labs</h3>
                                <div class="pane-actions">
                                    <button class="btn btn-sm btn-success" onclick="uploadCustomLab('${course.id}'); event.stopPropagation();" title="Upload Custom Lab">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="exportLabs('${course.id}'); event.stopPropagation();" title="Export Labs">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="refreshLabExercises('${course.id}'); event.stopPropagation();" title="Refresh exercises">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="createNewLab('${course.id}'); event.stopPropagation();" title="AI Generate Lab">
                                        <i class="fas fa-magic"></i> Generate
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="manageLabContainers('${course.id}'); event.stopPropagation();" title="Manage Lab Containers">
                                        <i class="fas fa-server"></i> Containers
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="createInstructorLab('${course.id}'); event.stopPropagation();" title="Create Instructor Lab">
                                        <i class="fas fa-play"></i> My Lab
                                    </button>
                                </div>
                            </div>
                            <div class="pane-content">
                                <div class="labs-preview">
                                    <div class="lab-environment-info">
                                        <div class="lab-widget">
                                            <i class="fas fa-code"></i>
                                            <span>Code Editor</span>
                                        </div>
                                        <div class="lab-widget">
                                            <i class="fas fa-terminal"></i>
                                            <span>Terminal</span>
                                        </div>
                                        <div class="lab-widget">
                                            <i class="fas fa-robot"></i>
                                            <span>AI Assistant</span>
                                        </div>
                                        <div class="lab-widget">
                                            <i class="fas fa-tasks"></i>
                                            <span>Exercises</span>
                                        </div>
                                    </div>
                                    <div class="lab-status">
                                        <p><small><strong>Environment:</strong> <span id="lab-env-${course.id}" class="badge badge-success">Python 3.9</span></small></p>
                                        <p><small><strong>Exercises:</strong> <span id="lab-count-${course.id}">5</span> available</small></p>
                                        <p><small><strong>Source:</strong> <span id="lab-source-${course.id}" class="badge badge-info">AI Generated</span></small></p>
                                    </div>
                                    <div class="lab-actions">
                                        <button class="btn btn-sm btn-primary" onclick="startLabEnvironment('${course.id}'); event.stopPropagation();">
                                            <i class="fas fa-play"></i> Start Lab
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="viewLabExercises('${course.id}'); event.stopPropagation();">
                                            <i class="fas fa-list"></i> View All
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="configureLab('${course.id}'); event.stopPropagation();">
                                            <i class="fas fa-cog"></i> Configure
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Quizzes Pane (Bottom Right) -->
                        <div class="course-pane quizzes-pane" onclick="openQuizzesPane('${course.id}')">
                            <div class="pane-header">
                                <h3><i class="fas fa-question-circle"></i> Quizzes</h3>
                                <div class="pane-actions">
                                    <button class="btn btn-sm btn-success" onclick="uploadCustomQuiz('${course.id}'); event.stopPropagation();" title="Upload Custom Quiz">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="exportQuizzes('${course.id}'); event.stopPropagation();" title="Export Quizzes">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="generateQuizzes('${course.id}'); event.stopPropagation();" title="AI Generate Quizzes">
                                        <i class="fas fa-magic"></i> Generate
                                    </button>
                                </div>
                            </div>
                            <div class="pane-content">
                                <div class="quizzes-preview">
                                    <div class="quiz-stats">
                                        <p><small><strong>Total Questions:</strong> <span id="quiz-count-${course.id}">12</span></small></p>
                                        <p><small><strong>Question Types:</strong> <span id="quiz-types-${course.id}" class="badge badge-primary">Multiple Choice</span></small></p>
                                        <p><small><strong>Source:</strong> <span id="quiz-source-${course.id}" class="badge badge-info">AI Generated</span></small></p>
                                    </div>
                                    <div class="quiz-list" id="quiz-list-${course.id}">
                                        <!-- Dynamic quiz content will be loaded here -->
                                    </div>
                                    <div class="quiz-actions">
                                        <button class="btn btn-sm btn-secondary" onclick="viewAllQuizzes('${course.id}'); event.stopPropagation();">
                                            <i class="fas fa-list"></i> View All
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="editQuizzes('${course.id}'); event.stopPropagation();">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="previewQuiz('${course.id}'); event.stopPropagation();">
                                            <i class="fas fa-eye"></i> Preview
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            
            // Populate dynamic quiz content
            populateQuizList(course.id, window.currentCourseContent.quizzes);
            
            // Navigate to content section
            showSection('content');
        }
        
        // Show course edit modal
        function showCourseEditModal(courseId) {
            const course = userCourses.find(c => c.id === courseId);
            if (!course) {
                showNotification('Course not found', 'error');
                return;
            }
            
            // Create course edit modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content medium">
                    <div class="modal-header">
                        <h3><i class="fas fa-edit"></i> Edit Course Metadata</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editCourseForm">
                            <div class="form-group">
                                <label for="editCourseTitle">Course Title:</label>
                                <input type="text" id="editCourseTitle" name="title" required value="${course.title || ''}">
                            </div>
                            <div class="form-group">
                                <label for="editCourseDescription">Description:</label>
                                <textarea id="editCourseDescription" name="description" rows="3" placeholder="Enter course description...">${course.description || ''}</textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editCourseCategory">Category:</label>
                                    <select id="editCourseCategory" name="category">
                                        <option value="programming" ${course.category === 'programming' ? 'selected' : ''}>Programming</option>
                                        <option value="data-science" ${course.category === 'data-science' ? 'selected' : ''}>Data Science</option>
                                        <option value="web-development" ${course.category === 'web-development' ? 'selected' : ''}>Web Development</option>
                                        <option value="machine-learning" ${course.category === 'machine-learning' ? 'selected' : ''}>Machine Learning</option>
                                        <option value="cybersecurity" ${course.category === 'cybersecurity' ? 'selected' : ''}>Cybersecurity</option>
                                        <option value="cloud-computing" ${course.category === 'cloud-computing' ? 'selected' : ''}>Cloud Computing</option>
                                        <option value="other" ${course.category === 'other' ? 'selected' : ''}>Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="editCourseDifficulty">Difficulty Level:</label>
                                    <select id="editCourseDifficulty" name="difficulty_level">
                                        <option value="beginner" ${course.difficulty_level === 'beginner' ? 'selected' : ''}>Beginner</option>
                                        <option value="intermediate" ${course.difficulty_level === 'intermediate' ? 'selected' : ''}>Intermediate</option>
                                        <option value="advanced" ${course.difficulty_level === 'advanced' ? 'selected' : ''}>Advanced</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="editCourseDuration">Duration:</label>
                                    <div class="duration-input-group">
                                        <input type="number" id="editCourseDuration" name="estimated_duration" min="1" max="500" value="${course.estimated_duration || 1}">
                                        <select id="editCourseDurationUnit" name="duration_unit">
                                            <option value="hours" ${course.duration_unit === 'hours' ? 'selected' : ''}>Hours</option>
                                            <option value="days" ${course.duration_unit === 'days' ? 'selected' : ''}>Days</option>
                                            <option value="weeks" ${course.duration_unit === 'weeks' || !course.duration_unit ? 'selected' : ''}>Weeks</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="editCoursePublished">Publication Status:</label>
                                    <select id="editCoursePublished" name="is_published">
                                        <option value="false" ${!course.is_published ? 'selected' : ''}>Draft</option>
                                        <option value="true" ${course.is_published ? 'selected' : ''}>Published</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="updateCourseMetadata('${courseId}')">Save Changes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Update course metadata
        async function updateCourseMetadata(courseId) {
            const form = document.getElementById('editCourseForm');
            if (!form) return;
            
            const formData = new FormData(form);
            const courseData = {
                title: formData.get('title'),
                description: formData.get('description'),
                category: formData.get('category'),
                difficulty_level: formData.get('difficulty_level'),
                estimated_duration: parseInt(formData.get('estimated_duration')),
                duration_unit: formData.get('duration_unit'),
                is_published: formData.get('is_published') === 'true'
            };
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.COURSES}/${courseId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(courseData)
                });
                
                if (response.ok) {
                    showNotification('Course updated successfully', 'success');
                    
                    // Update local course data
                    const courseIndex = userCourses.findIndex(c => c.id === courseId);
                    if (courseIndex !== -1) {
                        userCourses[courseIndex] = { ...userCourses[courseIndex], ...courseData };
                    }
                    
                    // Update display
                    updateCoursesDisplay();
                    
                    // Close modal
                    document.querySelector('.modal-overlay').remove();
                    
                    // Refresh course content view if currently viewing this course
                    if (window.currentCourse && window.currentCourse.id === courseId) {
                        showCourseContentView(userCourses[courseIndex]);
                    }
                } else {
                    throw new Error('Failed to update course');
                }
            } catch (error) {
                console.error('Error updating course:', error);
                showNotification('Error updating course: ' + error.message, 'error');
            }
        }
        
        
        // Confirm delete course
        function confirmDeleteCourse(courseId) {
            
            const course = userCourses.find(c => c.id === courseId);
            if (!course) {
                showNotification('Course not found', 'error');
                return;
            }
            
            if (confirm(`Are you sure you want to delete "${course.title}"? This action cannot be undone.`)) {
                deleteCourse(courseId);
            }
        }
        
        // Delete course
        async function deleteCourse(courseId) {
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.COURSES}/${courseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showNotification('Course deleted successfully', 'success');
                    // Remove from local array
                    userCourses = userCourses.filter(c => c.id !== courseId);
                    // Ensure window.userCourses stays synchronized
                    window.userCourses = userCourses;
                    // Update display
                    updateCoursesDisplay();
                    updateOverviewStats();
                } else {
                    throw new Error('Failed to delete course');
                }
            } catch (error) {
                console.error('Error deleting course:', error);
                showNotification('Error deleting course: ' + error.message, 'error');
            }
        }
        
        // Update overview stats
        function updateOverviewStats() {
            
            // Update overview section
            const overviewSection = document.getElementById('overview-section');
            if (overviewSection) {
                const statsHTML = `
                    <h2>Dashboard Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>${userCourses.length}</h3>
                            <p>Courses</p>
                        </div>
                        <div class="stat-card">
                            <h3>0</h3>
                            <p>Students</p>
                        </div>
                        <div class="stat-card">
                            <h3>0</h3>
                            <p>Assignments</p>
                        </div>
                    </div>
                    <div class="courses-preview">
                        <h3>Recent Courses</h3>
                        ${userCourses.slice(0, 3).map(course => `
                            <div class="course-preview">
                                <strong>${course.title}</strong>
                                <p>${course.description}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                overviewSection.innerHTML = statsHTML;
            }
        }
        
        // Show notification function
        function showNotification(message, type = 'info') {
            // For now, just log to console. In a full implementation, this would show a toast or modal
        }
        
        // Progress notification for long-running operations
        function showProgressNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification progress-notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="notification-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            return {
                update: function(newMessage, newType = 'info') {
                    const iconElement = notification.querySelector('.notification-icon i');
                    const messageElement = notification.querySelector('.notification-message');
                    
                    notification.className = `notification progress-notification ${newType}`;
                    messageElement.textContent = newMessage;
                    
                    if (newType === 'success') {
                        iconElement.className = 'fas fa-check';
                    } else if (newType === 'error') {
                        iconElement.className = 'fas fa-times';
                    } else {
                        iconElement.className = 'fas fa-spinner fa-spin';
                    }
                },
                close: function() {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }
            };
        }
        
        // Simple showSection function for navigation
        window.showSection = function(sectionName) {
            if (sectionName === 'courses') {
            }
            
            // Store current view state for page refresh persistence (unless restoring)
            if (!window.isRestoring) {
                if (sectionName === 'courses') {
                    localStorage.setItem('currentView', JSON.stringify({
                        type: 'section',
                        sectionName: 'courses'
                    }));
                } else {
                    localStorage.setItem('currentView', JSON.stringify({
                        type: 'section',
                        sectionName: sectionName
                    }));
                }
            }
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none'; // Force hide to ensure clean state
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                // Force display for all sections due to CSS specificity issues
                targetSection.style.display = 'block';
                
                // If showing courses section, ensure courses are populated
                if (sectionName === 'courses') {
                    updateCoursesDisplay();
                }
                
                // If showing students section, populate course dropdown
                if (sectionName === 'students') {
                    populateStudentCourseDropdown();
                }
                
                // If showing published courses section, load published courses
                if (sectionName === 'published-courses') {
                    if (window.instructorDashboard) {
                        window.instructorDashboard.loadPublishedCourses();
                    }
                }
                
                // If showing course instances section, load course instances
                if (sectionName === 'course-instances') {
                    if (window.instructorDashboard) {
                        window.instructorDashboard.loadCourseInstances();
                    }
                }
                
                // Debug content section specifically
                if (sectionName === 'content') {
                }
            } else {
                console.error('Target section not found:', sectionName + '-section');
            }
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const activeNavLink = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeNavLink) {
                activeNavLink.classList.add('active');
            }
            
            // Update breadcrumb
            const breadcrumb = document.getElementById('currentSection');
            if (breadcrumb) {
                breadcrumb.textContent = sectionName.charAt(0).toUpperCase() + sectionName.slice(1).replace('-', ' ');
            }
        };
        
        // Pane interaction functions
        window.openSyllabusPane = function(courseId) {
            
            const syllabus = window.currentCourseContent?.syllabus;
            if (!syllabus) {
                showNotification('No syllabus found for this course', 'warning');
                return;
            }
            
            
            // Helper function to render prerequisites
            const renderPrerequisites = (prerequisites) => {
                if (!prerequisites || prerequisites.length === 0) {
                    return '<p><em>No prerequisites required</em></p>';
                }
                return `<ul>${prerequisites.map(prereq => `<li>${prereq}</li>`).join('')}</ul>`;
            };
            
            // Helper function to render modules
            const renderModules = (modules) => {
                if (!modules || modules.length === 0) {
                    return '<p><em>No modules available</em></p>';
                }
                
                return modules.map(module => `
                    <div class="syllabus-module">
                        <div class="module-header">
                            <h6>Module ${module.module_number}: ${module.title}</h6>
                            ${module.duration ? `<span class="module-duration">${module.duration} minutes</span>` : module.duration_hours ? `<span class="module-duration">${module.duration_hours} hours</span>` : ''}
                        </div>
                        <div class="module-description">
                            ${module.description || 'No description available'}
                        </div>
                        ${(module.objectives || module.learning_outcomes) && (module.objectives || module.learning_outcomes).length > 0 ? `
                            <div class="module-objectives">
                                <strong>Module Objectives:</strong>
                                <ul>
                                    ${(module.objectives || module.learning_outcomes).map(obj => `<li>${obj}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${module.topics && module.topics.length > 0 ? `
                            <div class="module-topics">
                                <strong>Topics:</strong>
                                <ul>
                                    ${module.topics.map(topic => {
                                        // Handle both string topics and object topics
                                        if (typeof topic === 'string') {
                                            return `<li>${topic}</li>`;
                                        } else {
                                            return `
                                                <li>
                                                    <strong>${topic.title}</strong>
                                                    ${topic.duration ? ` (${topic.duration} min)` : ''}
                                                    ${topic.description ? `<br><em>${topic.description}</em>` : ''}
                                                    ${topic.objectives && topic.objectives.length > 0 ? `
                                                        <ul>
                                                            ${topic.objectives.map(obj => `<li>${obj}</li>`).join('')}
                                                        </ul>
                                                    ` : ''}
                                                </li>
                                            `;
                                        }
                                    }).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            };
            
            // Create syllabus modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <h3><i class="fas fa-book"></i> Course Syllabus</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="syllabus-content">
                            <div class="syllabus-header">
                                <h4>${syllabus.title || 'Course Syllabus'}</h4>
                                <div class="syllabus-meta">
                                    ${syllabus.level ? `<span class="syllabus-level"><i class="fas fa-signal"></i> ${syllabus.level}</span>` : ''}
                                    ${syllabus.duration ? `<span class="syllabus-duration"><i class="fas fa-clock"></i> ${syllabus.duration} hours</span>` : ''}
                                </div>
                            </div>
                            
                            <div class="syllabus-overview">
                                <h5><i class="fas fa-info-circle"></i> Course Overview</h5>
                                <p>${syllabus.description || syllabus.overview || 'No description available'}</p>
                            </div>
                            
                            ${syllabus.target_audience ? `
                                <div class="syllabus-audience">
                                    <h5><i class="fas fa-users"></i> Target Audience</h5>
                                    <p>${syllabus.target_audience}</p>
                                </div>
                            ` : ''}
                            
                            <div class="syllabus-prerequisites">
                                <h5><i class="fas fa-check-circle"></i> Prerequisites</h5>
                                ${renderPrerequisites(syllabus.prerequisites)}
                            </div>
                            
                            <div class="syllabus-objectives">
                                <h5><i class="fas fa-bullseye"></i> Learning Objectives</h5>
                                ${(syllabus.objectives || []).length > 0 ? `
                                    <ul>
                                        ${syllabus.objectives.map(obj => `<li>${obj}</li>`).join('')}
                                    </ul>
                                ` : '<p><em>No learning objectives specified</em></p>'}
                            </div>
                            
                            <div class="syllabus-modules">
                                <h5><i class="fas fa-list-alt"></i> Course Modules</h5>
                                ${renderModules(syllabus.modules)}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        <button class="btn btn-outline-primary" onclick="generateSyllabus('${courseId}')">Regenerate</button>
                        <button class="btn btn-primary" onclick="showSyllabusRefinementModal('${courseId}')">Regenerate with Suggestions</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        window.generateSyllabus = async function(courseId) {
            
            const progressNotification = showProgressNotification('Generating syllabus with AI...', 'info');
            
            try {
                const token = localStorage.getItem('authToken');
                
                // Get course data from the current course
                const course = window.currentCourse;
                
                if (!course) {
                    throw new Error('Course data not available');
                }
                
                const payload = {
                    course_id: courseId,
                    title: course.title,
                    description: course.description || 'No description provided',
                    category: course.category || 'General',
                    difficulty_level: course.difficulty_level || 'beginner',
                    estimated_duration: course.estimated_duration || 4
                };
                
                
                const response = await fetch(`${CONFIG.ENDPOINTS.GENERATE_SYLLABUS}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update stored content
                    if (window.currentCourseContent) {
                        window.currentCourseContent.syllabus = result.syllabus;
                    }
                    
                    progressNotification.update('Syllabus generated successfully!', 'success');
                    
                    // Refresh the content view
                    setTimeout(() => {
                        progressNotification.close();
                        openSyllabusPane(courseId);
                    }, 1500);
                } else {
                    // Log error response details
                    console.error('API response error:', response.status, response.statusText);
                    try {
                        const errorData = await response.json();
                        console.error('API error details:', errorData);
                    } catch (jsonError) {
                        console.error('Failed to parse error response:', jsonError);
                    }
                    throw new Error(`Failed to generate syllabus: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('Error generating syllabus:', error);
                progressNotification.update('Error generating syllabus', 'error');
                setTimeout(() => progressNotification.close(), 3000);
            }
        };
        
        window.viewFullSyllabus = function(courseId) {
            openSyllabusPane(courseId);
        };
        
        window.showSyllabusRefinementModal = function(courseId) {
            
            const syllabus = window.currentCourseContent?.syllabus;
            if (!syllabus) {
                showNotification('No syllabus found for this course', 'warning');
                return;
            }
            
            // Create refinement modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <h3><i class="fas fa-edit"></i> Refine Syllabus</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="refinement-form">
                            <h4>Provide your suggestions to improve the syllabus:</h4>
                            <p class="help-text">Be specific about what you'd like to change, add, or improve. For example:</p>
                            <ul class="example-suggestions">
                                <li>Add more practical examples for Module 2</li>
                                <li>Include advanced topics in data structures</li>
                                <li>Extend the duration of the functions module</li>
                                <li>Add prerequisites for database concepts</li>
                                <li>Include hands-on projects for each module</li>
                            </ul>
                            <div class="form-group">
                                <label for="syllabusRefinementFeedback">Your Suggestions:</label>
                                <textarea id="syllabusRefinementFeedback" class="form-control" rows="6" 
                                    placeholder="Enter your suggestions for improving the syllabus..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="refineSyllabus('${courseId}')">Refine Syllabus</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus on the textarea
            setTimeout(() => {
                document.getElementById('syllabusRefinementFeedback').focus();
            }, 100);
        };
        
        window.refineSyllabus = async function(courseId) {
            
            const feedback = document.getElementById('syllabusRefinementFeedback').value.trim();
            if (!feedback) {
                showNotification('Please provide your suggestions before refining the syllabus', 'warning');
                return;
            }
            
            const syllabus = window.currentCourseContent?.syllabus;
            if (!syllabus) {
                showNotification('No syllabus found for this course', 'error');
                return;
            }
            
            const progressNotification = showProgressNotification('Refining syllabus with your suggestions...', 'info');
            
            try {
                const token = localStorage.getItem('authToken');
                
                const payload = {
                    course_id: courseId,
                    feedback: feedback,
                    current_syllabus: syllabus
                };
                
                
                const response = await fetch(`${CONFIG.ENDPOINTS.REFINE_SYLLABUS}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update stored content
                    if (window.currentCourseContent) {
                        window.currentCourseContent.syllabus = result.syllabus;
                    }
                    
                    progressNotification.update('Syllabus refined successfully!', 'success');
                    
                    // Close the refinement modal
                    document.querySelector('.modal-overlay').remove();
                    
                    // Refresh the syllabus view
                    setTimeout(() => {
                        progressNotification.close();
                        openSyllabusPane(courseId);
                    }, 1500);
                } else {
                    // Log error response details
                    console.error('API response error:', response.status, response.statusText);
                    try {
                        const errorData = await response.json();
                        console.error('Error response data:', errorData);
                    } catch (e) {
                        console.error('Could not parse error response as JSON');
                    }
                    throw new Error('Failed to refine syllabus');
                }
            } catch (error) {
                console.error('Error refining syllabus:', error);
                progressNotification.update('Error refining syllabus', 'error');
                setTimeout(() => progressNotification.close(), 3000);
            }
        };
        
        window.openSlidesPane = function(courseId) {
            
            // Ensure slides is always an array
            let slides = [];
            if (window.currentCourseContent && window.currentCourseContent.slides) {
                if (Array.isArray(window.currentCourseContent.slides)) {
                    slides = window.currentCourseContent.slides;
                } else {
                    console.warn('Slides data is not an array, using empty array');
                    slides = [];
                }
            }
            
            
            // Create slides modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <h3><i class="fas fa-images"></i> Course Slides</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="slides-content">
                            ${slides.length === 0 ? `
                                <div class="empty-state">
                                    <i class="fas fa-images fa-3x"></i>
                                    <h4>No slides found</h4>
                                    <p>Generate slides to get started</p>
                                    <button class="btn btn-primary" onclick="generateSlides('${courseId}')">Generate Slides</button>
                                </div>
                            ` : `
                                <div class="slides-grid">
                                    ${slides.map((slide, index) => `
                                        <div class="slide-thumbnail" data-slide-index="${index}">
                                            <div class="slide-number">${index + 1}</div>
                                            <div class="slide-content">
                                                <h5>${slide.title || 'Slide ' + (index + 1)}</h5>
                                                <div class="slide-preview">
                                                    ${slide.content ? slide.content.substring(0, 100) + '...' : 'No content'}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        <button class="btn btn-info" onclick="viewSlidesVertical('${courseId}')">Vertical View</button>
                        <button class="btn btn-success" onclick="startSlideshow('${courseId}')">Start Slideshow</button>
                        <button class="btn btn-primary" onclick="generateSlides('${courseId}')">Generate New</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        window.generateSlides = async function(courseId) {
            
            const progressNotification = showProgressNotification('Generating slides with AI...', 'info');
            
            try {
                const token = localStorage.getItem('authToken');
                
                // Get course data from the current course
                const course = window.currentCourse;
                
                if (!course) {
                    throw new Error('Course data not available');
                }
                
                const payload = {
                    course_id: courseId,
                    title: course.title,
                    description: course.description || 'No description provided',
                    topic: course.category || 'General'
                };
                
                
                const response = await fetch(`${CONFIG.ENDPOINTS.GENERATE_SLIDES}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update stored content
                    if (window.currentCourseContent) {
                        window.currentCourseContent.slides = result.slides || [];
                    }
                    
                    progressNotification.update('Slides generated successfully!', 'success');
                    
                    // Refresh the content view
                    setTimeout(() => {
                        progressNotification.close();
                        viewSlidesVertical(courseId);
                    }, 1500);
                } else {
                    // Log error response details
                    console.error('API response error:', response.status, response.statusText);
                    try {
                        const errorData = await response.json();
                        console.error('Error response data:', errorData);
                    } catch (e) {
                        console.error('Could not parse error response as JSON');
                    }
                    throw new Error('Failed to generate slides');
                }
            } catch (error) {
                console.error('Error generating slides:', error);
                progressNotification.update('Error generating slides', 'error');
                setTimeout(() => progressNotification.close(), 3000);
            }
        };
        
        window.viewSlidesVertical = function(courseId) {
            
            // Ensure slides is always an array
            let slides = [];
            if (window.currentCourseContent && window.currentCourseContent.slides) {
                if (Array.isArray(window.currentCourseContent.slides)) {
                    slides = window.currentCourseContent.slides;
                } else {
                    console.warn('Slides data is not an array, using empty array');
                    slides = [];
                }
            }
            
            
            if (slides.length === 0) {
                showNotification('No slides to display', 'warning');
                return;
            }
            
            // Create vertical slides modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content extra-large">
                    <div class="modal-header">
                        <h3><i class="fas fa-list"></i> Vertical Slides View</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="slides-stack">
                            ${slides.map((slide, index) => `
                                <div class="slide-item">
                                    <div class="slide-header">
                                        <span class="slide-number">${index + 1}</span>
                                        <h4>${slide.title || 'Slide ' + (index + 1)}</h4>
                                    </div>
                                    <div class="slide-body">
                                        ${(slide.content || 'No content available').replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        <button class="btn btn-outline-primary" onclick="this.closest('.modal-overlay').remove(); openSlidesPane('${courseId}')">Thumbnail View</button>
                        <button class="btn btn-primary" onclick="startSlideshow('${courseId}')">Start Slideshow</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        window.startSlideshow = function(courseId) {
            
            const slides = window.currentCourseContent?.slides || [];
            if (slides.length === 0) {
                showNotification('No slides to display', 'warning');
                return;
            }
            
            // HTML escape function
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Open slideshow in new window
            const slideshowWindow = window.open('', '_blank', 'width=1200,height=800,fullscreen=yes');
            
            // Create HTML document structure
            slideshowWindow.document.write('<!DOCTYPE html><html><head>');
            slideshowWindow.document.write('<title>Slideshow - Course ' + courseId + '</title>');
            slideshowWindow.document.write('<style>');
            slideshowWindow.document.write('body { margin: 0; font-family: Arial, sans-serif; background: #000; color: #fff; overflow: hidden; }');
            slideshowWindow.document.write('.slideshow-container { position: relative; width: 100%; height: 100vh; }');
            slideshowWindow.document.write('.slide { display: none; padding: 40px; text-align: center; position: absolute; width: calc(100% - 80px); height: calc(100% - 80px); }');
            slideshowWindow.document.write('.slide.active { display: block; }');
            slideshowWindow.document.write('.slide h1 { font-size: 3em; margin-bottom: 30px; }');
            slideshowWindow.document.write('.slide-content { font-size: 1.5em; line-height: 1.6; }');
            slideshowWindow.document.write('.slide-nav { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); }');
            slideshowWindow.document.write('.nav-btn { background: #333; color: #fff; border: none; padding: 10px 20px; margin: 0 10px; cursor: pointer; }');
            slideshowWindow.document.write('.nav-btn:hover { background: #555; }');
            slideshowWindow.document.write('.slide-counter { position: absolute; top: 20px; right: 20px; font-size: 1.2em; }');
            slideshowWindow.document.write('</style></head><body>');
            slideshowWindow.document.write('<div class="slideshow-container">');
            slideshowWindow.document.write('<div class="slide-counter">');
            slideshowWindow.document.write('<span id="currentSlide">1</span> / <span id="totalSlides">' + slides.length + '</span>');
            slideshowWindow.document.write('</div>');
            
            // Add slides
            slides.forEach((slide, index) => {
                slideshowWindow.document.write('<div class="slide ' + (index === 0 ? 'active' : '') + '">');
                slideshowWindow.document.write('<h1>' + escapeHtml(slide.title || 'Slide ' + (index + 1)) + '</h1>');
                slideshowWindow.document.write('<div class="slide-content">' + (slide.content || 'No content available').replace(/\n/g, '<br>') + '</div>');
                slideshowWindow.document.write('</div>');
            });
            
            slideshowWindow.document.write('<div class="slide-nav">');
            slideshowWindow.document.write('<button class="nav-btn" onclick="prevSlide()">Previous</button>');
            slideshowWindow.document.write('<button class="nav-btn" onclick="nextSlide()">Next</button>');
            slideshowWindow.document.write('<button class="nav-btn" onclick="window.close()">Close</button>');
            slideshowWindow.document.write('</div></div>');
            
            // Add JavaScript in separate script tag
            slideshowWindow.document.write('<' + 'script>');
            slideshowWindow.document.write('let currentSlideIndex = 0;');
            slideshowWindow.document.write('const slides = document.querySelectorAll(".slide");');
            slideshowWindow.document.write('function showSlide(index) {');
            slideshowWindow.document.write('    slides.forEach(slide => slide.classList.remove("active"));');
            slideshowWindow.document.write('    slides[index].classList.add("active");');
            slideshowWindow.document.write('    document.getElementById("currentSlide").textContent = index + 1;');
            slideshowWindow.document.write('}');
            slideshowWindow.document.write('function nextSlide() {');
            slideshowWindow.document.write('    currentSlideIndex = (currentSlideIndex + 1) % slides.length;');
            slideshowWindow.document.write('    showSlide(currentSlideIndex);');
            slideshowWindow.document.write('}');
            slideshowWindow.document.write('function prevSlide() {');
            slideshowWindow.document.write('    currentSlideIndex = (currentSlideIndex - 1 + slides.length) % slides.length;');
            slideshowWindow.document.write('    showSlide(currentSlideIndex);');
            slideshowWindow.document.write('}');
            slideshowWindow.document.write('document.addEventListener("keydown", function(e) {');
            slideshowWindow.document.write('    if (e.key === "ArrowRight" || e.keyCode === 32) nextSlide();');
            slideshowWindow.document.write('    if (e.key === "ArrowLeft") prevSlide();');
            slideshowWindow.document.write('    if (e.key === "Escape") window.close();');
            slideshowWindow.document.write('});');
            slideshowWindow.document.write('</' + 'script></body></html>');
            
            slideshowWindow.document.close();
        };
        
        window.openLabEnvironment = function(courseId) {
            
            const labs = window.currentCourseContent?.labs || [];
            
            // Create lab environment modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <h3><i class="fas fa-flask"></i> Lab Environment</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="lab-content">
                            ${labs.length === 0 ? `
                                <div class="empty-state">
                                    <i class="fas fa-flask fa-3x"></i>
                                    <h4>No labs configured</h4>
                                    <p>Create a lab environment to get started</p>
                                    <button class="btn btn-primary" onclick="createNewLab('${courseId}')">Create Lab</button>
                                </div>
                            ` : `
                                <div class="labs-grid">
                                    ${labs.map((lab, index) => `
                                        <div class="lab-widget" data-lab-index="${index}">
                                            <div class="lab-header">
                                                <h5>${lab.name || 'Lab ' + (index + 1)}</h5>
                                                <div class="lab-status ${lab.status || 'inactive'}">
                                                    ${lab.status || 'inactive'}
                                                </div>
                                            </div>
                                            <div class="lab-environment-info">
                                                <p><strong>Type:</strong> ${lab.type || 'Virtual Environment'}</p>
                                                <p><strong>Language:</strong> ${lab.language || 'Python'}</p>
                                                <p><strong>Tools:</strong> ${lab.tools ? lab.tools.join(', ') : 'VS Code, Terminal'}</p>
                                            </div>
                                            <div class="lab-actions">
                                                <button class="btn btn-sm btn-success" onclick="startLabEnvironment('${courseId}', '${index}')">
                                                    <i class="fas fa-play"></i> Start Lab
                                                </button>
                                                <button class="btn btn-sm btn-secondary" onclick="configureLab('${courseId}', '${index}')">
                                                    <i class="fas fa-cog"></i> Configure
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        <button class="btn btn-primary" onclick="createNewLab('${courseId}')">Create New Lab</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        window.createNewLab = function(courseId) {
            
            // Create lab creation modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content medium">
                    <div class="modal-header">
                        <h3><i class="fas fa-plus"></i> Create New Lab</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createLabForm">
                            <div class="form-group">
                                <label for="labName">Lab Name:</label>
                                <input type="text" id="labName" name="name" required placeholder="e.g., Python Basics Lab">
                            </div>
                            <div class="form-group">
                                <label for="labType">Environment Type:</label>
                                <select id="labType" name="type" required>
                                    <option value="python">Python Environment</option>
                                    <option value="javascript">JavaScript Environment</option>
                                    <option value="java">Java Environment</option>
                                    <option value="docker">Docker Container</option>
                                    <option value="web">Web Development</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="labDescription">Description:</label>
                                <textarea id="labDescription" name="description" rows="3" placeholder="Describe what students will learn..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="labTools">Tools & Software:</label>
                                <input type="text" id="labTools" name="tools" placeholder="VS Code, Terminal, Git (comma-separated)">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitLabCreation('${courseId}')">Create Lab</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        window.startLabEnvironment = function(courseId, labIndex = 0) {
            
            const progressNotification = showProgressNotification('Starting lab environment...', 'info');
            
            // Simulate lab startup
            setTimeout(() => {
                progressNotification.update('Lab environment ready!', 'success');
                
                // Open lab in new window with course information
                const labUrl = `lab.html?courseId=${courseId}&course=${encodeURIComponent(window.currentCourseContent?.title || 'Programming Course')}`;
                const labWindow = window.open(labUrl, '_blank', 'width=1400,height=900,resizable=yes,scrollbars=yes');
                
                if (labWindow) {
                    setTimeout(() => {
                        progressNotification.close();
                    }, 2000);
                } else {
                    progressNotification.update('Popup blocked. Please allow popups for this site.', 'error');
                    setTimeout(() => progressNotification.close(), 3000);
                }
            }, 2000);
        };
        
        window.configureLab = function(courseId, labIndex = 0) {
            
            const labs = window.currentCourseContent?.labs || [];
            const lab = labs[labIndex] || {};
            
            // Create lab configuration modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <h3><i class="fas fa-cog"></i> Configure Lab Environment</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="lab-config">
                            <div class="config-section">
                                <h4>Environment Settings</h4>
                                <div class="config-grid">
                                    <div class="config-item">
                                        <label>CPU Cores:</label>
                                        <select>
                                            <option value="1">1 Core</option>
                                            <option value="2" selected>2 Cores</option>
                                            <option value="4">4 Cores</option>
                                        </select>
                                    </div>
                                    <div class="config-item">
                                        <label>Memory:</label>
                                        <select>
                                            <option value="1">1 GB</option>
                                            <option value="2" selected>2 GB</option>
                                            <option value="4">4 GB</option>
                                            <option value="8">8 GB</option>
                                        </select>
                                    </div>
                                    <div class="config-item">
                                        <label>Storage:</label>
                                        <select>
                                            <option value="5">5 GB</option>
                                            <option value="10" selected>10 GB</option>
                                            <option value="20">20 GB</option>
                                        </select>
                                    </div>
                                    <div class="config-item">
                                        <label>Timeout:</label>
                                        <select>
                                            <option value="30">30 minutes</option>
                                            <option value="60" selected>1 hour</option>
                                            <option value="120">2 hours</option>
                                            <option value="240">4 hours</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="config-section">
                                <h4>Software & Tools</h4>
                                <div class="tools-checklist">
                                    <label><input type="checkbox" checked> VS Code</label>
                                    <label><input type="checkbox" checked> Terminal</label>
                                    <label><input type="checkbox" checked> Git</label>
                                    <label><input type="checkbox"> Docker</label>
                                    <label><input type="checkbox"> Node.js</label>
                                    <label><input type="checkbox"> Python</label>
                                    <label><input type="checkbox"> AI Assistant</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveLabConfiguration('${courseId}', '${labIndex}')">Save Configuration</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        window.openQuizzesPane = async function(courseId) {
            
            // First try to get quizzes from current session (generated quizzes)
            let quizzes = [];
            if (window.currentCourseContent && window.currentCourseContent.quizzes) {
                if (Array.isArray(window.currentCourseContent.quizzes)) {
                    quizzes = window.currentCourseContent.quizzes;
                }
            }
            
            // If no quizzes in session, try to load from API
            if (quizzes.length === 0) {
                const progressNotification = showProgressNotification('Loading quizzes...', 'info');
                
                try {
                    const response = await fetch(`${CONFIG.ENDPOINTS.QUIZ_GET_COURSE_QUIZZES(courseId)}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            quizzes = data.quizzes || [];
                        }
                    }
                    
                    progressNotification.close();
                } catch (error) {
                    console.error('Error loading quizzes:', error);
                    progressNotification.update('Error loading quizzes', 'error');
                    setTimeout(() => progressNotification.close(), 3000);
                }
            }
            
                
                // Create quizzes modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content large">
                        <div class="modal-header">
                            <h3><i class="fas fa-question-circle"></i> Course Quizzes</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="quizzes-content">
                                ${quizzes.length === 0 ? `
                                    <div class="empty-state">
                                        <i class="fas fa-question-circle fa-3x"></i>
                                        <h4>No quizzes found</h4>
                                        <p>Generate quizzes to get started</p>
                                        <button class="btn btn-primary" onclick="generateQuizzes('${courseId}'); this.closest('.modal-overlay').remove();">Generate Quizzes</button>
                                    </div>
                                ` : `
                                    <div class="quiz-list">
                                        ${quizzes.map((quiz, index) => `
                                            <div class="quiz-item" onclick="selectQuizItem('${quiz.id}', '${courseId}', ${index})" data-quiz-id="${quiz.id}">
                                                <div class="quiz-header">
                                                    <h5 class="quiz-title">${quiz.title || 'Quiz ' + (index + 1)}</h5>
                                                    <div class="quiz-stats">
                                                        <span class="question-count">${quiz.questions ? quiz.questions.length : 0} questions</span>
                                                        <span class="quiz-difficulty ${quiz.difficulty || 'medium'}">${quiz.difficulty || 'Medium'}</span>
                                                    </div>
                                                </div>
                                                <div class="quiz-preview">
                                                    <p>${quiz.topic || 'No topic specified'}</p>
                                                </div>
                                                <div class="quiz-actions" style="display: none;">
                                                    <button class="btn btn-sm btn-primary" onclick="previewQuiz('${quiz.id}'); event.stopPropagation();">
                                                        <i class="fas fa-eye"></i> Preview
                                                    </button>
                                                    <button class="btn btn-sm btn-success" onclick="viewQuizResults('${quiz.id}'); event.stopPropagation();">
                                                        <i class="fas fa-chart-bar"></i> Results
                                                    </button>
                                                    <button class="btn btn-sm btn-secondary" onclick="openQuizForStudents('${quiz.id}'); event.stopPropagation();">
                                                        <i class="fas fa-external-link-alt"></i> Open
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            <button class="btn btn-primary" onclick="generateQuizzes('${courseId}')">Generate New</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
        };
        
        window.generateQuizzes = async function(courseId) {
            
            const progressNotification = showProgressNotification('Generating quizzes with AI...', 'info');
            
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${CONFIG.ENDPOINTS.QUIZ_GENERATE_FOR_COURSE}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        course_id: courseId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update stored content
                    if (window.currentCourseContent) {
                        window.currentCourseContent.quizzes = result.quizzes || [];
                        // Refresh the quiz list display
                        populateQuizList(courseId, window.currentCourseContent.quizzes);
                    }
                    
                    progressNotification.update('Quizzes generated successfully!', 'success');
                    
                    // Refresh the content view
                    setTimeout(() => {
                        progressNotification.close();
                        openQuizzesPane(courseId);
                    }, 1500);
                } else {
                    throw new Error('Failed to generate quizzes');
                }
            } catch (error) {
                console.error('Error generating quizzes:', error);
                progressNotification.update('Error generating quizzes', 'error');
                setTimeout(() => progressNotification.close(), 3000);
            }
        };
        
        window.viewAllQuizzes = function(courseId) {
            
            // Ensure quizzes is always an array - this fixes the "quizzes.map is not a function" error
            let quizzes = [];
            if (window.currentCourseContent && window.currentCourseContent.quizzes) {
                if (Array.isArray(window.currentCourseContent.quizzes)) {
                    quizzes = window.currentCourseContent.quizzes;
                } else {
                    console.warn('Quizzes data is not an array, defaulting to empty array:', window.currentCourseContent.quizzes);
                    quizzes = [];
                }
            }
            if (quizzes.length === 0) {
                showNotification('No quizzes to display', 'warning');
                return;
            }
            
            // Create comprehensive quiz view modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content extra-large">
                    <div class="modal-header">
                        <h3><i class="fas fa-list"></i> All Quizzes</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="quizzes-detailed">
                            ${quizzes.map((quiz, index) => `
                                <div class="quiz-detail-item">
                                    <div class="quiz-detail-header">
                                        <h4>${quiz.title || 'Quiz ' + (index + 1)}</h4>
                                        <span class="quiz-difficulty ${quiz.difficulty || 'medium'}">${quiz.difficulty || 'Medium'}</span>
                                    </div>
                                    <div class="quiz-detail-content">
                                        <p><strong>Description:</strong> ${quiz.description || 'No description'}</p>
                                        <p><strong>Questions:</strong> ${quiz.questions ? quiz.questions.length : 0}</p>
                                        <p><strong>Time Limit:</strong> ${quiz.timeLimit || 'No limit'}</p>
                                        <div class="quiz-questions">
                                            ${quiz.questions ? quiz.questions.map((q, qIndex) => `
                                                <div class="question-preview">
                                                    <h6>Question ${qIndex + 1}: ${q.question}</h6>
                                                    <div class="question-options">
                                                        ${q.options ? q.options.map((option, oIndex) => `
                                                            <div class="option ${oIndex === q.correctAnswer ? 'correct' : ''}">
                                                                ${String.fromCharCode(65 + oIndex)}. ${option}
                                                            </div>
                                                        `).join('') : ''}
                                                    </div>
                                                </div>
                                            `).join('') : '<p>No questions available</p>'}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        <button class="btn btn-primary" onclick="createQuiz('${courseId}')">Create New Quiz</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        window.createQuiz = function(courseId) {
            
            // Create quiz creation modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <h3><i class="fas fa-plus"></i> Create New Quiz</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createQuizForm">
                            <div class="form-group">
                                <label for="quizTitle">Quiz Title:</label>
                                <input type="text" id="quizTitle" name="title" required placeholder="e.g., Python Basics Assessment">
                            </div>
                            <div class="form-group">
                                <label for="quizDescription">Description:</label>
                                <textarea id="quizDescription" name="description" rows="2" placeholder="Brief description of the quiz..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quizDifficulty">Difficulty:</label>
                                    <select id="quizDifficulty" name="difficulty">
                                        <option value="easy">Easy</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="quizTimeLimit">Time Limit (minutes):</label>
                                    <input type="number" id="quizTimeLimit" name="timeLimit" min="1" max="120" value="30">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="questionCount">Number of Questions:</label>
                                <input type="number" id="questionCount" name="questionCount" min="1" max="50" value="10">
                            </div>
                            <div class="form-group">
                                <label for="quizTopics">Topics to Cover:</label>
                                <textarea id="quizTopics" name="topics" rows="3" placeholder="List topics separated by commas..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitQuizCreation('${courseId}')">Create Quiz</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Helper functions for form submissions
        window.submitLabCreation = function(courseId) {
            
            const form = document.getElementById('createLabForm');
            if (!form) {
                console.error('Lab creation form not found');
                return;
            }
            
            const formData = new FormData(form);
            const labData = {
                name: formData.get('name'),
                type: formData.get('type'),
                description: formData.get('description'),
                tools: formData.get('tools')?.split(',').map(t => t.trim()).filter(Boolean) || []
            };
            
            
            // Close modal
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
            
            // Add to current course content
            if (window.currentCourseContent) {
                if (!window.currentCourseContent.labs) {
                    window.currentCourseContent.labs = [];
                }
                window.currentCourseContent.labs.push(labData);
            }
            
            showNotification('Lab created successfully!', 'success');
        };
        
        window.saveLabConfiguration = function(courseId, labIndex) {
            
            // Get configuration values from the modal
            const modal = document.querySelector('.modal-overlay');
            if (!modal) return;
            
            const configData = {
                cpu: modal.querySelector('select[value="2"]')?.value || '2',
                memory: modal.querySelector('select[value="2"]')?.value || '2',
                storage: modal.querySelector('select[value="10"]')?.value || '10',
                timeout: modal.querySelector('select[value="60"]')?.value || '60',
                tools: Array.from(modal.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.nextSibling.textContent.trim())
            };
            
            
            // Close modal
            modal.remove();
            
            showNotification('Lab configuration saved!', 'success');
        };
        
        window.refreshLabExercises = async function(courseId) {
            
            const progressNotification = showProgressNotification('Refreshing lab exercises...', 'info');
            
            try {
                const token = localStorage.getItem('authToken');
                
                // Fallback URL if CONFIG is not available
                const refreshUrl = CONFIG?.ENDPOINTS?.REFRESH_LAB_EXERCISES || 'http://176.9.99.103:8001/lab/refresh-exercises';
                
                const response = await fetch(refreshUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        course_id: courseId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success) {
                        // Update stored exercises
                        if (window.currentCourseContent) {
                            window.currentCourseContent.exercises = result.exercises;
                        }
                        
                        progressNotification.update(`Successfully refreshed ${result.exercises.length} exercises!`, 'success');
                        
                        // Close any open modals
                        const modals = document.querySelectorAll('.modal-overlay');
                        modals.forEach(modal => modal.remove());
                        
                        // Refresh the content view after a short delay
                        setTimeout(() => {
                            loadCourseContent(courseId);
                        }, 1500);
                    } else {
                        progressNotification.update(result.message || 'Failed to refresh exercises', 'error');
                    }
                } else {
                    console.error('HTTP Error:', response.status, response.statusText);
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        console.error('Could not parse error response as JSON:', e);
                        const errorText = await response.text();
                        console.error('Error response text:', errorText);
                        errorMessage = `Server returned: ${response.status} ${response.statusText}`;
                    }
                    
                    progressNotification.update(`Error: ${errorMessage}`, 'error');
                }
            } catch (error) {
                console.error('Error refreshing lab exercises:', error);
                progressNotification.update(`Error refreshing exercises: ${error.message}`, 'error');
            }
        };
        
        window.submitQuizCreation = function(courseId) {
            
            const form = document.getElementById('createQuizForm');
            if (!form) {
                console.error('Quiz creation form not found');
                return;
            }
            
            const formData = new FormData(form);
            const quizData = {
                title: formData.get('title'),
                description: formData.get('description'),
                difficulty: formData.get('difficulty'),
                timeLimit: formData.get('timeLimit'),
                questionCount: formData.get('questionCount'),
                topics: formData.get('topics')?.split(',').map(t => t.trim()).filter(Boolean) || []
            };
            
            
            // Close modal
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
            
            // Add to current course content
            if (window.currentCourseContent) {
                if (!window.currentCourseContent.quizzes) {
                    window.currentCourseContent.quizzes = [];
                }
                window.currentCourseContent.quizzes.push(quizData);
                // Refresh the quiz list display
                populateQuizList(courseId, window.currentCourseContent.quizzes);
            }
            
            showNotification('Quiz created successfully!', 'success');
        };
        
        // Additional quiz functions
        window.viewQuizDetails = function(courseId, quizIndex) {
            
            // Ensure quizzes is always an array - this fixes the "quizzes.map is not a function" error
            let quizzes = [];
            if (window.currentCourseContent && window.currentCourseContent.quizzes) {
                if (Array.isArray(window.currentCourseContent.quizzes)) {
                    quizzes = window.currentCourseContent.quizzes;
                } else {
                    console.warn('Quizzes data is not an array, defaulting to empty array:', window.currentCourseContent.quizzes);
                    quizzes = [];
                }
            }
            const quiz = quizzes[quizIndex];
            
            if (!quiz) {
                showNotification('Quiz not found', 'error');
                return;
            }
            
            // Open quiz in preview mode instead of showing details
            if (quiz.id) {
                window.open(`quiz.html?quizId=${quiz.id}&userType=instructor`, '_blank');
                return;
            }
            
            // Create detailed quiz view modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <h3><i class="fas fa-eye"></i> Quiz Details</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="quiz-details">
                            <h4>${quiz.title}</h4>
                            <p><strong>Description:</strong> ${quiz.description || 'No description'}</p>
                            <p><strong>Difficulty:</strong> ${quiz.difficulty || 'Medium'}</p>
                            <p><strong>Time Limit:</strong> ${quiz.timeLimit || 'No limit'} minutes</p>
                            <p><strong>Topics:</strong> ${quiz.topics ? quiz.topics.join(', ') : 'None specified'}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        <button class="btn btn-primary" onclick="editQuiz('${courseId}', '${quizIndex}')">Edit Quiz</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        window.editQuiz = function(courseId, quizIndex) {
            showNotification('Quiz editing functionality coming soon', 'info');
        };
        
        window.previewQuizOld = function(courseId, quizIndex) {
            showNotification('Quiz preview functionality coming soon', 'info');
        };
        
        // Make functions available globally
        window.loadUserCourses = loadUserCourses;
        window.userCourses = userCourses;
        window.viewCourseDetails = viewCourseDetails;
        window.showCourseContentView = showCourseContentView;
        window.showCourseEditModal = showCourseEditModal;
        window.updateCourseMetadata = updateCourseMetadata;
        window.confirmDeleteCourse = confirmDeleteCourse;
        window.deleteCourse = deleteCourse;
        window.updateCoursesDisplay = updateCoursesDisplay;
        
        // Debug: Log that functions are available
        
        // Add missing functions to prevent errors
        window.toggleAccountDropdown = function() {
            const dropdown = document.getElementById('accountDropdown');
            const menu = document.getElementById('accountMenu');
            
            if (dropdown && menu) {
                // Toggle the open class on the dropdown container
                dropdown.classList.toggle('open');
                
                // Toggle the show class on the menu
                menu.classList.toggle('show');
                
            }
        };
        
        window.showProfileModal = function() {
            alert('Profile modal not implemented yet');
        };
        
        window.showSettingsModal = function() {
            alert('Settings modal not implemented yet');
        };
        
        window.showHelpModal = function() {
            alert('Help modal not implemented yet');
        };
        
        window.logout = function() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userEmail');
            window.location.href = 'index.html';
        };
        
        window.viewAnalytics = function() {
            showSection('analytics');
        };
        
        window.resetForm = function() {
            // Reset any forms on the page
            document.querySelectorAll('form').forEach(form => form.reset());
        };
        
        window.populateStudentCourseDropdown = async function() {
            const dropdown = document.getElementById('selectedCourse');
            
            try {
                // Clear existing options except the placeholder
                dropdown.innerHTML = '<option value="">Select a course...</option>';
                
                // Use the same courses data that's already loaded
                if (window.userCourses && window.userCourses.length > 0) {
                    window.userCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.title;
                        dropdown.appendChild(option);
                    });
                } else {
                    // If no courses are loaded, try to load them
                    await loadUserCourses();
                    if (window.userCourses && window.userCourses.length > 0) {
                        window.userCourses.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course.id;
                            option.textContent = course.title;
                            dropdown.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error populating student course dropdown:', error);
            }
        };

        window.loadCourseStudents = function() {
            // Implement student loading logic
            const selectedCourse = document.getElementById('selectedCourse').value;
            if (selectedCourse) {
            }
        };
        
        window.loadCourseLabs = function() {
            // Implement lab loading logic
            const selectedCourse = document.getElementById('labCourseSelect').value;
            if (selectedCourse) {
            }
        };
        
        window.filterQuizzes = function() {
            // Implement quiz filtering logic
            const courseFilter = document.getElementById('quizCourseFilter').value;
            const difficultyFilter = document.getElementById('quizDifficultyFilter').value;
        };
        
        window.showContentTab = function(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked tab
            const activeTab = document.querySelector(`[onclick="showContentTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        };
        
        window.showLabTab = function(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked tab
            const activeTab = document.querySelector(`[onclick="showLabTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        };
        
        window.openContentUploadModal = function() {
            alert('Content upload modal not implemented yet');
        };
        
        window.openCreateLabModal = function() {
            
            // Remove any existing modals to prevent stacking
            document.querySelectorAll('.modal').forEach(modal => {
                modal.remove();
            });
            
            // Get the existing modal from the HTML
            const modal = document.getElementById('createLabModal');
            if (modal) {
                modal.style.display = 'block';
            } else {
                console.error('Create Lab Modal not found in DOM');
            }
        };
        
        window.closeCreateLabModal = function() {
            const modal = document.getElementById('createLabModal');
            if (modal) {
                modal.style.display = 'none';
                
                // Clear form data
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
            }
        };
        
        // Add click outside to close modal functionality
        document.addEventListener('click', function(event) {
            // Close any dynamically created modals when clicking outside
            if (event.target.classList.contains('modal')) {
                event.target.remove();
            }
            
            // Close create lab modal when clicking outside
            const createLabModal = document.getElementById('createLabModal');
            if (createLabModal && event.target === createLabModal) {
                closeCreateLabModal();
            }
        });
        
        window.filterCourses = function() {
            // Implement course filtering logic
        };
        
        window.searchCourses = function() {
            // Implement course search logic
        };
        
        // Add click-outside handler to close dropdown
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('accountDropdown');
            const menu = document.getElementById('accountMenu');
            
            if (dropdown && menu) {
                // Check if the click was outside the dropdown
                if (!dropdown.contains(event.target)) {
                    dropdown.classList.remove('open');
                    menu.classList.remove('show');
                }
            }
        });
        
        // Add any other missing functions as needed
        
        // Quiz Management Functions
        async function generateQuizzesForCourse() {
            
            // Get selected course
            const courseSelector = document.getElementById('courseSelector');
            const courseId = courseSelector ? courseSelector.value : null;
            
            if (!courseId) {
                showNotification('Please select a course first', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.QUIZ_GENERATE_FOR_COURSE}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ course_id: courseId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Store quizzes in session
                        if (!window.currentCourseContent) {
                            window.currentCourseContent = {};
                        }
                        window.currentCourseContent.quizzes = data.quizzes || [];
                        
                        showNotification(`Generated ${data.generated_quizzes} quizzes successfully!`, 'success');
                        loadQuizzesForCourse(courseId);
                    } else {
                        showNotification(data.message || 'Failed to generate quizzes', 'error');
                    }
                } else {
                    showNotification('Failed to generate quizzes', 'error');
                }
            } catch (error) {
                console.error('Error generating quizzes:', error);
                showNotification('Error generating quizzes', 'error');
            }
        }
        
        async function createCustomQuiz() {
            const courseSelector = document.getElementById('courseSelector');
            const courseId = courseSelector ? courseSelector.value : null;
            
            if (!courseId) {
                showNotification('Please select a course first', 'error');
                return;
            }
            
            const topic = prompt('Enter quiz topic:');
            if (!topic) return;
            
            const difficulty = prompt('Enter difficulty level (beginner/intermediate/advanced):') || 'beginner';
            const questionCount = parseInt(prompt('Enter number of questions (5-20):') || '10');
            
            if (questionCount < 5 || questionCount > 20) {
                showNotification('Question count must be between 5 and 20', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.QUIZ_GENERATE}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        course_id: courseId,
                        topic: topic,
                        difficulty: difficulty,
                        question_count: questionCount,
                        difficulty_level: difficulty,
                        instructor_context: {},
                        student_tracking: {}
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification('Custom quiz created successfully!', 'success');
                        loadQuizzesForCourse(courseId);
                    } else {
                        showNotification(data.message || 'Failed to create custom quiz', 'error');
                    }
                } else {
                    showNotification('Failed to create custom quiz', 'error');
                }
            } catch (error) {
                console.error('Error creating custom quiz:', error);
                showNotification('Error creating custom quiz', 'error');
            }
        }
        
        async function loadQuizzesForCourse(courseId) {
            if (!courseId) return;
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.QUIZ_GET_COURSE_QUIZZES(courseId)}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayQuizzes(data.quizzes || []);
                    } else {
                        displayQuizzes([]);
                    }
                } else {
                    console.error('Failed to load quizzes');
                    displayQuizzes([]);
                }
            } catch (error) {
                console.error('Error loading quizzes:', error);
                displayQuizzes([]);
            }
        }
        
        function displayQuizzes(quizzes) {
            const quizzesGrid = document.getElementById('quizzesGrid');
            
            if (quizzes.length === 0) {
                quizzesGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-question-circle fa-3x"></i>
                        <h3>No Quizzes Available</h3>
                        <p>Generate quizzes for your courses or create custom assessments</p>
                        <button class="btn btn-primary" onclick="generateQuizzesForCourse()">
                            <i class="fas fa-magic"></i> Generate Your First Quiz
                        </button>
                    </div>
                `;
                return;
            }
            
            quizzesGrid.innerHTML = `
                <div class="quiz-grid">
                    ${quizzes.map(quiz => `
                        <div class="quiz-card">
                            <div class="quiz-header">
                                <h3 class="quiz-title">${quiz.title}</h3>
                                <span class="quiz-badge difficulty-${quiz.difficulty}">${quiz.difficulty}</span>
                            </div>
                            <div class="quiz-content">
                                <div class="quiz-meta">
                                    <span class="quiz-topic">${quiz.topic}</span>
                                    <span class="quiz-questions">${quiz.questions.length} questions</span>
                                </div>
                                <div class="quiz-description">
                                    <p>Auto-generated quiz covering ${quiz.topic} topics</p>
                                </div>
                            </div>
                            <div class="quiz-actions">
                                <button class="btn btn-sm btn-primary" onclick="previewQuiz('${quiz.id}')">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button class="btn btn-sm btn-success" onclick="viewQuizResults('${quiz.id}')">
                                    <i class="fas fa-chart-bar"></i> Results
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="openQuizForStudents('${quiz.id}')">
                                    <i class="fas fa-external-link-alt"></i> Open
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        window.previewQuiz = function(quizId) {
            window.open(`quiz.html?quizId=${quizId}&userType=instructor`, '_blank');
        };
        
        window.openQuizForStudents = function(quizId) {
            window.open(`quiz.html?quizId=${quizId}&userType=student`, '_blank');
        };

        // Quiz Management Functions for Publishing/Unpublishing
        window.editQuizzes = function(courseId) {
            showQuizPublicationManagement(courseId);
        };

        window.showQuizPublicationManagement = async function(courseId) {
            try {
                // Get course instances for the course
                const instancesResponse = await fetch(`${CONFIG.BASE_URL}/courses/${courseId}/instances`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!instancesResponse.ok) {
                    throw new Error('Failed to load course instances');
                }
                
                const instancesData = await instancesResponse.json();
                const instances = instancesData.instances || [];
                
                // Create quiz management modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay quiz-management-modal';
                modal.innerHTML = `
                    <div class="modal-content extra-large">
                        <div class="modal-header">
                            <h3><i class="fas fa-cogs"></i> Quiz Publication Management</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="quiz-management-container">
                                ${instances.length === 0 ? `
                                    <div class="empty-state">
                                        <i class="fas fa-calendar-times fa-3x"></i>
                                        <h4>No Course Instances</h4>
                                        <p>Create course instances to manage quiz publications</p>
                                        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove(); showInstantiate('${courseId}');">
                                            <i class="fas fa-plus"></i> Create Instance
                                        </button>
                                    </div>
                                ` : `
                                    <div class="instance-tabs">
                                        ${instances.map((instance, index) => `
                                            <button class="tab-btn ${index === 0 ? 'active' : ''}" 
                                                    onclick="showInstanceQuizManagement('${instance.id}', this)">
                                                <div class="tab-content">
                                                    <div class="instance-name">${instance.instance_name}</div>
                                                    <div class="instance-dates">${new Date(instance.start_date).toLocaleDateString()} - ${new Date(instance.end_date).toLocaleDateString()}</div>
                                                    <div class="instance-status ${instance.status}">${instance.status}</div>
                                                </div>
                                            </button>
                                        `).join('')}
                                    </div>
                                    <div class="instance-quiz-content" id="instance-quiz-content">
                                        <div class="loading-spinner">
                                            <i class="fas fa-spinner fa-spin"></i> Loading quiz publications...
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            <button class="btn btn-primary" onclick="refreshQuizPublications()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Load first instance quiz management if instances exist
                if (instances.length > 0) {
                    showInstanceQuizManagement(instances[0].id, modal.querySelector('.tab-btn'));
                }
                
            } catch (error) {
                console.error('Error showing quiz management:', error);
                showNotification('Error loading quiz management', 'error');
            }
        };

        window.showInstanceQuizManagement = async function(instanceId, tabElement) {
            try {
                // Update active tab
                document.querySelectorAll('.quiz-management-modal .tab-btn').forEach(btn => btn.classList.remove('active'));
                tabElement.classList.add('active');
                
                const contentDiv = document.getElementById('instance-quiz-content');
                contentDiv.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
                
                // Fetch quiz publications for this instance
                const response = await fetch(`${CONFIG.BASE_URL}/course-instances/${instanceId}/quiz-publications`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load quiz publications');
                }
                
                const data = await response.json();
                const publications = data.quiz_publications || [];
                
                if (publications.length === 0) {
                    contentDiv.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-question-circle fa-3x"></i>
                            <h4>No Quizzes Available</h4>
                            <p>Generate quizzes for this course to enable publication management</p>
                        </div>
                    `;
                    return;
                }
                
                // Render quiz publications table
                contentDiv.innerHTML = `
                    <div class="quiz-publications-header">
                        <h4>Quiz Publications for Instance</h4>
                        <div class="header-actions">
                            <button class="btn btn-sm btn-success" onclick="publishAllQuizzes('${instanceId}')">
                                <i class="fas fa-globe"></i> Publish All
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="unpublishAllQuizzes('${instanceId}')">
                                <i class="fas fa-eye-slash"></i> Unpublish All
                            </button>
                        </div>
                    </div>
                    <div class="quiz-publications-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Quiz</th>
                                    <th>Questions</th>
                                    <th>Status</th>
                                    <th>Settings</th>
                                    <th>Student Activity</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${publications.map(pub => `
                                    <tr class="quiz-publication-row" data-quiz-id="${pub.quiz_id}">
                                        <td>
                                            <div class="quiz-info">
                                                <div class="quiz-title">${pub.quiz_title}</div>
                                                <div class="quiz-meta">
                                                    <span class="topic">${pub.topic}</span>
                                                    <span class="difficulty ${pub.difficulty}">${pub.difficulty}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="question-count">
                                                <i class="fas fa-question"></i> ${pub.question_count}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="publication-status">
                                                <div class="status-indicator ${pub.is_published ? 'published' : 'unpublished'}">
                                                    <i class="fas ${pub.is_published ? 'fa-globe' : 'fa-eye-slash'}"></i>
                                                    ${pub.is_published ? 'Published' : 'Unpublished'}
                                                </div>
                                                ${pub.is_published && pub.published_at ? `
                                                    <div class="status-date">Since ${new Date(pub.published_at).toLocaleDateString()}</div>
                                                ` : ''}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="quiz-settings">
                                                ${pub.time_limit_minutes ? `
                                                    <div class="setting">
                                                        <i class="fas fa-clock"></i> ${pub.time_limit_minutes} min
                                                    </div>
                                                ` : ''}
                                                <div class="setting">
                                                    <i class="fas fa-redo"></i> ${pub.max_attempts || 3} attempts
                                                </div>
                                                ${pub.available_from || pub.available_until ? `
                                                    <div class="setting">
                                                        <i class="fas fa-calendar"></i> Scheduled
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="student-activity">
                                                <div class="activity-stat">
                                                    <i class="fas fa-users"></i> ${pub.unique_students} students
                                                </div>
                                                <div class="activity-stat">
                                                    <i class="fas fa-pen"></i> ${pub.total_attempts} attempts
                                                </div>
                                                ${pub.avg_score > 0 ? `
                                                    <div class="activity-stat">
                                                        <i class="fas fa-chart-line"></i> ${Math.round(pub.avg_score)}% avg
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="quiz-actions">
                                                <button class="btn btn-sm ${pub.is_published ? 'btn-warning' : 'btn-success'}" 
                                                        onclick="toggleQuizPublication('${instanceId}', '${pub.quiz_id}', ${!pub.is_published})">
                                                    <i class="fas ${pub.is_published ? 'fa-eye-slash' : 'fa-globe'}"></i>
                                                    ${pub.is_published ? 'Unpublish' : 'Publish'}
                                                </button>
                                                <button class="btn btn-sm btn-secondary" 
                                                        onclick="configureQuizSettings('${instanceId}', '${pub.quiz_id}', ${JSON.stringify(pub).replace(/"/g, '&quot;')})">
                                                    <i class="fas fa-cog"></i> Configure
                                                </button>
                                                ${pub.total_attempts > 0 ? `
                                                    <button class="btn btn-sm btn-info" 
                                                            onclick="viewQuizAnalytics('${instanceId}', '${pub.quiz_id}')">
                                                        <i class="fas fa-chart-bar"></i> Analytics
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading instance quiz management:', error);
                document.getElementById('instance-quiz-content').innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                        <h4>Error Loading Quiz Publications</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="showInstanceQuizManagement('${instanceId}', document.querySelector('.tab-btn.active'))">
                            <i class="fas fa-retry"></i> Retry
                        </button>
                    </div>
                `;
            }
        };

        window.toggleQuizPublication = async function(instanceId, quizId, shouldPublish) {
            try {
                const action = shouldPublish ? 'Publishing' : 'Unpublishing';
                const notification = showProgressNotification(`${action} quiz...`, 'info');
                
                const response = await fetch(`${CONFIG.BASE_URL}/quizzes/publish`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        quiz_id: quizId,
                        course_instance_id: instanceId,
                        is_published: shouldPublish,
                        max_attempts: 3 // Default value
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to ${shouldPublish ? 'publish' : 'unpublish'} quiz`);
                }
                
                const result = await response.json();
                notification.update(`Quiz ${shouldPublish ? 'published' : 'unpublished'} successfully!`, 'success');
                
                // Refresh the current instance display
                setTimeout(() => {
                    notification.close();
                    const activeTab = document.querySelector('.quiz-management-modal .tab-btn.active');
                    if (activeTab) {
                        showInstanceQuizManagement(instanceId, activeTab);
                    }
                }, 1500);
                
            } catch (error) {
                console.error('Error toggling quiz publication:', error);
                showNotification(`Error ${shouldPublish ? 'publishing' : 'unpublishing'} quiz: ${error.message}`, 'error');
            }
        };

        window.configureQuizSettings = function(instanceId, quizId, publicationData) {
            const pub = typeof publicationData === 'string' ? JSON.parse(publicationData) : publicationData;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay quiz-settings-modal';
            modal.innerHTML = `
                <div class="modal-content medium">
                    <div class="modal-header">
                        <h3><i class="fas fa-cog"></i> Configure Quiz Settings</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <form id="quiz-settings-form">
                            <div class="form-group">
                                <label>Quiz Title</label>
                                <input type="text" value="${pub.quiz_title}" readonly class="form-control">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="time-limit">Time Limit (minutes)</label>
                                    <input type="number" id="time-limit" class="form-control" 
                                           value="${pub.time_limit_minutes || ''}" min="1" max="480">
                                    <small class="form-text">Leave empty for no time limit</small>
                                </div>
                                <div class="form-group">  
                                    <label for="max-attempts">Maximum Attempts</label>
                                    <input type="number" id="max-attempts" class="form-control" 
                                           value="${pub.max_attempts || 3}" min="1" max="10" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="available-from">Available From</label>
                                    <input type="datetime-local" id="available-from" class="form-control"
                                           value="${pub.available_from ? new Date(pub.available_from).toISOString().slice(0, 16) : ''}">
                                </div>
                                <div class="form-group">
                                    <label for="available-until">Available Until</label>
                                    <input type="datetime-local" id="available-until" class="form-control"
                                           value="${pub.available_until ? new Date(pub.available_until).toISOString().slice(0, 16) : ''}">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="is-published" class="form-check-input" 
                                           ${pub.is_published ? 'checked' : ''}>
                                    <label for="is-published" class="form-check-label">Published (visible to students)</label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveQuizSettings('${instanceId}', '${quizId}')">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };

        window.saveQuizSettings = async function(instanceId, quizId) {
            try {
                const form = document.getElementById('quiz-settings-form');
                const formData = new FormData(form);
                
                const timeLimit = document.getElementById('time-limit').value;
                const maxAttempts = document.getElementById('max-attempts').value;
                const availableFrom = document.getElementById('available-from').value;
                const availableUntil = document.getElementById('available-until').value;
                const isPublished = document.getElementById('is-published').checked;
                
                const settings = {
                    quiz_id: quizId,
                    course_instance_id: instanceId,
                    is_published: isPublished,
                    max_attempts: parseInt(maxAttempts) || 3,
                    time_limit_minutes: timeLimit ? parseInt(timeLimit) : null,
                    available_from: availableFrom ? new Date(availableFrom).toISOString() : null,
                    available_until: availableUntil ? new Date(availableUntil).toISOString() : null
                };
                
                const notification = showProgressNotification('Saving quiz settings...', 'info');
                
                const response = await fetch(`${CONFIG.BASE_URL}/quizzes/publish`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save quiz settings');
                }
                
                notification.update('Quiz settings saved successfully!', 'success');
                
                // Close the settings modal and refresh the main view
                document.querySelector('.quiz-settings-modal').remove();
                
                setTimeout(() => {
                    notification.close();
                    const activeTab = document.querySelector('.quiz-management-modal .tab-btn.active');
                    if (activeTab) {
                        showInstanceQuizManagement(instanceId, activeTab);
                    }
                }, 1500);
                
            } catch (error) {
                console.error('Error saving quiz settings:', error);
                showNotification(`Error saving settings: ${error.message}`, 'error');
            }
        };
        
        window.viewQuizResults = function(quizId) {
            showNotification('Quiz results viewing will be implemented', 'info');
        };
        
        window.filterQuizzes = function() {
            const courseFilter = document.getElementById('quizCourseFilter').value;
            const difficultyFilter = document.getElementById('quizDifficultyFilter').value;
            
            // If a course is selected, load quizzes for that course
            if (courseFilter && courseFilter !== 'all') {
                loadQuizzesForCourse(courseFilter);
            }
            
            // Apply difficulty filter if needed
            if (difficultyFilter && difficultyFilter !== 'all') {
                const quizCards = document.querySelectorAll('.quiz-card');
                quizCards.forEach(card => {
                    const badge = card.querySelector('.quiz-badge');
                    if (badge && badge.textContent.toLowerCase() === difficultyFilter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            } else {
                // Show all quizzes
                const quizCards = document.querySelectorAll('.quiz-card');
                quizCards.forEach(card => {
                    card.style.display = 'block';
                });
            }
        };
        
        // Load quizzes when switching to quiz section
        window.loadQuizzesSection = function() {
            // Quiz section functionality removed - function disabled
            return;
        };
        
        // Quiz section override removed - no longer needed after quiz functionality removal
        
        // Function to handle individual quiz selection
        window.selectQuizItem = function(quizId, courseId, index) {
            
            // Remove previous selections
            document.querySelectorAll('.quiz-item').forEach(item => {
                item.classList.remove('selected');
                const actions = item.querySelector('.quiz-actions');
                if (actions) {
                    actions.style.display = 'none';
                }
            });
            
            // Select current quiz
            const selectedItem = document.querySelector(`[data-quiz-id="${quizId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
                const actions = selectedItem.querySelector('.quiz-actions');
                if (actions) {
                    actions.style.display = 'block';
                }
            }
        };

        // =============================================
        // ENHANCED CONTENT MANAGEMENT FUNCTIONS
        // =============================================
        
        // SYLLABUS FUNCTIONS
        async function uploadSyllabusFile(courseId) {
            
            // Create file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.doc,.docx,.txt,.md';
            fileInput.style.display = 'none';
            
            fileInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Show upload progress
                showNotification('Uploading syllabus...', 'info');
                
                try {
                    const formData = new FormData();
                    formData.append('syllabus_file', file);
                    formData.append('course_id', courseId);
                    
                    const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/upload-syllabus`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification('Syllabus uploaded successfully!', 'success');
                        
                        // Update syllabus source indicator
                        const sourceElement = document.getElementById(`syllabus-source-${courseId}`);
                        if (sourceElement) {
                            sourceElement.textContent = 'Custom Upload';
                            sourceElement.className = 'badge badge-success';
                        }
                        
                        // Update last updated time
                        const updatedElement = document.getElementById(`syllabus-updated-${courseId}`);
                        if (updatedElement) {
                            updatedElement.textContent = new Date().toLocaleDateString();
                        }
                        
                        // Trigger AI processing if enabled
                        if (confirm('Would you like AI to analyze this syllabus and generate course content?')) {
                            await generateContentFromSyllabus(courseId, result.syllabus_id);
                        }
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('Error uploading syllabus:', error);
                    showNotification('Failed to upload syllabus: ' + error.message, 'error');
                }
                
                // Clean up
                document.body.removeChild(fileInput);
            };
            
            // Trigger file selection
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        async function downloadSyllabus(courseId, format = 'pdf') {
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/download-syllabus/${courseId}?format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const course = userCourses.find(c => c.id === courseId);
                    const filename = `${course?.title || 'course'}-syllabus.${format}`;
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Syllabus downloaded successfully!', 'success');
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                console.error('Error downloading syllabus:', error);
                showNotification('Failed to download syllabus: ' + error.message, 'error');
            }
        }
        
        async function editSyllabus(courseId) {
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <h3><i class="fas fa-edit"></i> Edit Syllabus</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="syllabusContent">Syllabus Content:</label>
                            <textarea id="syllabusContent" rows="20" placeholder="Enter syllabus content here..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveSyllabusContent('${courseId}')">Save Changes</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load existing syllabus content
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/syllabus/${courseId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('syllabusContent').value = data.content || '';
                }
            } catch (error) {
                console.error('Error loading syllabus:', error);
            }
        }
        
        // SLIDES FUNCTIONS
        async function uploadSlides(courseId) {
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.ppt,.pptx,.pdf,.json';
            fileInput.style.display = 'none';
            
            fileInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                showNotification('Uploading slides...', 'info');
                
                try {
                    const formData = new FormData();
                    formData.append('slides_file', file);
                    formData.append('course_id', courseId);
                    
                    const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/upload-slides`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification('Slides uploaded successfully!', 'success');
                        
                        // Update slides count
                        const countElement = document.getElementById(`slides-count-${courseId}`);
                        if (countElement) {
                            countElement.textContent = result.slide_count || 'Unknown';
                        }
                        
                        // Update last updated time
                        const updatedElement = document.getElementById(`slides-updated-${courseId}`);
                        if (updatedElement) {
                            updatedElement.textContent = new Date().toLocaleDateString();
                        }
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('Error uploading slides:', error);
                    showNotification('Failed to upload slides: ' + error.message, 'error');
                }
                
                document.body.removeChild(fileInput);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        async function uploadTemplate(courseId) {
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pptx,.json';
            fileInput.style.display = 'none';
            
            fileInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                showNotification('Uploading template...', 'info');
                
                try {
                    const formData = new FormData();
                    formData.append('template_file', file);
                    formData.append('course_id', courseId);
                    
                    const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/upload-template`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification('Template uploaded successfully! AI will use this template for slide generation.', 'success');
                        
                        // Update template status
                        const templateElement = document.getElementById(`template-status-${courseId}`);
                        if (templateElement) {
                            templateElement.textContent = 'Custom';
                            templateElement.className = 'badge badge-success';
                        }
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('Error uploading template:', error);
                    showNotification('Failed to upload template: ' + error.message, 'error');
                }
                
                document.body.removeChild(fileInput);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        async function downloadSlides(courseId, format = 'pptx') {
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/download-slides/${courseId}?format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const course = userCourses.find(c => c.id === courseId);
                    const filename = `${course?.title || 'course'}-slides.${format}`;
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Slides downloaded successfully!', 'success');
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                console.error('Error downloading slides:', error);
                showNotification('Failed to download slides: ' + error.message, 'error');
            }
        }
        
        // LABS FUNCTIONS
        async function uploadCustomLab(courseId) {
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json,.zip';
            fileInput.style.display = 'none';
            
            fileInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                showNotification('Uploading custom lab...', 'info');
                
                try {
                    const formData = new FormData();
                    formData.append('lab_file', file);
                    formData.append('course_id', courseId);
                    
                    const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/upload-lab`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification('Custom lab uploaded successfully! AI Assistant will recognize this lab.', 'success');
                        
                        // Update lab source indicator
                        const sourceElement = document.getElementById(`lab-source-${courseId}`);
                        if (sourceElement) {
                            sourceElement.textContent = 'Custom Upload';
                            sourceElement.className = 'badge badge-success';
                        }
                        
                        // Update exercise count
                        const countElement = document.getElementById(`lab-count-${courseId}`);
                        if (countElement) {
                            countElement.textContent = result.exercise_count || '?';
                        }
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('Error uploading lab:', error);
                    showNotification('Failed to upload lab: ' + error.message, 'error');
                }
                
                document.body.removeChild(fileInput);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        async function exportLabs(courseId, format = 'zip') {
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/export-labs/${courseId}?format=${format}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const course = userCourses.find(c => c.id === courseId);
                    const filename = `${course?.title || 'course'}-labs.${format}`;
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Labs exported successfully!', 'success');
                } else {
                    throw new Error('Export failed');
                }
            } catch (error) {
                console.error('Error exporting labs:', error);
                showNotification('Failed to export labs: ' + error.message, 'error');
            }
        }
        
        // QUIZ FUNCTIONS
        async function uploadCustomQuiz(courseId) {
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json,.csv,.xlsx';
            fileInput.style.display = 'none';
            
            fileInput.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                showNotification('Uploading custom quiz...', 'info');
                
                try {
                    const formData = new FormData();
                    formData.append('quiz_file', file);
                    formData.append('course_id', courseId);
                    
                    const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/upload-quiz`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification('Custom quiz uploaded successfully! AI will recognize correct answers for grading.', 'success');
                        
                        // Update quiz source indicator
                        const sourceElement = document.getElementById(`quiz-source-${courseId}`);
                        if (sourceElement) {
                            sourceElement.textContent = 'Custom Upload';
                            sourceElement.className = 'badge badge-success';
                        }
                        
                        // Update question count
                        const countElement = document.getElementById(`quiz-count-${courseId}`);
                        if (countElement) {
                            countElement.textContent = result.question_count || '?';
                        }
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('Error uploading quiz:', error);
                    showNotification('Failed to upload quiz: ' + error.message, 'error');
                }
                
                document.body.removeChild(fileInput);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        // CONTENT GENERATION WITH TEMPLATES
        async function generateContentFromSyllabus(courseId, syllabusId) {
            
            showNotification('AI is analyzing your syllabus and generating content...', 'info');
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/generate-from-syllabus`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        course_id: courseId,
                        syllabus_id: syllabusId,
                        include_slides: true,
                        include_labs: true,
                        include_quizzes: true,
                        use_custom_template: true // Use uploaded template if available
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('Content generated successfully from your syllabus!', 'success');
                    
                    // Refresh the course content view
                    const course = userCourses.find(c => c.id === courseId);
                    if (course) {
                        await showCourseContentView(course);
                    }
                } else {
                    throw new Error('Generation failed');
                }
            } catch (error) {
                console.error('Error generating content:', error);
                showNotification('Failed to generate content: ' + error.message, 'error');
            }
        }
        
        // Updated generate functions to use templates
        async function generateSlides(courseId) {
            
            showNotification('AI is generating slides using your template...', 'info');
            
            try {
                const response = await fetch(`${CONFIG.ENDPOINTS.CONTENT_SERVICE}/generate-slides`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        course_id: courseId,
                        use_custom_template: true,
                        slide_count: 10
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification('Slides generated successfully using your template!', 'success');
                    
                    // Update slides count
                    const countElement = document.getElementById(`slides-count-${courseId}`);
                    if (countElement) {
                        countElement.textContent = result.slide_count || '10';
                    }
                } else {
                    throw new Error('Generation failed');
                }
            } catch (error) {
                console.error('Error generating slides:', error);
                showNotification('Failed to generate slides: ' + error.message, 'error');
            }
        }

        window.uploadSyllabusFile = uploadSyllabusFile;
        window.downloadSyllabus = downloadSyllabus;
        window.editSyllabus = editSyllabus;
        window.uploadSlides = uploadSlides;
        window.uploadTemplate = uploadTemplate;
        window.downloadSlides = downloadSlides;
        window.uploadCustomLab = uploadCustomLab;
        window.exportLabs = exportLabs;
        window.uploadCustomQuiz = uploadCustomQuiz;
        window.generateContentFromSyllabus = generateContentFromSyllabus;
        window.generateSlides = generateSlides;

        // Lab Container Management Functions
        let currentCourseId = null;
        let labContainerData = {};

        async function manageLabContainers(courseId) {
            currentCourseId = courseId;
            showModal('labContainerModal');
            await loadLabContainerData(courseId);
        }

        async function createInstructorLab(courseId) {
            currentCourseId = courseId;
            showModal('createInstructorLabModal');
        }

        async function loadLabContainerData(courseId) {
            try {
                await loadInstructorLabStatus(courseId);
                await loadStudentLabs(courseId);
                await loadLabAnalytics(courseId);
            } catch (error) {
                console.error('Error loading lab container data:', error);
                showNotification('Error loading lab data: ' + error.message, 'error');
            }
        }

        async function loadInstructorLabStatus(courseId) {
            // Implementation for loading instructor lab status
            const statusCard = document.getElementById('instructorLabStatus');
            statusCard.innerHTML = `
                <div class="no-lab-message">
                    <i class="fas fa-info-circle"></i>
                    <p>Lab container management is ready.</p>
                    <button class="btn btn-primary" onclick="createInstructorLabEnvironment()">
                        <i class="fas fa-play"></i> Create Lab Environment
                    </button>
                </div>
            `;
        }

        async function loadStudentLabs(courseId) {
            // Implementation for loading student labs
            const studentsList = document.getElementById('studentLabsList');
            studentsList.innerHTML = `
                <div class="no-students-message">
                    <i class="fas fa-users"></i>
                    <p>Student lab environments will appear here when students access their labs.</p>
                </div>
            `;
        }

        async function loadLabAnalytics(courseId) {
            // Implementation for loading lab analytics
            document.getElementById('activeLabs').textContent = '0';
            document.getElementById('totalUsage').textContent = '0';
            document.getElementById('resourceUsage').textContent = '0%';
            document.getElementById('successRate').textContent = '100%';
        }

        async function createInstructorLabEnvironment() {
            showModal('createInstructorLabModal');
        }

        async function submitInstructorLabCreation() {
            const form = document.getElementById('instructorLabForm');
            const formData = new FormData(form);
            
            try {
                showNotification('Creating instructor lab environment...', 'info');
                
                // Simulate lab creation
                setTimeout(() => {
                    showNotification('Lab environment created successfully!', 'success');
                    closeModal('createInstructorLabModal');
                }, 2000);
                
            } catch (error) {
                console.error('Error creating instructor lab:', error);
                showNotification('Error creating lab environment: ' + error.message, 'error');
            }
        }

        async function refreshLabStatus() {
            if (currentCourseId) {
                showNotification('Refreshing lab status...', 'info');
                await loadLabContainerData(currentCourseId);
                showNotification('Lab status refreshed!', 'success');
            }
        }

        async function pauseAllStudentLabs() {
            if (!confirm('Are you sure you want to pause all student lab environments?')) {
                return;
            }
            showNotification('Pausing all student labs...', 'info');
        }

        async function shutdownAllLabs() {
            if (!confirm('Are you sure you want to shutdown ALL lab environments?')) {
                return;
            }
            showNotification('Shutting down all labs...', 'warning');
        }

        function filterStudentLabs() {
            const nameFilter = document.getElementById('studentFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            const studentCards = document.querySelectorAll('.student-lab-card');
            studentCards.forEach(card => {
                const username = card.dataset.username || '';
                const status = card.dataset.status || '';
                
                const nameMatch = !nameFilter || username.includes(nameFilter);
                const statusMatch = !statusFilter || status === statusFilter;
                
                card.style.display = (nameMatch && statusMatch) ? 'block' : 'none';
            });
        }

        function exportLabReport() {
            showNotification('Exporting lab report...', 'info');
            setTimeout(() => {
                showNotification('Lab report export feature coming soon!', 'info');
            }, 1000);
        }
        
        // Lab Container Management Functions
        window.manageLabContainers = manageLabContainers;
        window.createInstructorLab = createInstructorLab;
        window.createInstructorLabEnvironment = createInstructorLabEnvironment;
        window.refreshLabStatus = refreshLabStatus;
        window.pauseAllStudentLabs = pauseAllStudentLabs;
        window.shutdownAllLabs = shutdownAllLabs;
        window.filterStudentLabs = filterStudentLabs;
        window.submitInstructorLabCreation = submitInstructorLabCreation;
        window.exportLabReport = exportLabReport;
        
        // Course Publishing Global Functions
        window.submitCreateInstance = function() {
            if (window.instructorDashboard) {
                window.instructorDashboard.submitCreateInstance();
            }
        };
        
        window.submitEnrollStudent = function() {
            if (window.instructorDashboard) {
                window.instructorDashboard.submitEnrollStudent();
            }
        };
        
        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        };
        
        window.showCreateInstanceModal = function() {
            if (window.instructorDashboard) {
                window.instructorDashboard.showCreateInstanceModal();
            }
        };
        
        window.filterPublishedCourses = function() {
            // TODO: Implement filtering for published courses
        };
        
        window.filterInstances = function() {
            // TODO: Implement filtering for course instances
        };
        
        window.searchInstances = function() {
            // TODO: Implement search for course instances
        };
    </script>

    <!-- Lab Container Management Modal -->
    <div id="labContainerModal" class="modal">
        <div class="modal-content extra-large">
            <div class="modal-header">
                <h2><i class="fas fa-server"></i> Lab Container Management</h2>
                <button class="close-btn" onclick="closeModal('labContainerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="lab-management-container">
                    <!-- Lab Environment Controls -->
                    <div class="lab-controls-section">
                        <h3>Lab Environment Controls</h3>
                        <div class="lab-controls-grid">
                            <button class="btn btn-primary" onclick="createInstructorLabEnvironment()">
                                <i class="fas fa-play"></i> Create My Lab Environment
                            </button>
                            <button class="btn btn-success" onclick="refreshLabStatus()">
                                <i class="fas fa-sync"></i> Refresh Status
                            </button>
                            <button class="btn btn-warning" onclick="pauseAllStudentLabs()">
                                <i class="fas fa-pause"></i> Pause All Student Labs
                            </button>
                            <button class="btn btn-danger" onclick="shutdownAllLabs()">
                                <i class="fas fa-stop"></i> Shutdown All Labs
                            </button>
                        </div>
                    </div>

                    <!-- Instructor Lab Status -->
                    <div class="instructor-lab-section">
                        <h3>My Lab Environment</h3>
                        <div id="instructorLabStatus" class="lab-status-card">
                            <div class="status-indicator">
                                <i class="fas fa-circle-notch fa-spin"></i> Loading...
                            </div>
                        </div>
                    </div>

                    <!-- Student Labs Overview -->
                    <div class="student-labs-section">
                        <h3>Student Lab Environments</h3>
                        <div class="lab-filters">
                            <input type="text" id="studentFilter" placeholder="Filter by student name..." onkeyup="filterStudentLabs()">
                            <select id="statusFilter" onchange="filterStudentLabs()">
                                <option value="">All Statuses</option>
                                <option value="running">Running</option>
                                <option value="paused">Paused</option>
                                <option value="building">Building</option>
                                <option value="stopped">Stopped</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                        <div id="studentLabsList" class="student-labs-grid">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i> Loading student labs...
                            </div>
                        </div>
                    </div>

                    <!-- Lab Analytics -->
                    <div class="lab-analytics-section">
                        <h3>Lab Analytics</h3>
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <h4>Active Labs</h4>
                                <div class="analytics-value" id="activeLabs">-</div>
                            </div>
                            <div class="analytics-card">
                                <h4>Total Usage</h4>
                                <div class="analytics-value" id="totalUsage">- hours</div>
                            </div>
                            <div class="analytics-card">
                                <h4>Resource Usage</h4>
                                <div class="analytics-value" id="resourceUsage">-%</div>
                            </div>
                            <div class="analytics-card">
                                <h4>Success Rate</h4>
                                <div class="analytics-value" id="successRate">-%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('labContainerModal')">Close</button>
                <button class="btn btn-primary" onclick="exportLabReport()">Export Report</button>
            </div>
        </div>
    </div>

    <!-- Create Instructor Lab Modal -->
    <div id="createInstructorLabModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2><i class="fas fa-flask"></i> Create Instructor Lab Environment</h2>
                <button class="close-btn" onclick="closeModal('createInstructorLabModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="instructorLabForm">
                    <div class="form-group">
                        <label for="labType">Lab Type:</label>
                        <select id="labType" name="labType" required>
                            <option value="">Select Lab Type</option>
                            <option value="python">Python Programming</option>
                            <option value="javascript">JavaScript/Node.js</option>
                            <option value="web">Web Development (HTML/CSS/JS)</option>
                            <option value="java">Java Programming</option>
                            <option value="default">General Purpose</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="labTimeout">Session Timeout (minutes):</label>
                        <input type="number" id="labTimeout" name="labTimeout" value="120" min="30" max="480">
                    </div>
                    <div class="form-group">
                        <label for="customPackages">Additional Packages (comma-separated):</label>
                        <input type="text" id="customPackages" name="customPackages" placeholder="numpy, requests, flask">
                    </div>
                    <div class="form-group">
                        <label for="customDockerfile">Custom Dockerfile (optional):</label>
                        <textarea id="customDockerfile" name="customDockerfile" rows="10" placeholder="FROM python:3.10-slim&#10;RUN pip install custom-package&#10;..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="persistentStorage" name="persistentStorage" checked>
                            Enable persistent storage
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createInstructorLabModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitInstructorLabCreation()">Create Lab Environment</button>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentDetailsModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2><i class="fas fa-user-chart"></i> Student Analytics Details</h2>
                <button class="close-btn" onclick="closeModal('studentDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Content will be populated dynamically by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('studentDetailsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Course Instance Modal -->
    <div id="createInstanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-plus"></i> Create Course Instance</h3>
                <span class="close" onclick="closeModal('createInstanceModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createInstanceForm">
                    <div class="form-group">
                        <label for="instanceCourse">Course</label>
                        <select id="instanceCourse" name="course_id" required>
                            <option value="">Select a published course...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="instanceName">Instance Name</label>
                        <input type="text" id="instanceName" name="instance_name" required 
                               placeholder="e.g., Fall 2024 Session, Morning Cohort">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" name="start_date" required>
                        </div>
                        <div class="form-group">
                            <label for="startTime">Start Time</label>
                            <input type="time" id="startTime" name="start_time" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" name="end_date" required>
                        </div>
                        <div class="form-group">
                            <label for="endTime">End Time</label>
                            <input type="time" id="endTime" name="end_time" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="timezone">Timezone</label>
                            <select id="timezone" name="timezone" required>
                                <option value="UTC">UTC (Coordinated Universal Time)</option>
                                <option value="America/New_York">Eastern Time (ET)</option>
                                <option value="America/Chicago">Central Time (CT)</option>
                                <option value="America/Denver">Mountain Time (MT)</option>
                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                <option value="Europe/London">London (GMT/BST)</option>
                                <option value="Europe/Paris">Central European Time (CET)</option>
                                <option value="Asia/Tokyo">Japan Standard Time (JST)</option>
                                <option value="Asia/Shanghai">China Standard Time (CST)</option>
                                <option value="Australia/Sydney">Australian Eastern Time (AET)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maxStudents">Maximum Students</label>
                            <input type="number" id="maxStudents" name="max_students" min="1" max="100" value="30">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="instanceDescription">Description (Optional)</label>
                        <textarea id="instanceDescription" name="description" rows="3" 
                                  placeholder="Additional details about this instance..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createInstanceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitCreateInstance()">Create Instance</button>
            </div>
        </div>
    </div>

    <!-- Student Enrollment Modal -->
    <div id="enrollStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Enroll Student</h3>
                <span class="close" onclick="closeModal('enrollStudentModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="enrollStudentForm">
                    <input type="hidden" id="enrollInstanceId" name="instance_id">
                    
                    <div class="form-group">
                        <label for="studentEmail">Student Email</label>
                        <input type="email" id="studentEmail" name="student_email" required 
                               placeholder="student@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="studentName">Student Name</label>
                        <input type="text" id="studentName" name="student_name" required 
                               placeholder="John Doe">
                    </div>
                    
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="sendWelcomeEmail" name="send_welcome_email" checked>
                            Send welcome email with login credentials
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('enrollStudentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitEnrollStudent()">Enroll Student</button>
            </div>
        </div>
    </div>

    <!-- Chart.js for Analytics Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Analytics Dashboard Module -->
    <script type="module">
        import AnalyticsDashboard from './js/modules/analytics-dashboard.js';
        
        // Initialize analytics dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.analyticsDashboard = new AnalyticsDashboard();
        });
    </script>

</body>
</html>