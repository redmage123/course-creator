<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal Login - Course Creator Platform</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Privacy-focused: No external tracking or analytics without consent -->
    <style>
        /* GDPR-compliant styling for consent interface */
        .privacy-notice {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .consent-section {
            margin: 16px 0;
            padding: 12px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        
        .consent-checkbox {
            display: flex;
            align-items: flex-start;
            margin: 8px 0;
        }
        
        .consent-checkbox input[type="checkbox"] {
            margin-right: 8px;
            margin-top: 2px;
        }
        
        .consent-checkbox label {
            font-size: 14px;
            line-height: 1.4;
            cursor: pointer;
        }
        
        .privacy-link {
            color: #007bff;
            text-decoration: none;
        }
        
        .privacy-link:hover {
            text-decoration: underline;
        }
        
        .expired-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 6px;
            margin: 16px 0;
        }
        
        .course-context {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 12px;
            margin: 16px 0;
            font-size: 14px;
        }
        
        .login-mode-toggle {
            display: flex;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .mode-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 13px;
            line-height: 1.3;
            transition: all 0.2s;
        }
        
        .mode-button.active {
            background: var(--primary-color);
            color: white;
        }
        
        .mode-button:not(.active):hover {
            background: #e9ecef;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
        }
        
        .login-card {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 3rem;
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .course-info {
            background: rgba(37, 99, 235, 0.05);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .course-info h2 {
            margin: 0 0 var(--spacing-sm) 0;
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        .course-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .login-form {
            text-align: left;
        }
        
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .login-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: var(--spacing-lg);
            white-space: normal;
            line-height: 1.4;
        }
        
        .login-btn:hover {
            background: var(--primary-hover);
        }
        
        .login-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }
        
        .error-message {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.3);
            color: var(--danger-color);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            font-size: 0.875rem;
            display: none;
        }
        
        .success-message {
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid rgba(5, 150, 105, 0.3);
            color: var(--success-color);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            font-size: 0.875rem;
            display: none;
        }
        
        .loading-spinner {
            display: none;
            margin: 0 auto;
            width: 2rem;
            height: 2rem;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .help-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-lg);
            text-align: center;
        }
        
        .help-text a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .help-text a:hover {
            text-decoration: underline;
        }
        
        .password-requirements {
            background: rgba(217, 119, 6, 0.1);
            border: 1px solid rgba(217, 119, 6, 0.3);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-top: var(--spacing-sm);
            font-size: 0.875rem;
            color: var(--warning-color);
            display: none;
        }
        
        .password-requirements ul {
            margin: 0;
            padding-left: var(--spacing-lg);
        }
        
        .password-requirements li {
            margin-bottom: var(--spacing-xs);
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div aria-live="polite" aria-atomic="true" class="sr-only" id="form-announcements"></div>
    <main id="main-content" role="main">
    <div class="login-container">
        <div class="login-card">
            <div class="logo">
                <h1><i class="fas fa-graduation-cap"></i> Course Creator</h1>
            </div>
            
            <!-- Login Mode Toggle -->
            <div class="login-mode-toggle">
                <button type="button" class="mode-button active" onclick="switchLoginMode('credentials')" id="credentialsMode">
                    <i class="fas fa-user"></i> Username<br>or Password
                </button>
                <button type="button" class="mode-button" onclick="switchLoginMode('token')" id="tokenMode">
                    <i class="fas fa-key"></i> Access Token
                </button>
            </div>

            <!-- Course Information (populated by JavaScript) -->
            <div id="courseInfo" class="course-context" style="display: none;">
                <strong>Course:</strong> <span id="courseTitle">Loading...</span>
                <br><span id="courseDescription"></span>
            </div>

            <!-- Account Status Notice -->
            <div id="statusNotice" class="expired-notice" style="display: none;">
                <strong>Account Notice:</strong> <span id="statusMessage"></span>
            </div>

            <!-- GDPR Privacy Notice -->
            <div class="privacy-notice">
                <h4><i class="fas fa-shield-alt"></i> Data Processing Notice</h4>
                <p>Your login data is processed for educational purposes only. We collect minimal information necessary for course delivery and educational analytics. You have full control over additional data processing through the consent options below.</p>
                <p><a href="#" class="privacy-link" onclick="showPrivacyPolicy()">View Full Privacy Policy</a></p>
            </div>
            
            <!-- Error Message -->
            <div id="errorMessage" class="error-message" role="alert" aria-live="assertive"></div>

            <!-- Success Message -->
            <div id="successMessage" class="success-message" role="alert" aria-live="assertive"></div>
            
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading-spinner"></div>
            
            <!-- Credentials Login Form -->
            <form id="credentialsForm" class="login-form">
                <div class="form-group">
                    <label for="email">Email Address:</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        autocomplete="email"
                        placeholder="Enter your email address"
                    >
                </div>

                <div class="form-group">
                    <label for="password">Password:</label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        autocomplete="current-password"
                        placeholder="Enter your password"
                    >
                </div>

                <div class="form-group">
                    <div class="consent-checkbox">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <label for="rememberMe">
                            Remember me on this device
                        </label>
                    </div>
                </div>

                <!-- Hidden course context -->
                <input type="hidden" id="courseInstanceId" name="courseInstanceId">

                <!-- GDPR Consent Section -->
                <div class="consent-section">
                    <h4><i class="fas fa-check-circle"></i> Data Processing Consent</h4>
                    <p>Choose how your data may be used for educational purposes:</p>
                    
                    <div class="consent-checkbox">
                        <input type="checkbox" id="consentAnalytics" name="consentAnalytics">
                        <label for="consentAnalytics">
                            <strong>Educational Analytics:</strong> Allow analysis of your learning patterns to improve course content and provide personalized recommendations.
                        </label>
                    </div>
                    
                    <div class="consent-checkbox">
                        <input type="checkbox" id="consentNotifications" name="consentNotifications">
                        <label for="consentNotifications">
                            <strong>Instructor Notifications:</strong> Notify your instructor when you log in to help them track class engagement.
                        </label>
                    </div>
                    
                    <p style="font-size: 12px; color: #6c757d; margin-top: 8px;">
                        <i class="fas fa-info-circle"></i> You can change these preferences at any time in your account settings.
                    </p>
                </div>

                <button type="submit" id="credentialsBtn" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Login to Student Portal
                </button>
            </form>

            <!-- Token Login Form -->
            <form id="tokenForm" class="login-form" style="display: none;">
                <div class="form-group">
                    <label for="accessToken">Access Token</label>
                    <input
                        type="text"
                        id="accessToken"
                        name="accessToken"
                        required
                        placeholder="Enter your access token"
                        autocomplete="off"
                    >
                </div>

                <div class="form-group">
                    <label for="tokenPassword">Temporary Password</label>
                    <input
                        type="password"
                        id="tokenPassword"
                        name="tokenPassword"
                        required
                        placeholder="Enter your temporary password"
                        autocomplete="current-password"
                    >
                </div>
                
                <button type="submit" id="tokenBtn" class="login-btn">
                    <i class="fas fa-key"></i> Access Course
                </button>
            </form>
            
            <!-- Password Reset Form (hidden initially) -->
            <form id="passwordResetForm" class="login-form" style="display: none;">
                <h3>Password Reset Required</h3>
                <p>For security, please create a new password for your account.</p>
                
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input 
                        type="password" 
                        id="currentPassword" 
                        name="currentPassword" 
                        required 
                        placeholder="Enter your current password"
                    >
                </div>
                
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input 
                        type="password" 
                        id="newPassword" 
                        name="newPassword" 
                        required 
                        placeholder="Create a new password"
                        oninput="showPasswordRequirements()"
                    >
                    <div id="passwordRequirements" class="password-requirements">
                        <p><strong>Password Requirements:</strong></p>
                        <ul>
                            <li>At least 8 characters long</li>
                            <li>Contains at least one uppercase letter</li>
                            <li>Contains at least one lowercase letter</li>
                            <li>Contains at least one number</li>
                            <li>Contains at least one special character</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        name="confirmPassword" 
                        required 
                        placeholder="Confirm your new password"
                    >
                </div>
                
                <button type="submit" id="resetBtn" class="login-btn">
                    <i class="fas fa-key"></i> Update Password
                </button>
                
                <button type="button" onclick="showLoginForm()" class="btn btn-outline" style="width: 100%;">
                    <i class="fas fa-arrow-left"></i> Back to Login
                </button>
            </form>
            
            <div class="help-text">
                <p>
                    <i class="fas fa-info-circle"></i> 
                    This is a private course link. If you're having trouble accessing your course, 
                    please contact your instructor.
                </p>
                <p>
                    <a href="#" onclick="showPasswordResetForm()">Forgot your password?</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt"></i> Privacy Policy Summary</h3>
                <span class="close" onclick="hidePrivacyPolicy()">&times;</span>
            </div>
            <div class="modal-body">
                <h4>Educational Data Processing</h4>
                <p>We process your data under the following legal bases:</p>
                <ul>
                    <li><strong>Legitimate Interest (GDPR Art. 6.1.f):</strong> Essential course delivery and academic records</li>
                    <li><strong>Consent (GDPR Art. 6.1.a):</strong> Optional analytics and instructor notifications</li>
                    <li><strong>Contract (GDPR Art. 6.1.b):</strong> Course enrollment and certification</li>
                </ul>
                
                <h4>Your Rights</h4>
                <ul>
                    <li>Access your personal data</li>
                    <li>Correct inaccurate data</li>
                    <li>Delete your data (with academic record exceptions)</li>
                    <li>Port your data to another platform</li>
                    <li>Withdraw consent for optional processing</li>
                </ul>
                
                <h4>Data Retention</h4>
                <p>Login data: 1 academic year | Course records: As required by law | Analytics: Until consent withdrawn</p>
                
                <p><strong>Contact:</strong> privacy@coursecreator.edu for data protection inquiries</p>
            </div>
        </div>
    </div>

    <script src="../js/config-global.js"></script>
    <script>
        /**
         * GDPR-Compliant Student Login Interface
         * 
         * Privacy Features:
         * - Explicit consent collection for optional data processing
         * - Clear privacy notices and data processing information
         * - No tracking without user consent
         * - Minimal data collection (data minimization principle)
         */

        // Current login mode
        let currentLoginMode = 'credentials';

        // Initialize page based on URL parameters
        document.addEventListener('DOMContentLoaded', function() {
            initializeStudentLogin();
        });

        function initializeStudentLogin() {
            // Check for course context in URL
            const urlParams = new URLSearchParams(window.location.search);
            const courseInstanceId = urlParams.get('course');
            const accessToken = urlParams.get('token');
            
            if (courseInstanceId) {
                document.getElementById('courseInstanceId').value = courseInstanceId;
                loadCourseContext(courseInstanceId);
            }
            
            if (accessToken) {
                // Switch to token mode if token provided
                switchLoginMode('token');
                document.getElementById('accessToken').value = accessToken;
            }
            
            // Set up form submissions
            document.getElementById('credentialsForm').addEventListener('submit', handleCredentialsLogin);
            document.getElementById('tokenForm').addEventListener('submit', handleTokenLogin);
            document.getElementById('passwordResetForm').addEventListener('submit', handlePasswordReset);
            
            // Auto-focus appropriate field
            if (currentLoginMode === 'credentials') {
                const emailField = document.getElementById('email');
                if (emailField) {
                    // Ensure login button is in viewport for E2E tests (instant scroll)
                    const loginBtn = document.getElementById('credentialsBtn');
                    if (loginBtn) {
                        loginBtn.scrollIntoView({ behavior: 'instant', block: 'end' });
                    }
                    // Focus after scroll to prevent auto-scroll-back
                    emailField.focus();
                }
            } else {
                document.getElementById('accessToken').focus();
            }
        }

        function switchLoginMode(mode) {
            currentLoginMode = mode;
            
            // Update button states
            document.getElementById('credentialsMode').classList.toggle('active', mode === 'credentials');
            document.getElementById('tokenMode').classList.toggle('active', mode === 'token');
            
            // Show/hide forms
            document.getElementById('credentialsForm').style.display = mode === 'credentials' ? 'block' : 'none';
            document.getElementById('tokenForm').style.display = mode === 'token' ? 'block' : 'none';
            
            // Clear any messages
            hideMessages();
        }

        async function loadCourseContext(courseInstanceId) {
            try {
                const response = await fetch(`${API_BASE_URL}/course-management/api/v1/instances/${courseInstanceId}/info`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const courseInfo = await response.json();
                    document.getElementById('courseTitle').textContent = courseInfo.title || 'Course';
                    document.getElementById('courseDescription').textContent = courseInfo.description || '';
                    document.getElementById('courseInfo').style.display = 'block';
                }
            } catch (error) {
                console.warn('Could not load course context:', error);
            }
        }

        async function handleCredentialsLogin(event) {
            event.preventDefault();
            
            const button = document.getElementById('credentialsBtn');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            
            // Clear previous messages
            hideMessages();
            
            try {
                const formData = new FormData(event.target);
                
                // Create GDPR-compliant login request
                const loginRequest = {
                    username: formData.get('email'), // Using email as username
                    password: formData.get('password'),
                    course_instance_id: formData.get('courseInstanceId') || null,
                    device_fingerprint: generateAnonymousDeviceFingerprint(),
                    consent_analytics: document.getElementById('consentAnalytics').checked,
                    consent_notifications: document.getElementById('consentNotifications').checked
                };
                
                const response = await fetch(`https://localhost:8000/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(loginRequest)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Extract user data from response
                    const user = result.user || result;
                    const userId = user.id || result.user_id;
                    const username = user.username || result.username;
                    const email = user.email || formData.get('email');
                    const role = user.role || result.role || 'student';

                    // Store session data
                    sessionStorage.setItem('authToken', result.access_token);
                    sessionStorage.setItem('userRole', role);
                    sessionStorage.setItem('userId', userId);

                    showSuccess('Login successful! Redirecting to your student dashboard...');

                    // Store in localStorage as well for persistence
                    localStorage.setItem('authToken', result.access_token);
                    localStorage.setItem('userRole', role);
                    localStorage.setItem('userName', username || email);
                    localStorage.setItem('userEmail', email);
                    localStorage.setItem('currentUser', JSON.stringify({
                        id: userId,
                        email: email,
                        role: role,
                        username: username,
                        organization_id: user.organization_id
                    }));
                    localStorage.setItem('sessionStart', Date.now().toString());
                    localStorage.setItem('lastActivity', Date.now().toString());

                    // Immediate redirect (no delay for tests)
                    window.location.href = 'student-dashboard-modular.html';
                    
                } else {
                    // Handle specific error cases
                    if (response.status === 401) {
                        showError('Invalid username or password. Please try again.');
                    } else if (response.status === 403) {
                        showAccountStatusError(result.detail);
                    } else {
                        showError(result.detail || 'Login failed. Please try again.');
                    }
                }
                
            } catch (error) {
                showError('Network error. Please check your connection and try again.');
                console.error('Login error:', error);
            } finally {
                // Reset button state
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function handleTokenLogin(event) {
            event.preventDefault();
            
            const accessToken = document.getElementById('accessToken').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!accessToken || !password) {
                showError('Please enter both access token and password.');
                return;
            }
            
            const button = document.getElementById('tokenBtn');
            const originalText = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accessing...';
            hideMessages();
            
            try {
                const response = await fetch(`${API_BASE_URL}/student/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Store authentication data
                    sessionStorage.setItem('studentAuth', JSON.stringify({
                        accessToken: accessToken,
                        studentData: result.student,
                        loginTime: new Date().toISOString()
                    }));
                    
                    showSuccess('Login successful! Redirecting to your course...');
                    
                    // Check if password reset is required
                    if (result.student.password_reset_required) {
                        setTimeout(() => {
                            showPasswordResetForm();
                            hideElement('successMessage');
                        }, 2000);
                    } else {
                        // Redirect to student dashboard
                        setTimeout(() => {
                            window.location.href = `student-dashboard.html?token=${encodeURIComponent(accessToken)}`;
                        }, 2000);
                    }
                } else {
                    const errorMessage = result.message || 'Login failed. Please check your credentials.';
                    showError(errorMessage);
                }
            } catch (error) {
                console.error('Token login error:', error);
                showError('Unable to connect to the server. Please try again later.');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        function generateAnonymousDeviceFingerprint() {
            // Generate anonymous device fingerprint for security (GDPR-compliant)
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            
            const fingerprint = [
                navigator.language,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset(),
                canvas.toDataURL().slice(-50) // Just last 50 chars for anonymization
            ].join('|');
            
            // Hash the fingerprint to anonymize it
            return btoa(fingerprint).slice(0, 32);
        }

        function showAccountStatusError(message) {
            const statusNotice = document.getElementById('statusNotice');
            const statusMessage = document.getElementById('statusMessage');
            
            statusMessage.textContent = message;
            statusNotice.style.display = 'block';
            
            // Scroll to notice
            statusNotice.scrollIntoView({ behavior: 'smooth' });
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = message;
            successElement.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('statusNotice').style.display = 'none';
        }

        // Show password requirements
        function showPasswordRequirements() {
            document.getElementById('passwordRequirements').style.display = 'block';
        }

        // Show password reset form
        function showPasswordResetForm() {
            document.getElementById('credentialsForm').style.display = 'none';
            document.getElementById('tokenForm').style.display = 'none';
            document.getElementById('passwordResetForm').style.display = 'block';
            hideMessages();
        }

        function showLoginForm() {
            document.getElementById('passwordResetForm').style.display = 'none';
            switchLoginMode(currentLoginMode);
        }

        // Privacy Policy Modal Functions
        function showPrivacyPolicy() {
            document.getElementById('privacyModal').style.display = 'block';
        }

        function hidePrivacyPolicy() {
            document.getElementById('privacyModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('privacyModal');
            if (event.target === modal) {
                hidePrivacyPolicy();
            }
        }

        // Validate password strength
        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\?]/.test(password)
            };
            
            return Object.values(requirements).every(req => req);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const token = getUrlParameter('token');
            
            if (token) {
                // Pre-fill the access token if provided in URL
                document.getElementById('accessToken').value = token;
                
                // Try to load course information
                loadCourseInfo(token);
            }
            
            // Handle login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });
            
            // Handle password reset form submission
            document.getElementById('passwordResetForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handlePasswordReset();
            });
        });

        // Load course information
        async function loadCourseInfo(token) {
            try {
                const response = await fetch(`${CONFIG.BASE_URL}/student/course-data?token=${encodeURIComponent(token)}`);
                
                if (response.ok) {
                    const result = await response.json();
                    const course = result.data.course;
                    const instance = result.data.instance;
                    
                    document.getElementById('courseTitle').textContent = course.title;
                    document.getElementById('courseDescription').textContent = 
                        `${instance.name} - ${course.description || 'Welcome to your course!'}`;
                    showElement('courseInfo');
                }
            } catch (error) {
                // Don't show error for course info loading failure
            }
        }

        // Handle login
        async function handleLogin() {
            const accessToken = document.getElementById('accessToken').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!accessToken || !password) {
                showError('Please enter both access token and password.');
                return;
            }
            
            showLoading();
            hideElement('errorMessage');
            hideElement('successMessage');
            
            try {
                const response = await fetch(`${CONFIG.BASE_URL}/student/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Store authentication data
                    localStorage.setItem('studentAuth', JSON.stringify({
                        accessToken: accessToken,
                        studentData: result.student,
                        loginTime: new Date().toISOString()
                    }));
                    
                    showSuccess('Login successful! Redirecting to your course...');
                    
                    // Check if password reset is required
                    if (result.student.password_reset_required) {
                        setTimeout(() => {
                            showPasswordResetForm();
                            hideElement('successMessage');
                        }, 2000);
                    } else {
                        // Redirect to student dashboard
                        setTimeout(() => {
                            window.location.href = `student-dashboard.html?token=${encodeURIComponent(accessToken)}`;
                        }, 2000);
                    }
                } else {
                    // Handle specific error messages for better user experience
                    const errorMessage = result.message || 'Login failed. Please check your credentials.';
                    
                    // Check for timing-related errors and provide better formatting
                    if (errorMessage.includes('Course has not started yet')) {
                        showError(errorMessage);
                        // Hide login form for early access attempts
                        hideElement('loginForm');
                    } else if (errorMessage.includes('Course has ended') || errorMessage.includes('access has been disabled')) {
                        showError(errorMessage);
                        // Hide login form for completed courses
                        hideElement('loginForm');
                    } else {
                        showError(errorMessage);
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Unable to connect to the server. Please try again later.');
            } finally {
                hideLoading();
            }
        }

        // Handle password reset
        async function handlePasswordReset() {
            const accessToken = document.getElementById('accessToken').value.trim();
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showError('Please fill in all password fields.');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('New passwords do not match.');
                return;
            }
            
            if (!validatePassword(newPassword)) {
                showError('Password does not meet security requirements.');
                return;
            }
            
            showLoading();
            hideElement('errorMessage');
            hideElement('successMessage');
            
            try {
                const response = await fetch(`${CONFIG.BASE_URL}/student/password/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess('Password updated successfully! Redirecting to your course...');
                    
                    // Update stored auth data
                    const authData = JSON.parse(localStorage.getItem('studentAuth') || '{}');
                    authData.passwordReset = true;
                    localStorage.setItem('studentAuth', JSON.stringify(authData));
                    
                    // Redirect to student dashboard
                    setTimeout(() => {
                        window.location.href = `student-dashboard.html?token=${encodeURIComponent(accessToken)}`;
                    }, 2000);
                } else {
                    showError(result.message || 'Password update failed.');
                }
            } catch (error) {
                console.error('Password reset error:', error);
                showError('Unable to connect to the server. Please try again later.');
            } finally {
                hideLoading();
            }
        }
    </script>
    </main>
    <script src="../js/focus-manager.js"></script>

    <script src="../js/inline-validation.js"></script>
</body>
</html>