<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Creator Platform - Interactive Demo</title>
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/accessibility.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .demo-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1400px;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .demo-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .demo-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .demo-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .progress-indicator {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .video-section {
            position: relative;
            background: #000;
            aspect-ratio: 16 / 9;
            overflow: hidden;
        }

        .video-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            z-index: 1;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .video-player.fading {
            opacity: 0;
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 32px;
            color: white;
            pointer-events: none;
        }

        .narration-box {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-left: 4px solid #667eea;
            padding: 16px 20px;
            border-radius: 8px;
            font-size: 1rem;
            line-height: 1.6;
            font-style: italic;
            max-width: 900px;
        }

        .narration-icon {
            color: #667eea;
            margin-right: 12px;
            font-size: 1.2rem;
        }

        .controls-section {
            padding: 24px 32px;
            background: #f5f7fa;
            border-top: 1px solid #e5e7eb;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .control-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .control-btn.primary:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .progress-bar-container {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.1s linear;
        }

        .time-display {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 600;
            min-width: 100px;
            text-align: right;
        }

        .slide-timeline {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 16px 0;
            scrollbar-width: thin;
        }

        .slide-thumbnail {
            flex-shrink: 0;
            width: 120px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slide-thumbnail:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .slide-thumbnail.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .slide-number {
            font-size: 0.75rem;
            color: #667eea;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .slide-title {
            font-size: 0.75rem;
            color: #1a202c;
            font-weight: 600;
            line-height: 1.3;
        }

        .slide-duration {
            font-size: 0.625rem;
            color: #9ca3af;
            margin-top: 4px;
        }

        .loading-state {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000;
            color: #6b7280;
            z-index: 10;
        }

        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
            background: #000;
            text-align: center;
            color: #dc2626;
            z-index: 10;
        }

        .error-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Footer Styles */
        .demo-footer {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #e2e8f0;
            padding: 40px 32px 24px;
            margin-top: auto;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 32px;
            max-width: 1200px;
            margin: 0 auto 32px;
        }

        .footer-section h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #fff;
        }

        .footer-section h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #cbd5e0;
        }

        .footer-section p {
            font-size: 0.875rem;
            color: #a0aec0;
            line-height: 1.5;
        }

        .footer-links {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-links li {
            margin-bottom: 8px;
        }

        .footer-links a {
            color: #a0aec0;
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .footer-links a:hover,
        .footer-links a:focus {
            color: #667eea;
            text-decoration: underline;
        }

        .social-links {
            display: flex;
            gap: 12px;
        }

        .social-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e2e8f0;
            text-decoration: none;
            transition: all 0.2s;
        }

        .social-link:hover,
        .social-link:focus {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 24px;
            text-align: center;
            font-size: 0.875rem;
            color: #718096;
        }

        .footer-bottom p {
            margin: 4px 0;
        }

        @media (max-width: 768px) {
            .demo-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .controls-row {
                flex-wrap: wrap;
            }

            .slide-timeline {
                padding-bottom: 8px;
            }

            .footer-content {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .footer-section:first-child {
                text-align: center;
            }

            .social-links {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Skip Links for Keyboard Navigation -->
    <div class="skip-links">
        <a href="#video-section" class="skip-link">Skip to video player</a>
        <a href="#slide-timeline" class="skip-link">Skip to slide navigation</a>
    </div>

    <!-- ARIA Live Region for Announcements -->
    <div id="demo-announcements" role="status" aria-live="polite" aria-atomic="true" class="sr-only"></div>

    <div class="demo-container" role="application" aria-label="Interactive demo player">
        <!-- Header -->
        <header class="demo-header" role="banner">
            <div>
                <div class="demo-title">
                    <i class="fas fa-play-circle"></i> Course Creator Platform
                </div>
                <div class="demo-subtitle">Interactive Demo - AI-Powered Course Creation</div>
            </div>
            <div class="progress-indicator" role="status" aria-label="Current progress">
                <i class="fas fa-film"></i> Slide <span id="current-slide">1</span> of <span id="total-slides">13</span>
            </div>
        </header>

        <!-- Video Section -->
        <main class="video-section" id="video-section" role="main" aria-label="Demo video player">
            <!-- Loading State -->
            <div class="loading-state" id="loading-state">
                <div class="spinner"></div>
                <p>Loading demo presentation...</p>
            </div>

            <!-- Video Player (using custom controls only) -->
            <video class="video-player" id="video-player" aria-label="Demo presentation video" aria-describedby="narration-text">
                <source id="video-source" src="" type="video/mp4">
                Your browser does not support video playback. Please use a modern browser with HTML5 video support.
            </video>

            <!-- Narration Overlay -->
            <div class="video-overlay" id="narration-overlay" style="display: none;">
                <div class="narration-box" role="complementary" aria-label="Video narration">
                    <i class="fas fa-microphone narration-icon" aria-hidden="true"></i>
                    <span id="narration-text"></span>
                </div>
            </div>

            <!-- Error State -->
            <div class="error-state" id="error-state" style="display: none;" role="alert">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                </div>
                <h3>Unable to load demo</h3>
                <p id="error-message"></p>
            </div>
        </main>

        <!-- Controls -->
        <nav class="controls-section" role="navigation" aria-label="Video playback controls">
            <!-- Playback Controls -->
            <div class="controls-row">
                <button class="control-btn" id="prev-btn" disabled aria-label="Go to previous slide" title="Previous slide (Arrow Left)">
                    <i class="fas fa-step-backward" aria-hidden="true"></i> Previous
                </button>
                <button class="control-btn primary" id="play-pause-btn" aria-label="Play video" title="Play/Pause (Spacebar)">
                    <i class="fas fa-play" aria-hidden="true"></i> Play
                </button>
                <button class="control-btn" id="next-btn" aria-label="Go to next slide" title="Next slide (Arrow Right)">
                    <i class="fas fa-step-forward" aria-hidden="true"></i> Next
                </button>
                <div class="progress-bar-container" id="progress-container" role="progressbar" aria-label="Video progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" tabindex="0" title="Click or use keyboard to seek">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="time-display" id="time-display" aria-live="off">0:00 / 0:00</div>
            </div>

            <!-- Slide Timeline -->
            <div class="slide-timeline" id="slide-timeline" role="list" aria-label="Slide navigation thumbnails">
                <!-- Populated dynamically -->
            </div>
        </nav>

        <!-- Footer -->
        <footer class="demo-footer" role="contentinfo">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Course Creator Platform</h3>
                    <p>AI-Powered Course Creation & Management</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="/html/index.html">Home</a></li>
                        <li><a href="/html/register.html">Sign Up</a></li>
                        <li><a href="/html/student-login.html">Login</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Resources</h4>
                    <ul class="footer-links">
                        <li><a href="#" aria-label="Documentation (opens in new window)">Documentation</a></li>
                        <li><a href="#" aria-label="Support (opens in new window)">Support</a></li>
                        <li><a href="#" aria-label="API Reference (opens in new window)">API</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Connect</h4>
                    <div class="social-links">
                        <a href="#" aria-label="GitHub" class="social-link"><i class="fab fa-github"></i></a>
                        <a href="#" aria-label="LinkedIn" class="social-link"><i class="fab fa-linkedin"></i></a>
                        <a href="#" aria-label="Twitter" class="social-link"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Course Creator Platform. All rights reserved.</p>
                <p>Built with AI • Designed for Education</p>
            </div>
        </footer>
    </div>

    <script src="../js/accessibility-manager.js"></script>
    <script>
        /**
         * Demo Player - Video Screencast Presentation System
         *
         * BUSINESS PURPOSE:
         * Interactive video player for showcasing Course Creator Platform features
         * to prospective customers, stakeholders, and investors.
         *
         * FEATURES:
         * - Video playback with synchronized AI narration
         * - Slide navigation and progress tracking
         * - Interactive timeline for quick access
         * - Responsive controls for all devices
         */

        class DemoPlayer {
            constructor() {
                this.slides = [];
                this.currentSlideIndex = 0;
                this.isPlaying = false;
                this.isSyncing = false;

                // DOM elements
                this.videoPlayer = document.getElementById('video-player');
                this.videoSource = document.getElementById('video-source');
                this.playPauseBtn = document.getElementById('play-pause-btn');
                this.prevBtn = document.getElementById('prev-btn');
                this.nextBtn = document.getElementById('next-btn');
                this.progressBar = document.getElementById('progress-bar');
                this.progressContainer = document.getElementById('progress-container');
                this.timeDisplay = document.getElementById('time-display');
                this.narrationText = document.getElementById('narration-text');
                this.narrationOverlay = document.getElementById('narration-overlay');
                this.slideTimeline = document.getElementById('slide-timeline');
                this.loadingState = document.getElementById('loading-state');
                this.errorState = document.getElementById('error-state');
                this.currentSlideDisplay = document.getElementById('current-slide');
                this.totalSlidesDisplay = document.getElementById('total-slides');

                // AI Voice Narration - Using ElevenLabs pre-generated audio (Charlotte - UK Female, mid-20s)
                // Settings: Stability 0.30, Style 0.90, Similarity 0.85, Speaker Boost enabled
                // Enthusiastic, cheerful, and upbeat delivery with high expressiveness
                this.voiceEnabled = true;  // Enabled with ElevenLabs audio files
                this.audioPlayer = null;  // HTML5 audio element for narration

                this.initialize();
            }

            async initialize() {
                try {
                    console.log('🎬 Initializing demo player...');

                    console.log('📄 Loading slides data...');
                    await this.loadSlides();
                    console.log(`✓ Loaded ${this.slides.length} slides`);

                    console.log('🎧 Setting up event listeners...');
                    this.setupEventListeners();

                    console.log('📊 Rendering timeline...');
                    this.renderTimeline();

                    console.log('🎥 Loading first slide...');
                    this.loadSlide(0);

                    // Hide loading screen after a short delay to allow video to load
                    setTimeout(() => {
                        this.hideLoading();
                        console.log('✅ Demo player initialized successfully');
                    }, 500);

                } catch (error) {
                    console.error('❌ Initialization failed:', error);
                    this.showError('Failed to load demo slides', error.message);
                }
            }

            stopNarration() {
                /**
                 * Stop current ElevenLabs audio narration
                 */
                if (this.audioPlayer) {
                    this.audioPlayer.pause();
                    this.audioPlayer.currentTime = 0;
                    this.audioPlayer = null;
                }
            }

            async loadSlides() {
                // Demo slide data - v3.0 with Third Party Integrations (2025-10-10)
                this.slides = [
                    {
                        id: 1,
                        title: "Organization Registration",
                        video: "/static/demo/videos/slide_01_org_registration.mp4",
                        duration: 77,
                        narration: "Welcome to Course Creator Platform! Let's start by registering your organization. Watch as we fill out the registration form with your organization name, administrator details, and contact information. In under a minute, you'll have a complete organizational structure ready to host unlimited courses and manage hundreds of users. This is effortless setup for corporate training teams."
                    },
                    {
                        id: 2,
                        title: "Organization Dashboard",
                        video: "/static/demo/videos/slide_02_org_admin.mp4",
                        duration: 45,
                        narration: "Every great learning program starts with a solid foundation. Watch as we create an organization. We'll enter the name, website, and a brief description. Then add contact details like the business email and address. Finally, set up the admin account with username, email, and password. In under a minute, you've created a complete organizational structure ready to host unlimited courses and manage hundreds of users. This is effortless setup."
                    },
                    {
                        id: 3,
                        title: "Projects & Tracks",
                        video: "/static/demo/videos/slide_03_projects_and_tracks.mp4",
                        duration: 30,
                        narration: "Now, let's talk about structure. Projects let you organize related courses, think Web Development Bootcamp or Data Science Foundations. Tracks? They're your secret weapon for personalization. Create customized learning paths for beginners, intermediates, or advanced students, all within the same program. One platform, infinite possibilities."
                    },
                    {
                        id: 4,
                        title: "Adding Instructors",
                        video: "/static/demo/videos/slide_04_adding_instructors.mp4",
                        duration: 30,
                        narration: "Your instructors are your greatest asset. Bring them onboard in seconds, assign them to specific projects or tracks. In the next step, we'll connect them to your Slack, Teams, and Zoom environments for seamless collaboration across the tools they already use."
                    },
                    {
                        id: 5,
                        title: "Third Party Integrations",
                        video: "/static/demo/videos/slide_05_third_party_integrations.mp4",
                        duration: 60,
                        narration: "Now here's where collaboration gets powerful. From the Meeting Rooms tab, organization admins can instantly connect the platform with the tools their teams already use. Create Microsoft Teams channels, Zoom rooms, or Slack channels for every instructor with a single click. Need meeting spaces for all your learning tracks? Bulk creation generates them in seconds. But it doesn't stop there. Send notifications to specific Slack channels about course updates, or broadcast announcements to your entire organization across Teams. Whether it's urgent maintenance alerts or celebrating student achievements, reach your team where they're already working. This integration means instructors collaborate on course development in Slack, launch live sessions via Zoom, and coordinate schedules in Teams, all without leaving their workflow. That's seamless collaboration."
                    },
                    {
                        id: 6,
                        title: "Instructor Dashboard",
                        video: "/static/demo/videos/slide_06_adding_course_content.mp4",
                        duration: 60,
                        narration: "Here's where the AI magic happens. Tell our system your learning objectives, your target audience, and your key topics. Then watch as artificial intelligence generates a complete course structure, suggested modules, learning outcomes, even quiz questions. You review, refine, and approve. What used to take days of curriculum design now takes minutes. And when you schedule live sessions? Automatic Zoom or Teams integration means one click launches your class."
                    },
                    {
                        id: 7,
                        title: "Course Content",
                        video: "/static/demo/videos/slide_07_enrolling_students.mp4",
                        duration: 45,
                        narration: "Here's where AI really shines. Need lesson content? Describe your topic and the AI generates a complete lesson draft, you just add your expertise and real-world examples. Creating quizzes? AI suggests questions based on your content, multiple choice, code challenges, scenario-based problems. You spend your time refining and personalizing, not starting from scratch. Upload presentations, embed videos, add code exercises with real-time feedback. The AI accelerates creation, you ensure quality."
                    },
                    {
                        id: 8,
                        title: "Enroll Employees",
                        video: "/static/demo/videos/slide_08_student_course_browsing.mp4",
                        duration: 45,
                        narration: "Your course is ready, now organizations enroll their employees. One employee? Easy. One hundred employees? Even easier. Upload a CSV file and enroll an entire cohort in seconds. Organize by department, group by skill level, track by training initiative. However you structure corporate training, we adapt. Because managing employee enrollment should be effortless, not exhausting."
                    },
                    {
                        id: 9,
                        title: "Student Dashboard",
                        video: "/static/demo/videos/slide_09_student_login_and_dashboard.mp4",
                        duration: 30,
                        narration: "Now let's see what your students experience. They log in and immediately, everything they need is right there. Their courses, their progress, upcoming deadlines, recent achievements. No confusion, no hunting for information. Just a clear path forward and the motivation to keep going."
                    },
                    {
                        id: 10,
                        title: "Course Browsing",
                        video: "/static/demo/videos/slide_10_taking_quiz.mp4",
                        duration: 75,
                        narration: "Here's where things get really exciting. Students browse the catalog, discover courses, and enroll with one click. But here's the game changer for technical training. When they hit a coding lesson? Professional development environments open right in their browser. VSCode for web development, PyCharm for Python, JupyterLab for data science, full Linux terminal for system administration. No installation, no configuration, no IT headaches. This is why corporate training teams choose us, their developers learn with real professional tools, no setup time wasted."
                    },
                    {
                        id: 11,
                        title: "Taking Quizzes",
                        video: "/static/demo/videos/slide_11_student_progress_analytics.mp4",
                        duration: 45,
                        narration: "Assessment shouldn't feel like a gotcha moment, it should be a learning opportunity. Our quiz system delivers multiple question formats, multiple choice for quick checks, coding challenges for hands-on validation, short answer for deeper understanding. But here's what matters most, instant feedback. Not just a score, but detailed explanations that turn mistakes into mastery. Because real learning happens when students understand why."
                    },
                    {
                        id: 12,
                        title: "Student Progress",
                        video: "/static/demo/videos/slide_12_instructor_analytics.mp4",
                        duration: 30,
                        narration: "Progress should be visible and celebrated. Every quiz completed, every module mastered, every achievement unlocked. Students see their journey unfold in real time. Completion rates, quiz scores, time invested, it all adds up to something powerful, proof of growth. And that's what keeps them coming back."
                    },
                    {
                        id: 13,
                        title: "Instructor Analytics",
                        video: "/static/demo/videos/slide_13_summary_and_cta.mp4",
                        duration: 45,
                        narration: "Here's where we go beyond basic LMS reporting. Our AI-powered analytics don't just show you data, they surface insights. Which students are at risk of falling behind? AI flags them automatically. What content drives the most engagement? AI identifies patterns across all your courses. Which quiz questions are too easy or too hard? AI analyzes performance trends and suggests adjustments. Export reports to Slack or Teams so your entire training team stays informed. This isn't just analytics, it's intelligent course optimization."
                    }
                ];

                this.totalSlidesDisplay.textContent = this.slides.length;
            }

            setupEventListeners() {
                // Playback controls
                this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.prevBtn.addEventListener('click', () => this.previousSlide());
                this.nextBtn.addEventListener('click', () => this.nextSlide());

                // Video events
                this.videoPlayer.addEventListener('loadedmetadata', () => {
                    console.log(`✓ Video metadata loaded - Duration: ${this.videoPlayer.duration}s, Dimensions: ${this.videoPlayer.videoWidth}x${this.videoPlayer.videoHeight}`);
                });

                this.videoPlayer.addEventListener('loadeddata', () => {
                    console.log(`✓ Video data loaded - Ready state: ${this.videoPlayer.readyState}`);
                });

                this.videoPlayer.addEventListener('canplay', () => {
                    console.log(`✓ Video can play - Current time: ${this.videoPlayer.currentTime}s`);
                });

                this.videoPlayer.addEventListener('timeupdate', () => this.updateProgress());
                this.videoPlayer.addEventListener('ended', () => this.onVideoEnded());
                this.videoPlayer.addEventListener('play', () => this.onPlay());
                this.videoPlayer.addEventListener('pause', () => this.onPause());
                this.videoPlayer.addEventListener('seeking', () => this.onSeeking());
                this.videoPlayer.addEventListener('seeked', () => this.onSeeked());
                this.videoPlayer.addEventListener('error', (e) => {
                    console.error('❌ Video playback error:', e);
                    const error = this.videoPlayer.error;
                    if (error) {
                        console.error(`Error code: ${error.code}, message: ${error.message}`);
                        this.showError('Video Error', `Failed to load video: ${error.message || 'Unknown error'}`);
                    }
                });

                // Progress bar seeking
                this.progressContainer.addEventListener('click', (e) => this.seek(e));

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
            }

            renderTimeline() {
                this.slideTimeline.innerHTML = '';

                this.slides.forEach((slide, index) => {
                    const thumbnail = document.createElement('button');
                    thumbnail.className = 'slide-thumbnail';
                    thumbnail.setAttribute('role', 'listitem');
                    thumbnail.setAttribute('aria-label', `Slide ${slide.id}: ${slide.title}, ${slide.duration} seconds`);
                    if (index === 0) {
                        thumbnail.classList.add('active');
                        thumbnail.setAttribute('aria-current', 'true');
                    }

                    thumbnail.innerHTML = `
                        <div class="slide-number">SLIDE ${slide.id}</div>
                        <div class="slide-title">${slide.title}</div>
                        <div class="slide-duration"><i class="fas fa-clock" aria-hidden="true"></i> ${slide.duration}s</div>
                    `;

                    thumbnail.addEventListener('click', () => this.loadSlide(index));
                    this.slideTimeline.appendChild(thumbnail);
                });
            }

            loadSlide(index) {
                if (index < 0 || index >= this.slides.length) return;

                const slide = this.slides[index];
                const wasPlaying = this.isPlaying;
                this.currentSlideIndex = index;

                console.log(`📹 Loading slide ${slide.id}: ${slide.title}`);

                // Stop any ongoing narration from previous slide
                this.stopNarration();

                // Add fade-out effect
                this.videoPlayer.classList.add('fading');

                // IMPORTANT: Pause video first and wait for pause to complete
                // This prevents "play() interrupted by pause()" errors
                const loadVideo = () => {
                    // Remove any existing source elements (they take precedence over video src)
                    while (this.videoPlayer.firstChild) {
                        this.videoPlayer.removeChild(this.videoPlayer.firstChild);
                    }

                    // Update video source DIRECTLY on video element
                    console.log(`Video source: ${slide.video}`);
                    this.videoPlayer.src = slide.video;
                    this.videoPlayer.load();

                    console.log(`Video element loaded, waiting for metadata...`);

                    // Fade back in after video loads
                    this.videoPlayer.addEventListener('canplay', () => {
                        this.videoPlayer.classList.remove('fading');
                    }, { once: true });
                };

                // If video is playing, pause it first then load new video
                if (!this.videoPlayer.paused) {
                    console.log('Pausing current video before loading new one...');
                    this.videoPlayer.pause();
                    // Wait for fade out (500ms) + pause to process
                    setTimeout(loadVideo, 600);
                } else {
                    // Video already paused, wait for fade out then load
                    setTimeout(loadVideo, 500);
                }

                // Update narration text
                this.narrationText.textContent = slide.narration;

                // Load ElevenLabs audio narration for this slide
                const slideNum = String(slide.id).padStart(2, '0');
                const audioPath = `/static/demo/audio/slide_${slideNum}_narration.mp3`;

                console.log(`Audio path: ${audioPath}`);

                // Create new audio player
                this.audioPlayer = new Audio(audioPath);
                this.audioPlayer.volume = 0.8;
                this.audioPlayer.preload = 'auto';

                // Add event listeners for audio
                this.audioPlayer.addEventListener('loadeddata', () => {
                    console.log(`✓ Audio loaded for slide ${slide.id}`);
                });

                this.audioPlayer.addEventListener('error', (e) => {
                    console.error(`✗ Audio failed to load for slide ${slide.id}: ${audioPath}`, e);
                });

                // Force load the audio
                this.audioPlayer.load();

                // Update UI
                this.currentSlideDisplay.textContent = slide.id;
                this.updateNavigationButtons();
                this.updateActiveSlide();

                // Auto-play if video was playing before slide change
                if (wasPlaying && index > 0) {
                    console.log('Auto-playing next slide...');
                    // Wait for video to be ready before auto-playing
                    const autoPlayHandler = () => {
                        this.videoPlayer.removeEventListener('loadeddata', autoPlayHandler);
                        console.log('Video ready, starting auto-play...');
                        this.videoPlayer.play().catch(err => {
                            console.error('Auto-play failed:', err);
                        });
                    };
                    this.videoPlayer.addEventListener('loadeddata', autoPlayHandler);
                }

                this.announce(`Now showing: ${slide.title}`);
                console.log(`✅ Slide ${slide.id} loaded successfully`);
            }

            updateActiveSlide() {
                const thumbnails = this.slideTimeline.querySelectorAll('.slide-thumbnail');
                thumbnails.forEach((thumb, index) => {
                    const isActive = index === this.currentSlideIndex;
                    thumb.classList.toggle('active', isActive);
                    thumb.setAttribute('aria-current', isActive ? 'true' : 'false');
                });
            }

            /**
             * Announce message to screen readers
             * @param {string} message - Message to announce
             */
            announce(message) {
                const announcer = document.getElementById('demo-announcements');
                if (announcer) {
                    announcer.textContent = '';
                    setTimeout(() => {
                        announcer.textContent = message;
                    }, 100);
                }
            }

            togglePlayPause() {
                if (this.videoPlayer.paused) {
                    this.videoPlayer.play();
                } else {
                    this.videoPlayer.pause();
                }
            }

            onPlay() {
                this.isPlaying = true;
                this.playPauseBtn.innerHTML = '<i class="fas fa-pause" aria-hidden="true"></i> Pause';
                this.playPauseBtn.setAttribute('aria-label', 'Pause video');
                this.narrationOverlay.style.display = 'block';
                this.announce('Video playing');

                // Start ElevenLabs AI voice narration synchronized with video
                console.log(`onPlay() called for slide ${this.currentSlideIndex + 1}`);
                console.log(`Video time: ${this.videoPlayer.currentTime.toFixed(2)}s`);

                if (this.audioPlayer && !this.audioPlayer.paused) {
                    // Audio already playing, don't start again
                    console.log('Audio already playing, skipping restart');
                    return;
                }

                if (this.audioPlayer) {
                    // Sync audio to video position
                    this.audioPlayer.currentTime = this.videoPlayer.currentTime;
                    console.log(`Syncing audio to video position: ${this.audioPlayer.currentTime.toFixed(2)}s`);

                    this.audioPlayer.play()
                        .then(() => {
                            console.log(`✓ Audio playing in sync with video`);
                        })
                        .catch(err => {
                            console.error(`✗ Audio playback failed:`, err);
                        });
                } else {
                    console.warn(`No audioPlayer available for slide ${this.currentSlideIndex + 1}`);
                }
            }

            onPause() {
                this.isPlaying = false;
                this.playPauseBtn.innerHTML = '<i class="fas fa-play" aria-hidden="true"></i> Play';
                this.playPauseBtn.setAttribute('aria-label', 'Play video');
                this.announce('Video paused');

                // Pause ElevenLabs audio narration
                if (this.audioPlayer && !this.audioPlayer.paused) {
                    this.audioPlayer.pause();
                }
            }

            onSeeking() {
                // Pause audio while seeking to prevent audio/video desync
                if (this.audioPlayer && !this.audioPlayer.paused) {
                    this.audioPlayer.pause();
                    console.log('Audio paused during seeking');
                }
            }

            onSeeked() {
                // Sync audio to new video position after seeking
                if (this.audioPlayer) {
                    this.audioPlayer.currentTime = this.videoPlayer.currentTime;
                    console.log(`Audio synced to new position: ${this.audioPlayer.currentTime.toFixed(2)}s`);

                    // Resume audio if video is playing
                    if (!this.videoPlayer.paused) {
                        this.audioPlayer.play()
                            .then(() => console.log('Audio resumed after seeking'))
                            .catch(err => console.error('Failed to resume audio after seeking:', err));
                    }
                }
            }

            previousSlide() {
                if (this.currentSlideIndex > 0) {
                    this.loadSlide(this.currentSlideIndex - 1);
                }
            }

            nextSlide() {
                if (this.currentSlideIndex < this.slides.length - 1) {
                    this.loadSlide(this.currentSlideIndex + 1);
                }
            }

            onVideoEnded() {
                // Stop audio narration when video ends
                if (this.audioPlayer && !this.audioPlayer.paused) {
                    this.audioPlayer.pause();
                    this.audioPlayer.currentTime = 0;
                }

                // Auto-advance to next slide
                if (this.currentSlideIndex < this.slides.length - 1) {
                    setTimeout(() => {
                        this.nextSlide();
                        this.videoPlayer.play();
                    }, 1000);
                } else {
                    // Demo complete
                    this.playPauseBtn.innerHTML = '<i class="fas fa-redo"></i> Replay';
                }
            }

            updateProgress() {
                const progress = (this.videoPlayer.currentTime / this.videoPlayer.duration) * 100;
                this.progressBar.style.width = `${progress}%`;

                // Update progress bar ARIA attributes
                this.progressContainer.setAttribute('aria-valuenow', Math.round(progress));

                // Update time display
                const current = this.formatTime(this.videoPlayer.currentTime);
                const total = this.formatTime(this.videoPlayer.duration);
                this.timeDisplay.textContent = `${current} / ${total}`;

                // DO NOT auto-sync during playback - causes stuttering and repeats
                // Audio and video will naturally stay in sync if started together
                // Only sync on user actions (play/pause/seek)
            }

            seek(e) {
                const rect = this.progressContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                const newTime = pos * this.videoPlayer.duration;

                // Seek both video and audio to the same position
                this.videoPlayer.currentTime = newTime;

                if (this.audioPlayer) {
                    this.audioPlayer.currentTime = newTime;
                    console.log(`Seeked to ${newTime.toFixed(2)}s - video and audio synchronized`);
                }
            }

            updateNavigationButtons() {
                this.prevBtn.disabled = this.currentSlideIndex === 0;
                this.nextBtn.disabled = this.currentSlideIndex === this.slides.length - 1;
            }

            handleKeyboard(e) {
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        this.togglePlayPause();
                        break;
                    case 'ArrowLeft':
                        this.previousSlide();
                        break;
                    case 'ArrowRight':
                        this.nextSlide();
                        break;
                }
            }

            formatTime(seconds) {
                if (isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            hideLoading() {
                console.log('👁️ Hiding loading screen, showing video player');
                this.loadingState.style.display = 'none';
                console.log(`Loading state display: ${this.loadingState.style.display}`);
                console.log(`Video player visible: ${this.videoPlayer.offsetWidth > 0 && this.videoPlayer.offsetHeight > 0}`);
            }

            showError(title, message) {
                this.loadingState.style.display = 'none';
                this.errorState.style.display = 'block';
                document.getElementById('error-message').textContent = message;
                console.error(`${title}: ${message}`);
            }
        }

        // Initialize demo player when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const player = new DemoPlayer();
        });
    </script>

    <!-- AI Tour Guide Component -->
    <style>
        /* AI Tour Guide Styles */
        .ai-tour-guide-trigger {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-tour-guide-trigger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(99, 102, 241, 0.6);
        }

        .ai-tour-guide-trigger .ai-icon {
            font-size: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .ai-guide-pulse {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        .ai-tour-guide-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 450px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: -4px 0 40px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .ai-tour-guide-panel.open {
            transform: translateX(0);
        }

        .ai-guide-header {
            padding: 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .ai-guide-avatar {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .ai-guide-info h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .ai-guide-status {
            font-size: 13px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .ai-guide-close {
            margin-left: auto;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .ai-guide-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .ai-guide-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #f9fafb;
        }

        .ai-guide-message {
            display: flex;
            gap: 12px;
            max-width: 85%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-guide-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: #6366f1;
            color: white;
        }

        .ai .message-avatar {
            background: #e5e7eb;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .user .message-content {
            background: #6366f1;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai .message-content {
            background: white;
            color: #1f2937;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message-content p {
            margin: 0 0 8px 0;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul, .message-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 4px 0;
        }

        .message-content strong {
            font-weight: 600;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .ai-guide-suggestions {
            padding: 16px 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-chip {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            color: #4b5563;
        }

        .suggestion-chip:hover {
            background: #e5e7eb;
            border-color: #6366f1;
            color: #6366f1;
        }

        .ai-guide-input-container {
            padding: 20px 24px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
            display: flex;
            gap: 12px;
        }

        .ai-guide-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .ai-guide-input:focus {
            border-color: #6366f1;
        }

        .ai-guide-send {
            background: #6366f1;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-guide-send:hover {
            background: #4f46e5;
            transform: scale(1.05);
        }

        .ai-guide-send:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .ai-tour-guide-panel {
                width: 100%;
                height: 80vh;
                bottom: 0;
                top: auto;
                border-radius: 20px 20px 0 0;
                transform: translateY(100%);
            }

            .ai-tour-guide-panel.open {
                transform: translateY(0);
            }

            .ai-tour-guide-trigger {
                bottom: 10px;
                right: 10px;
                padding: 12px 20px;
                font-size: 14px;
            }

            .ai-guide-messages {
                padding: 16px;
            }

            .ai-guide-suggestions {
                padding: 12px 16px;
            }

            .ai-guide-input-container {
                padding: 16px;
            }
        }
    </style>

    <!-- AI Tour Guide HTML -->
    <button class="ai-tour-guide-trigger" id="ai-tour-guide-trigger" aria-label="Open AI Tour Guide">
        <span class="ai-icon">🤖</span>
        <span>Ask AI Guide</span>
        <span class="ai-guide-pulse"></span>
    </button>

    <div class="ai-tour-guide-panel" id="ai-tour-guide-panel" role="dialog" aria-label="AI Tour Guide Chat">
        <div class="ai-guide-header">
            <div class="ai-guide-avatar">🤖</div>
            <div class="ai-guide-info">
                <h3>AI Tour Guide</h3>
                <div class="ai-guide-status">
                    <span class="status-dot"></span>
                    <span>Online • Instant responses</span>
                </div>
            </div>
            <button class="ai-guide-close" id="ai-guide-close" aria-label="Close AI Tour Guide">×</button>
        </div>

        <div class="ai-guide-messages" id="ai-guide-messages" role="log" aria-live="polite">
            <!-- Messages will be inserted here -->
        </div>

        <div class="ai-guide-suggestions" id="ai-guide-suggestions">
            <button class="suggestion-chip" data-question="Who is this platform for?">Who is this for?</button>
            <button class="suggestion-chip" data-question="How does the AI help with course creation?">How does AI help?</button>
            <button class="suggestion-chip" data-question="What integrations do you support?">What integrations?</button>
            <button class="suggestion-chip" data-question="How much does this cost?">Pricing?</button>
            <button class="suggestion-chip" data-question="How do I get started?">Get Started</button>
        </div>

        <div class="ai-guide-input-container">
            <input
                type="text"
                class="ai-guide-input"
                id="ai-guide-input"
                placeholder="Ask anything about the platform..."
                aria-label="Type your question">
            <button class="ai-guide-send" id="ai-guide-send" aria-label="Send message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
    // AI Tour Guide JavaScript
    class AITourGuide {
        constructor() {
            this.panel = document.getElementById('ai-tour-guide-panel');
            this.trigger = document.getElementById('ai-tour-guide-trigger');
            this.closeBtn = document.getElementById('ai-guide-close');
            this.messages = document.getElementById('ai-guide-messages');
            this.input = document.getElementById('ai-guide-input');
            this.sendBtn = document.getElementById('ai-guide-send');
            this.suggestions = document.getElementById('ai-guide-suggestions');

            this.isOpen = false;
            this.conversationHistory = [];

            this.init();
        }

        init() {
            // Event listeners
            this.trigger.addEventListener('click', () => this.openPanel());
            this.closeBtn.addEventListener('click', () => this.closePanel());
            this.sendBtn.addEventListener('click', () => this.sendMessage());
            this.input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.sendMessage();
            });

            // Suggestion chips
            this.suggestions.querySelectorAll('.suggestion-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const question = chip.dataset.question;
                    this.input.value = question;
                    this.sendMessage();
                });
            });

            // Send welcome message when opened
            this.panel.addEventListener('transitionend', (e) => {
                if (e.propertyName === 'transform' && this.isOpen && this.messages.children.length === 0) {
                    this.sendWelcomeMessage();
                }
            });
        }

        openPanel() {
            this.isOpen = true;
            this.panel.classList.add('open');
            this.input.focus();
        }

        closePanel() {
            this.isOpen = false;
            this.panel.classList.remove('open');
        }

        sendWelcomeMessage() {
            const welcomeText = `👋 Hi! I'm your AI tour guide. I can answer questions about:

• Who this platform is for
• Key features and capabilities
• AI-powered course development
• Integrations (Zoom, Teams, Slack)
• Getting started

What would you like to know?`;

            this.addMessage('ai', welcomeText);
        }

        async sendMessage() {
            const userMessage = this.input.value.trim();
            if (!userMessage) return;

            // Clear input and disable while processing
            this.input.value = '';
            this.input.disabled = true;
            this.sendBtn.disabled = true;

            // Add user message
            this.addMessage('user', userMessage);

            // Show typing indicator
            this.showTypingIndicator();

            try {
                // Call RAG service
                const response = await this.queryRAG(userMessage);

                // Remove typing indicator
                this.hideTypingIndicator();

                // Add AI response
                this.addMessage('ai', response);

                // Store in conversation history
                this.conversationHistory.push({
                    user: userMessage,
                    ai: response
                });

            } catch (error) {
                console.error('AI Tour Guide error:', error);
                this.hideTypingIndicator();
                this.addMessage('ai', "I'm having trouble connecting right now. Please try asking your question again, or feel free to explore the demo and ask me later!");
            } finally {
                // Re-enable input
                this.input.disabled = false;
                this.sendBtn.disabled = false;
                this.input.focus();
            }
        }

        cleanRAGResponse(enhancedContext) {
            // Extract just the relevant content from RAG enhanced_context
            // Remove technical formatting like "--- Context N (Source: ...) ---"

            // Split by context sections
            const sections = enhancedContext.split(/---\s*Context\s+\d+\s*\(Source:.*?\)\s*---/);

            // Get the actual content (skip the intro line and semantic analysis)
            let relevantContent = [];

            for (let section of sections) {
                // Skip the intro and semantic analysis sections
                if (section.includes('Relevant educational context for:') ||
                    section.includes('--- Semantic Analysis ---')) {
                    continue;
                }

                // Clean up the section
                let cleaned = section.trim();

                // Remove "###" markers
                cleaned = cleaned.replace(/^#\s*$/gm, '');

                // Remove empty lines
                cleaned = cleaned.split('\n').filter(line => line.trim()).join('\n');

                if (cleaned) {
                    relevantContent.push(cleaned);
                }
            }

            // Join the relevant content
            let answer = relevantContent.join('\n\n');

            // If we got good content, return it; otherwise return a friendly message
            if (answer.trim().length > 20) {
                return answer.trim();
            }

            return "I found some information about that, but I'm having trouble formatting it clearly. Could you try rephrasing your question?";
        }

        async queryRAG(question) {
            const response = await fetch('https://localhost:8009/api/v1/rag/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: question,
                    domain: 'demo_tour_guide'
                })
            });

            if (!response.ok) {
                throw new Error(`RAG service error: ${response.status}`);
            }

            const data = await response.json();
            let rawAnswer = data.answer || data.response || data.enhanced_context || "I'm not sure how to answer that. Could you rephrase your question?";

            // Clean up RAG enhanced_context format for better user experience
            if (data.enhanced_context) {
                rawAnswer = this.cleanRAGResponse(data.enhanced_context);
            }

            return rawAnswer;
        }

        addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-guide-message ${type}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = type === 'ai' ? '🤖' : '👤';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = this.formatMessage(content);

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);

            this.messages.appendChild(messageDiv);
            this.scrollToBottom();
        }

        formatMessage(content) {
            // Simple markdown-like formatting
            let formatted = content;

            // Convert **bold** to <strong>
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Convert bullet points
            formatted = formatted.replace(/^• (.+)$/gm, '<li>$1</li>');

            // Wrap lists
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

            // Convert line breaks to paragraphs
            const paragraphs = formatted.split('\n\n');
            formatted = paragraphs.map(p => {
                if (p.trim() && !p.startsWith('<')) {
                    return `<p>${p.trim()}</p>`;
                }
                return p;
            }).join('');

            return formatted;
        }

        showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-guide-message ai typing-indicator-container';
            typingDiv.id = 'typing-indicator';

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.textContent = '🤖';

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';

            typingDiv.appendChild(avatarDiv);
            typingDiv.appendChild(typingIndicator);

            this.messages.appendChild(typingDiv);
            this.scrollToBottom();
        }

        hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        scrollToBottom() {
            this.messages.scrollTop = this.messages.scrollHeight;
        }
    }

    // Initialize AI Tour Guide when page loads
    document.addEventListener('DOMContentLoaded', () => {
        window.aiTourGuide = new AITourGuide();
    });
    </script>

</body>
</html>
